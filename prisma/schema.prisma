// This file is auto-generated. Do not edit manually.
// Edit files in prisma/schemas/ directory instead.
// Last generated: 2025-08-02T17:09:54.427Z

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


// ==========================================
// AUTH
// ==========================================

// prisma/schemas/auth.prisma
// Authentication and User Management Schema
// ระบบจัดการผู้ใช้และการยืนยันตัวตนสำหรับ Hospital Pharmacy System

enum Role {
  HOSPITAL_ADMIN      // ผู้ดูแลระบบโรงพยาบาล - สิทธิ์เต็ม
  PHARMACY_MANAGER    // ผู้จัดการเภสัชกรรม - จัดการสต็อกและอนุมัติ
  SENIOR_PHARMACIST   // เภสัชกรอาวุโส - จัดการสต็อกและจ่ายยา
  STAFF_PHARMACIST    // เภสัชกรประจำ - จ่ายยาและรับสต็อก
  DEPARTMENT_HEAD     // หัวหน้าแผนก - เบิกยาและจัดการงบประมาณ
  STAFF_NURSE         // พยาบาลประจำ - เบิกยาพื้นฐาน
  PHARMACY_TECHNICIAN // เทคนิคเภสัชกรรม - รับสต็อกและจัดระเบียบ
}

enum UserStatus {
  PENDING   // รอการอนุมัติ
  ACTIVE    // ใช้งานได้
  INACTIVE  // ปิดการใช้งานชั่วคราว
  SUSPENDED // ระงับการใช้งาน
  DELETED   // ลบแล้ว (soft delete)
}

model User {
  id            String      @id @default(uuid())
  
  // ข้อมูลพื้นฐาน
  email         String      @unique
  name          String
  phoneNumber   String?
  employeeId    String?     // รหัสพนักงาน
  
  // การยืนยันตัวตน
  emailVerified Boolean     @default(false)
  password      String?     // hashed password
  
  // บทบาทและสิทธิ์
  role          Role
  status        UserStatus  @default(PENDING)
  
  // ความสัมพันธ์กับโรงพยาบาล
  hospitalId    String
  hospital      Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ความสัมพันธ์กับแผนก (optional สำหรับ pharmacy staff)
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  // การติดตามการเข้าสู่ระบบ
  lastLoginAt   DateTime?
  lastLoginIP   String?
  loginCount    Int         @default(0)
  
  // Audit fields
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdBy     String?     // ผู้สร้างบัญชี
  lastModifiedBy String?    // ผู้แก้ไขล่าสุด
  
  // ================================
  // RELATIONS (All opposite fields)
  // ================================
  
  // Authentication Relations
  sessions                  Session[]
  refreshTokens            RefreshToken[]
  passwordResetTokens      PasswordResetToken[]
  emailVerificationTokens  EmailVerificationToken[]
  loginAttempts            LoginAttempt[]
  
  // Department & Warehouse Management
  departmentsManaged       Department[]     @relation("DepartmentHead")
  warehousesManaged        Warehouse[]      @relation("WarehouseManager")
  
  // Stock Management
  stockTransactions        StockTransaction[]
  stockCountsAsCounter     StockCount[]     @relation("StockCounter")
  stockCountsAsVerifier    StockCount[]     @relation("StockCountVerifier")
  
  // Requisition System
  requisitionsCreated      Requisition[]    @relation("RequesterRelation")
  requisitionsApproved     Requisition[]    @relation("ApproverRelation")
  requisitionsFulfilled    Requisition[]    @relation("FulfillerRelation")
  workflowActions          RequisitionWorkflow[]
  requisitionAttachments   RequisitionAttachment[]
  requisitionTemplatesCreated RequisitionTemplate[]
  
  // Supplier Management
  purchaseOrdersCreated    PurchaseOrder[]  @relation("POOrderer")
  purchaseOrdersApproved   PurchaseOrder[]  @relation("POApprover")
  goodsReceiptsReceived    GoodsReceipt[]   @relation("GRReceiver")
  goodsReceiptsVerified    GoodsReceipt[]   @relation("GRVerifier")
  supplierEvaluations      SupplierEvaluation[]
  
  // Analytics & Reporting
  reportsRequested         Report[]
  dashboards               Dashboard[]
  systemUsageLogs          SystemUsage[]
  
  // Audit & Compliance
  auditLogs                AuditLog[]
  dataAccessLogs           DataAccessLog[]
  complianceChecksPerformed ComplianceCheck[] @relation("ComplianceChecker")
  complianceChecksReviewed ComplianceCheck[] @relation("ComplianceReviewer")
  controlledSubstanceLogsHandled ControlledSubstanceLog[] @relation("CSLHandler")
  controlledSubstanceLogsWitnessed ControlledSubstanceLog[] @relation("CSLWitness")
  controlledSubstanceLogsAuthorized ControlledSubstanceLog[] @relation("CSLAuthorizer")
  internalAudits           InternalAudit[]
  securityIncidentsReported SecurityIncident[] @relation("SecurityReporter")
  securityIncidentsSuspected SecurityIncident[] @relation("SuspectedUser")
  securityIncidentsInvestigated SecurityIncident[] @relation("Investigator")
  
  // Notifications
  notificationPreferences  NotificationPreference[]
  notifications            NotificationUser[]
  
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  
  // ความสัมพันธ์กับผู้ใช้
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ข้อมูลเซสชั่น
  token     String   @unique
  expiresAt DateTime
  
  // ข้อมูลการเชื่อมต่อ
  ipAddress String?
  userAgent String?
  deviceInfo String? // JSON string สำหรับข้อมูลอุปกรณ์
  
  // การติดตาม
  createdAt DateTime @default(now())
  lastUsedAt DateTime @default(now())
  isActive  Boolean  @default(true)
  
  @@map("sessions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  
  // ความสัมพันธ์กับผู้ใช้
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ข้อมูล token
  token     String   @unique
  expiresAt DateTime
  
  // การติดตาม
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false)
  revokedAt DateTime?
  
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  
  // ความสัมพันธ์กับผู้ใช้
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ข้อมูล token
  token     String   @unique
  expiresAt DateTime
  
  // การใช้งาน
  isUsed    Boolean  @default(false)
  usedAt    DateTime?
  
  // การติดตาม
  createdAt DateTime @default(now())
  
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  
  // ความสัมพันธ์กับผู้ใช้
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ข้อมูล token
  token     String   @unique
  expiresAt DateTime
  
  // การใช้งาน
  isVerified Boolean @default(false)
  verifiedAt DateTime?
  
  // การติดตาม
  createdAt DateTime @default(now())
  
  @@map("email_verification_tokens")
}

// การติดตามการเข้าสู่ระบบ
model LoginAttempt {
  id        String   @id @default(uuid())
  
  // ข้อมูลการเข้าสู่ระบบ
  email     String
  ipAddress String
  userAgent String?
  
  // ผลลัพธ์
  isSuccessful Boolean
  failureReason String? // "invalid_credentials", "account_locked", "email_not_verified"
  
  // ข้อมูลผู้ใช้ (ถ้าสำเร็จ)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // การติดตาม
  attemptedAt DateTime @default(now())
  
  @@index([email])
  @@index([ipAddress])
  @@index([attemptedAt])
  @@map("login_attempts")
}

// ==========================================
// HOSPITAL CORE
// ==========================================

// prisma/schemas/hospital-core.prisma
// Hospital Core Management Schema
// ระบบจัดการข้อมูลหลักของโรงพยาบาล แผนก และคลังยา

enum HospitalType {
  GENERAL         // โรงพยาบาลทั่วไป
  SPECIALTY       // โรงพยาบาลเฉพาะทาง
  UNIVERSITY      // โรงพยาบาลมหาวิทยาลัย
  PRIVATE         // โรงพยาบาลเอกชน
  COMMUNITY       // โรงพยาบาลชุมชน
  DISTRICT        // โรงพยาบาลระดับอำเภอ
}

enum HospitalStatus {
  ACTIVE      // ใช้งานปกติ
  INACTIVE    // ปิดชั่วคราว
  SUSPENDED   // ระงับการใช้งาน
  PENDING     // รอการอนุมัติ
}

model Hospital {
  id          String        @id @default(uuid())
  
  // ข้อมูลพื้นฐาน
  name        String
  nameEn      String?       // ชื่อภาษาอังกฤษ
  shortName   String?       // ชื่อย่อ
  code        String        @unique // รหัสโรงพยาบาล
  description String?
  
  // ประเภทและสถานะ
  type        HospitalType
  status      HospitalStatus @default(PENDING)
  
  // ข้อมูลใบอนุญาต
  licenseNumber String?     // เลขใบอนุญาต
  licenseExpiry DateTime?   // วันหมดอายุใบอนุญาต
  accreditation String?     // การรับรอง
  
  // ที่อยู่และการติดต่อ
  address     Json          // ที่อยู่ครบถ้วน
  phoneNumber String?
  faxNumber   String?
  email       String?
  website     String?
  
  // การตั้งค่าระบบ
  timezone    String        @default("Asia/Bangkok")
  locale      String        @default("th")
  currency    String        @default("THB")
  
  // การสมัครสมาชิก
  subscription Json?        // ข้อมูลการสมัครสมาชิก
  planType    String?       // ประเภทแผน: "BASIC", "STANDARD", "PREMIUM"
  planStartDate DateTime?
  planEndDate   DateTime?
  maxUsers      Int?        // จำนวนผู้ใช้สูงสุด
  maxDepartments Int?       // จำนวนแผนกสูงสุด
  
  // การเงิน
  billingAddress Json?      // ที่อยู่สำหรับเรียกเก็บเงิน
  taxId         String?     // เลขประจำตัวผู้เสียภาษี
  
  // Audit fields
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String?
  isActive    Boolean       @default(true)
  
  // Relations - เพิ่ม inverse relations ทั้งหมด
  users       User[]
  departments Department[]
  warehouses  Warehouse[]
  drugs       Drug[]
  stockCards  StockCard[]
  suppliers   Supplier[]
  requisitions Requisition[]
  requisitionTemplates RequisitionTemplate[]
  purchaseOrders PurchaseOrder[]
  goodsReceipts GoodsReceipt[]
  auditLogs   AuditLog[]
  notifications Notification[]
  reports     Report[]
  dashboards  Dashboard[]
  kpiMetrics  KPIMetric[]
  systemUsage SystemUsage[]
  mlDataPoints MLDataPoint[]
  forecasts   Forecast[]
  trendAnalyses TrendAnalysis[]
  benchmarks  Benchmark[]
  dataAccessLogs DataAccessLog[]
  complianceChecks ComplianceCheck[]
  controlledSubstanceLogs ControlledSubstanceLog[]
  internalAudits InternalAudit[]
  securityIncidents SecurityIncident[]
  notificationTemplates NotificationTemplate[]
  alertRules  AlertRule[]
  alertLogs   AlertLog[]
  notificationChannels NotificationChannel[]
  
  @@map("hospitals")
}

enum DepartmentType {
  CLINICAL        // แผนกคลินิก - Internal Medicine, Surgery, Pediatrics
  SUPPORT         // แผนกสนับสนุน - Laboratory, Radiology, Pharmacy
  CRITICAL_CARE   // แผนกวิกฤต - ICU, CCU, ER
  OUTPATIENT      // แผนกผู้ป่วยนอก - OPD clinics, Specialty clinics
  ADMINISTRATIVE  // แผนกบริหาร - HR, Finance, IT
}

enum DepartmentStatus {
  ACTIVE      // ใช้งานปกติ
  INACTIVE    // ปิดชั่วคราว
  PLANNED     // อยู่ระหว่างการวางแผน
  CLOSED      // ปิดถาวร
}

model Department {
  id             String          @id @default(uuid())
  
  // ความสัมพันธ์กับโรงพยาบาล
  hospitalId     String
  hospital       Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลพื้นฐาน
  name           String
  nameEn         String?
  shortName      String?
  code           String          // รหัสแผนก
  description    String?
  
  // ประเภทและสถานะ
  type           DepartmentType
  status         DepartmentStatus @default(ACTIVE)
  
  // การจัดการทางการเงิน
  budgetAllocation Decimal?      // งบประมาณที่ได้รับ
  costCenter     String?         // รหัสศูนย์ต้นทุน
  
  // การติดต่อ
  location       String?         // ตำแหน่งในโรงพยาบาล
  phoneExtension String?         // หมายเลขต่อใน
  
  // การจัดการ
  headUserId     String?         // หัวหน้าแผนก
  headUser       User?           @relation("DepartmentHead", fields: [headUserId], references: [id], onDelete: SetNull)
  
  // การตั้งค่า
  settings       Json?           // การตั้งค่าเฉพาะแผนก
  operatingHours Json?           // เวลาทำการ
  
  // Audit fields
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  isActive       Boolean         @default(true)
  
  // Relations - เพิ่ม inverse relations
  users          User[]          // Staff ในแผนก
  requisitions   Requisition[]   // ใบเบิกจากแผนก
  requisitionTemplates RequisitionTemplate[]
  
  @@unique([hospitalId, code])
  @@map("departments")
}

enum WarehouseType {
  MAIN_PHARMACY   // เภสัชกรรมหลัก
  SATELLITE       // คลังย่อย
  EMERGENCY       // คลังฉุกเฉิน
  CONTROLLED      // คลังยาควบคุม
  COLD_STORAGE    // ห้องเย็น
  QUARANTINE      // ห้องกักกัน
  EXPIRED         // คลังยาหมดอายุ
}

enum WarehouseStatus {
  ACTIVE      // ใช้งานปกติ
  INACTIVE    // ปิดใช้งานชั่วคราว
  MAINTENANCE // อยู่ระหว่างซ่อมบำรุง
  FULL        // เต็ม ไม่สามารถรับเพิ่มได้
}

model Warehouse {
  id           String          @id @default(uuid())
  
  // ความสัมพันธ์กับโรงพยาบาล
  hospitalId   String
  hospital     Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลพื้นฐาน
  name         String
  code         String          // รหัสคลัง
  description  String?
  
  // ประเภทและสถานะ
  type         WarehouseType
  status       WarehouseStatus @default(ACTIVE)
  
  // ตำแหน่งและขนาด
  location     String?         // ตำแหน่งภายในโรงพยาบาล
  floor        String?         // ชั้น
  room         String?         // ห้อง
  capacity     Decimal?        // ความจุ (ลูกบาศก์เมตร)
  
  // การควบคุมสิ่งแวดล้อม
  tempMin      Decimal?        // อุณหภูมิต่ำสุด (°C)
  tempMax      Decimal?        // อุณหภูมิสูงสุด (°C)
  humidityMin  Decimal?        // ความชื้นต่ำสุด (%)
  humidityMax  Decimal?        // ความชื้นสูงสุด (%)
  hasTemperatureControl Boolean @default(false)
  hasHumidityControl Boolean @default(false)
  
  // ความปลอดภัย
  securityLevel String?        // ระดับความปลอดภัย
  accessControl Json?          // การควบคุมการเข้าถึง
  requiresApproval Boolean     @default(false)
  
  // การจัดการ
  managerUserId String?        // ผู้จัดการคลัง
  managerUser   User?          @relation("WarehouseManager", fields: [managerUserId], references: [id], onDelete: SetNull)
  
  // การตั้งค่า
  settings      Json?          // การตั้งค่าเฉพาะคลัง
  
  // Audit fields
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isActive      Boolean        @default(true)
  
  // Relations - เพิ่ม inverse relations ทั้งหมด
  stockCards    StockCard[]
  transactions  StockTransaction[]
  transfersFrom StockTransaction[] @relation("TransferFrom")
  transfersTo   StockTransaction[] @relation("TransferTo")
  stockCounts   StockCount[]
  monitoringLogs TemperatureLog[]
  
  @@unique([hospitalId, code])
  @@map("warehouses")
}

// การติดตามอุณหภูมิและความชื้น
model TemperatureLog {
  id          String    @id @default(uuid())
  
  // ความสัมพันธ์
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการวัด
  temperature Decimal   // อุณหภูมิ (°C)
  humidity    Decimal?  // ความชื้น (%)
  
  // สถานะ
  isWithinRange Boolean  // อยู่ในช่วงที่กำหนดหรือไม่
  alertTriggered Boolean @default(false) // มีการแจ้งเตือนหรือไม่
  
  // อุปกรณ์วัด
  deviceId    String?   // รหัสอุปกรณ์วัด
  deviceType  String?   // ประเภทอุปกรณ์
  
  // การติดตาม
  recordedAt  DateTime  @default(now())
  
  @@index([warehouseId, recordedAt])
  @@map("temperature_logs")
}

// ==========================================
// INVENTORY
// ==========================================

// prisma/schemas/inventory.prisma
// Inventory Management Schema
// ระบบจัดการสต็อกยา การนับสต็อก และการติดตาม batch

enum DrugStatus {
  ACTIVE      // ใช้งานปกติ
  INACTIVE    // ไม่ใช้งานชั่วคราว
  PENDING     // รอการอนุมัติ
  DISCONTINUED // เลิกใช้แล้ว
  RESTRICTED  // จำกัดการใช้งาน
}

enum ControlledStatus {
  NON_CONTROLLED // ยาทั่วไป
  CONTROLLED_1   // ยาเสพติดประเภท 1
  CONTROLLED_2   // ยาเสพติดประเภท 2
  CONTROLLED_3   // ยาเสพติดประเภท 3
  CONTROLLED_4   // ยาเสพติดประเภท 4
  CONTROLLED_5   // ยาเสพติดประเภท 5
  DANGEROUS      // ยาอันตราย
  PSYCHOTROPIC   // ยาที่มีผลต่อจิต
}

model Drug {
  id               String          @id @default(uuid())
  
  // ความสัมพันธ์กับโรงพยาบาล
  hospitalId       String
  hospital         Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลพื้นฐาน
  drugCode         String          // รหัสยาเฉพาะโรงพยาบาล
  genericName      String          // ชื่อสามัญ
  brandName        String?         // ชื่อการค้า
  description      String?
  
  // รูปแบบและความแรง
  dosageForm       String          // รูปแบบยา: tablet, capsule, injection, etc.
  strength         String          // ความแรง: 10mg, 250mg/5ml, etc.
  unitOfMeasure    String          // หน่วยนับ: tablet, vial, bottle, etc.
  packSize         Int             @default(1) // ขนาดแพ็ค
  
  // การจำแนกยา
  therapeuticCategory String?      // หมวดยารักษาโรค
  pharmacologicalClass String?    // กลุ่มยาทางเภสัชวิทยา
  atcCode          String?         // รหัส ATC
  controlledStatus ControlledStatus @default(NON_CONTROLLED)
  
  // การจัดเก็บ
  storageRequirement String?       // ความต้องการการจัดเก็บ
  specialHandling  String?         // การจัดการพิเศษ
  
  // รายละเอียดเพิ่มเติม
  indications      String?         // ข้อบ่งใช้
  contraindications String?        // ข้อห้ามใช้
  sideEffects      String?         // ผลข้างเคียง
  
  // การจัดซื้อ
  standardUnitCost Decimal?        // ราคาต่อหน่วยมาตรฐาน
  averageUnitCost  Decimal?        // ราคาเฉลี่ยต่อหน่วย
  lastPurchasePrice Decimal?       // ราคาซื้อครั้งล่าสุด
  
  // สถานะ
  status           DrugStatus      @default(ACTIVE)
  isActive         Boolean         @default(true)
  
  // การอนุมัติ
  approvedBy       String?         // ผู้อนุมัติ
  approvedAt       DateTime?       // วันที่อนุมัติ
  
  // Audit fields
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  createdBy        String?
  lastModifiedBy   String?
  
  // Relations - เพิ่ม inverse relations ทั้งหมด
  stockCards       StockCard[]
  transactions     StockTransaction[]
  requisitionItems RequisitionItem[]
  suggestedForItems RequisitionItem[] @relation("SuggestedDrug")
  drugInteractions DrugInteraction[] @relation("DrugA")
  interactionsWith DrugInteraction[] @relation("DrugB")
  supplierProducts SupplierProduct[]
  purchaseOrderItems PurchaseOrderItem[]
  goodsReceiptItems GoodsReceiptItem[]
  templateItems    RequisitionTemplateItem[]
  controlledSubstanceLogs ControlledSubstanceLog[]
  
  @@unique([hospitalId, drugCode])
  @@index([hospitalId, genericName])
  @@index([hospitalId, therapeuticCategory])
  @@index([controlledStatus])
  @@map("drugs")
}

// การติดต่อระหว่างยา
model DrugInteraction {
  id          String @id @default(uuid())
  
  // ยาที่มีปฏิกิริยา
  drugAId     String
  drugA       Drug   @relation("DrugA", fields: [drugAId], references: [id], onDelete: Cascade)
  drugBId     String
  drugB       Drug   @relation("DrugB", fields: [drugBId], references: [id], onDelete: Cascade)
  
  // ประเภทปฏิกิริยา
  severity    String // "MINOR", "MODERATE", "MAJOR", "CONTRAINDICATED"
  effect      String // ผลที่เกิดขึ้น
  mechanism   String? // กลไกการเกิดปฏิกิริยา
  management  String? // การจัดการ
  
  // การติดตาม
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([drugAId, drugBId])
  @@map("drug_interactions")
}

enum StockCardStatus {
  ACTIVE      // ใช้งานปกติ
  INACTIVE    // ไม่ใช้งานชั่วคราว
  DISCONTINUED // เลิกใช้แล้ว
  FROZEN      // หยุดการเคลื่อนไหวชั่วคราว
}

model StockCard {
  id           String          @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId   String
  hospital     Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  warehouseId  String
  warehouse    Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  drugId       String
  drug         Drug            @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // ระดับสต็อก
  currentStock  Int            @default(0)    // สต็อกปัจจุบัน
  reservedStock Int            @default(0)    // สต็อกที่จองไว้
  availableStock Int           @default(0)    // สต็อกที่ใช้ได้ (current - reserved)
  minimumStock  Int                           // สต็อกต่ำสุด
  maximumStock  Int                           // สต็อกสูงสุด
  reorderPoint  Int                           // จุดสั่งซื้อใหม่
  reorderQuantity Int?                        // จำนวนที่ควรสั่งซื้อ
  
  // ข้อมูลต้นทุน
  unitCost     Decimal                        // ต้นทุนต่อหน่วย
  totalValue   Decimal         @default(0)    // มูลค่ารวม (computed)
  
  // การคำนวณอัตโนมัติ
  averageDailyUsage Decimal?                  // การใช้เฉลี่ยต่อวัน
  daysOfStock      Int?                       // จำนวนวันที่สต็อกเพียงพอ
  turnoverRate     Decimal?                   // อัตราการหมุนเวียน
  
  // การแจ้งเตือน
  lowStockAlert    Boolean      @default(false)
  expiryAlert      Boolean      @default(false)
  overStockAlert   Boolean      @default(false)
  
  // สถานะ
  status           StockCardStatus @default(ACTIVE)
  isActive         Boolean         @default(true)
  
  // การติดตามล่าสุด
  lastReceivedAt   DateTime?      // วันที่รับล่าสุด
  lastDispensedAt  DateTime?      // วันที่จ่ายล่าสุด
  lastCountedAt    DateTime?      // วันที่นับล่าสุด
  
  // Audit fields
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  createdBy        String?
  lastModifiedBy   String?
  
  // Relations - เพิ่ม inverse relations ทั้งหมด
  batches          StockBatch[]
  transactions     StockTransaction[]
  requisitionItems RequisitionItem[]
  stockCountItems  StockCountItem[]
  
  @@unique([hospitalId, warehouseId, drugId])
  @@index([hospitalId, currentStock])
  @@index([lowStockAlert])
  @@index([expiryAlert])
  @@map("stock_cards")
}

enum BatchStatus {
  ACTIVE          // ใช้งานปกติ
  QUARANTINE      // กักกัน รอตรวจสอบ
  EXPIRED         // หมดอายุ
  RECALLED        // เรียกคืน
  DAMAGED         // เสียหาย
  DISPOSED        // ทำลายแล้ว
  RESERVED        // จองไว้
}

model StockBatch {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  stockCardId     String
  stockCard       StockCard     @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  
  // ข้อมูล batch
  batchNumber     String        // หมายเลข batch/lot
  manufacturingDate DateTime?   // วันที่ผลิต
  expiryDate      DateTime      // วันหมดอายุ
  
  // จำนวนและต้นทุน
  quantityReceived Int          // จำนวนที่รับเข้า
  quantityAvailable Int         // จำนวนที่เหลือ
  quantityReserved Int          @default(0) // จำนวนที่จอง
  unitCost        Decimal       // ต้นทุนต่อหน่วย
  totalCost       Decimal       // ต้นทุนรวม
  
  // ข้อมูลซัพพลายเออร์
  supplierId      String?
  supplier        Supplier?     @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  purchaseOrderNo String?       // หมายเลข PO
  invoiceNo       String?       // หมายเลขใบแจ้งหนี้
  
  // วันที่สำคัญ
  receivedDate    DateTime      // วันที่รับเข้า
  firstUsedDate   DateTime?     // วันที่ใช้ครั้งแรก
  
  // สถานะ
  status          BatchStatus   @default(ACTIVE)
  
  // การตรวจสอบคุณภาพ
  qcStatus        String?       // สถานะ QC: "PENDING", "PASSED", "FAILED"
  qcDate          DateTime?     // วันที่ตรวจสอบ QC
  qcNotes         String?       // หมายเหตุ QC
  
  // การจัดเก็บ
  storageLocation String?       // ตำแหน่งเก็บ
  storageCondition String?      // เงื่อนไขการเก็บ
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations - เพิ่ม inverse relations
  transactions    StockTransaction[]
  stockCountItems StockCountItem[]
  
  @@unique([hospitalId, stockCardId, batchNumber])
  @@index([hospitalId, expiryDate])
  @@index([status])
  @@map("stock_batches")
}

enum TransactionType {
  RECEIVE         // รับยาจากซัพพลายเออร์
  DISPENSE        // จ่ายยาให้แผนก
  TRANSFER_OUT    // โอนออกไปคลังอื่น
  TRANSFER_IN     // รับโอนจากคลังอื่น
  ADJUST_INCREASE // ปรับเพิ่ม (การนับพบเพิ่ม)
  ADJUST_DECREASE // ปรับลด (การนับพบลด, เสียหาย)
  RETURN          // รับคืนยาจากแผนก
  DISPOSE         // ทำลายยาหมดอายุ/เสียหาย
  RESERVE         // จองยาสำหรับใบเบิก
  UNRESERVE       // ยกเลิกการจอง
  QUARANTINE      // เข้าห้องกักกัน
  RELEASE_QUARANTINE // ออกจากห้องกักกัน
  THEFT           // สูญหาย/ถูกขโมย
  DAMAGE          // เสียหายจากการเก็บรักษา
}

model StockTransaction {
  id               String          @id @default(uuid())
  
  // ความสัมพันธ์หลัก
  hospitalId       String
  warehouseId      String
  warehouse        Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  drugId           String
  drug             Drug            @relation(fields: [drugId], references: [id], onDelete: Cascade)
  stockCardId      String
  stockCard        StockCard       @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  batchId          String?
  batch            StockBatch?     @relation(fields: [batchId], references: [id], onDelete: SetNull)
  
  // รายละเอียดการทำรายการ
  transactionType  TransactionType
  quantity         Int             // จำนวน (+/-)
  unitCost         Decimal         // ต้นทุนต่อหน่วย
  totalCost        Decimal         // ต้นทุนรวม
  
  // จำนวนก่อนและหลัง
  stockBefore      Int             // สต็อกก่อนทำรายการ
  stockAfter       Int             // สต็อกหลังทำรายการ
  
  // การอ้างอิง
  referenceDocument String?        // เลขที่เอกสารอ้างอิง (PO, REQ, etc.)
  referenceId      String?         // ID ของเอกสารอ้างอิง
  notes            String?         // หมายเหตุ
  
  // การโอน (สำหรับ TRANSFER)
  fromWarehouseId  String?         // คลังต้นทาง
  fromWarehouse    Warehouse?      @relation("TransferFrom", fields: [fromWarehouseId], references: [id], onDelete: SetNull)
  toWarehouseId    String?         // คลังปลายทาง
  toWarehouse      Warehouse?      @relation("TransferTo", fields: [toWarehouseId], references: [id], onDelete: SetNull)
  
  // ผู้ดำเนินการ
  performedBy      String
  performedByUser  User            @relation(fields: [performedBy], references: [id], onDelete: Restrict)
  
  // การอนุมัติ (สำหรับรายการที่ต้องอนุมัติ)
  approvalRequired Boolean         @default(false)
  approvedBy       String?
  approvedAt       DateTime?
  
  // การติดตาม
  transactionDate  DateTime        @default(now())
  createdAt        DateTime        @default(now())
  
  @@index([hospitalId, transactionDate])
  @@index([stockCardId, transactionDate])
  @@index([transactionType])
  @@map("stock_transactions")

  requisitionId   String?
  requisition     Requisition?  @relation(fields: [requisitionId], references: [id], onDelete: SetNull)
  
}

// การนับสต็อก
enum StockCountStatus {
  PLANNED     // วางแผนแล้ว
  IN_PROGRESS // กำลังดำเนินการ
  COMPLETED   // เสร็จสิ้น
  VERIFIED    // ตรวจสอบแล้ว
  ADJUSTED    // ปรับปรุงแล้ว
  CANCELLED   // ยกเลิก
}

model StockCount {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  warehouseId     String
  warehouse       Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการนับ
  countNumber     String          // หมายเลขการนับ
  countDate       DateTime        // วันที่นับ
  countType       String          // ประเภทการนับ: "FULL", "CYCLE", "SPOT"
  
  // สถานะ
  status          StockCountStatus @default(PLANNED)
  
  // ผลลัพธ์
  totalItems      Int?            // จำนวนรายการทั้งหมด
  countedItems    Int?            // จำนวนรายการที่นับแล้ว
  discrepancies   Int?            // จำนวนรายการที่มีความผิดปกติ
  
  // ผู้รับผิดชอบ
  countedBy       String          // ผู้นับ
  counter         User            @relation("StockCounter", fields: [countedBy], references: [id], onDelete: Restrict)
  verifiedBy      String?         // ผู้ตรวจสอบ
  verifier        User?           @relation("StockCountVerifier", fields: [verifiedBy], references: [id], onDelete: SetNull)
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  items           StockCountItem[]
  
  @@index([hospitalId, countDate])
  @@index([status])
  @@map("stock_counts")
}

model StockCountItem {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  stockCountId    String
  stockCount      StockCount  @relation(fields: [stockCountId], references: [id], onDelete: Cascade)
  stockCardId     String
  stockCard       StockCard   @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  batchId         String?
  batch           StockBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)
  
  // ข้อมูลการนับ
  systemQuantity  Int         // จำนวนในระบบ
  countedQuantity Int?        // จำนวนที่นับได้
  variance        Int?        // ส่วนต่าง (counted - system)
  
  // สถานะ
  status          String      @default("PENDING") // "PENDING", "COUNTED", "VERIFIED", "ADJUSTED"
  
  // หมายเหตุ
  notes           String?
  countedAt       DateTime?
  
  @@index([stockCountId])
  @@map("stock_count_items")
}

// ==========================================
// REQUISITIONS
// ==========================================

// prisma/schemas/requisitions.prisma
// Requisition Management Schema
// ระบบจัดการใบเบิกยาและ workflow การอนุมัติ

enum RequisitionType {
  REGULAR         // การเบิกตามปกติ
  EMERGENCY       // เบิกด่วนสำหรับ critical care
  SCHEDULED       // เบิกตามตารางเวลา (weekly/monthly)
  RETURN          // ส่งคืนยาที่ไม่ได้ใช้
  TRANSFER        // โอนระหว่างแผนก
  REFILL          // เติมเต็มสต็อกประจำ
  STAT            // เบิกด่วนฉุกเฉิน
}

enum RequisitionStatus {
  DRAFT           // แผนกเตรียมใบเบิก
  SUBMITTED       // ส่งใบเบิกให้ pharmacy
  UNDER_REVIEW    // pharmacy ตรวจสอบ
  APPROVED        // อนุมัติใบเบิก
  PARTIALLY_FILLED // จ่ายบางรายการ (stock ไม่เพียงพอ)
  COMPLETED       // จ่ายครบทุกรายการ
  CANCELLED       // ยกเลิกใบเบิก
  REJECTED        // ปฏิเสธใบเบิก
  ON_HOLD         // พักการดำเนินการ
  EXPIRED         // หมดเวลา
}

enum WorkflowStep {
  DRAFT                   // ร่าง
  SUBMITTED               // ส่งแล้ว
  DEPARTMENT_HEAD_REVIEW  // หัวหน้าแผนกตรวจสอบ
  PHARMACY_REVIEW         // เภสัชกรรมตรวจสอบ
  MANAGER_APPROVAL        // ผู้จัดการอนุมัติ
  FULFILLMENT_PREPARATION // เตรียมการจ่าย
  FULFILLMENT_PROCESSING  // กำลังจ่าย
  QUALITY_CHECK           // ตรวจสอบคุณภาพ
  DELIVERY               // ส่งมอบ
  COMPLETED              // เสร็จสิ้น
  CANCELLED              // ยกเลิก
}

model Requisition {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์หลัก
  hospitalId      String
  hospital        Hospital          @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  departmentId    String
  department      Department        @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  // หมายเลขใบเบิก
  requisitionNumber String          @unique
  internalNumber    String?         // หมายเลขภายในแผนก
  fiscalYear        String?         // ปีงบประมาณ
  
  // ประเภทและความสำคัญ
  type            RequisitionType
  priority        Priority          @default(NORMAL)
  isUrgent        Boolean           @default(false)
  isEmergency     Boolean           @default(false)
  
  // สถานะและ workflow
  status          RequisitionStatus @default(DRAFT)
  currentStep     WorkflowStep      @default(DRAFT)
  
  // ผู้ที่เกี่ยวข้อง
  requestedBy     String            // ผู้เบิก
  requester       User              @relation("RequesterRelation", fields: [requestedBy], references: [id], onDelete: Restrict)
  
  approvedBy      String?           // ผู้อนุมัติ
  approver        User?             @relation("ApproverRelation", fields: [approvedBy], references: [id], onDelete: SetNull)
  
  fulfilledBy     String?           // ผู้จ่าย
  fulfiller       User?             @relation("FulfillerRelation", fields: [fulfilledBy], references: [id], onDelete: SetNull)
  
  // วันที่สำคัญ
  requestedAt     DateTime          @default(now())
  requiredDate    DateTime          // วันที่ต้องการใช้ยา
  approvedAt      DateTime?
  fulfilledAt     DateTime?
  deliveredAt     DateTime?
  
  // รายละเอียดเพิ่มเติม
  purpose         String?           // วัตถุประสงค์การใช้
  notes           String?           // หมายเหตุทั่วไป
  specialInstructions String?       // คำแนะนำพิเศษ
  
  // การปฏิเสธ
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  
  // การยกเลิก
  cancelledAt     DateTime?
  cancelledBy     String?
  cancellationReason String?
  
  // ข้อมูลการส่งมอบ
  deliveryMethod  String?           // วิธีส่งมอบ: "PICKUP", "DELIVERY", "URGENT_DELIVERY"
  deliveryAddress String?           // ที่อยู่ส่งมอบ
  deliveryContact String?           // ผู้ติดต่อรับมอบ
  deliveryInstructions String?      // คำแนะนำการส่งมอบ
  
  // การติดตามต้นทุน
  estimatedCost   Decimal?          // ต้นทุนประเมิน
  actualCost      Decimal?          // ต้นทุนจริง
  
  // การตั้งค่า
  autoApprove     Boolean           @default(false)
  requiresSignature Boolean         @default(false)
  
  // Audit fields
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  items           RequisitionItem[]
  workflow        RequisitionWorkflow[]
  transactions    StockTransaction[]
  attachments     RequisitionAttachment[]
  
  @@index([hospitalId, departmentId])
  @@index([status])
  @@index([priority])
  @@index([requestedAt])
  @@index([requiredDate])
  @@map("requisitions")
}

enum ItemStatus {
  PENDING         // รอดำเนินการ
  APPROVED        // อนุมัติแล้ว
  PARTIALLY_FILLED // จ่ายบางส่วน
  FULFILLED       // จ่ายครบ
  REJECTED        // ปฏิเสธ
  SUBSTITUTED     // ใช้ยาทดแทน
  OUT_OF_STOCK    // ยาหมดสต็อก
  BACK_ORDER      // สั่งซื้อเพิ่ม
  CANCELLED       // ยกเลิก
}

model RequisitionItem {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId   String
  requisition     Requisition     @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug            @relation(fields: [drugId], references: [id], onDelete: Cascade)
  stockCardId     String?
  stockCard       StockCard?      @relation(fields: [stockCardId], references: [id], onDelete: SetNull)
  
  // จำนวน
  requestedQty    Int             // จำนวนที่เบิก
  approvedQty     Int?            // จำนวนที่อนุมัติ
  fulfilledQty    Int             @default(0) // จำนวนที่จ่ายแล้ว
  remainingQty    Int             @default(0) // จำนวนที่เหลือ
  
  // ราคา
  unitCost        Decimal?        // ราคาต่อหน่วย
  totalCost       Decimal?        // ราคารวม
  
  // สถานะ
  status          ItemStatus      @default(PENDING)
  
  // การทดแทน
  suggestedDrugId String?         // ยาที่แนะนำทดแทน
  suggestedDrug   Drug?           @relation("SuggestedDrug", fields: [suggestedDrugId], references: [id], onDelete: SetNull)
  substitutionReason String?      // เหตุผลการทดแทน
  isSubstituted   Boolean         @default(false)
  
  // เหตุผลพิเศษ
  urgencyReason   String?         // เหตุผลความเร่งด่วน
  clinicalJustification String?   // เหตุผลทางคลินิก
  
  // การปฏิเสธ
  rejectionReason String?
  rejectedBy      String?
  rejectedAt      DateTime?
  
  // หมายเหตุ
  notes           String?
  pharmacistNotes String?         // หมายเหตุจากเภสัชกร
  
  // การติดตาม batch
  preferredBatch  String?         // batch ที่ต้องการ
  actualBatch     String?         // batch ที่จ่ายจริง
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([requisitionId])
  @@index([drugId])
  @@index([status])
  @@map("requisition_items")
}

enum WorkflowAction {
  SUBMIT              // ส่งใบเบิก
  APPROVE             // อนุมัติ
  REJECT              // ปฏิเสธ
  FULFILL             // จ่ายยา
  PARTIAL_FULFILL     // จ่ายบางส่วน
  CANCEL              // ยกเลิก
  RETURN_FOR_REVISION // ส่งกลับแก้ไข
  PUT_ON_HOLD         // พักการดำเนินการ
  RESUME              // ดำเนินการต่อ
  DELIVER             // ส่งมอบ
  RECEIVE             // รับมอบ
  COMPLETE            // เสร็จสิ้น
}

model RequisitionWorkflow {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId   String
  requisition     Requisition     @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  // ข้อมูล workflow
  fromStep        WorkflowStep?   // ขั้นตอนเดิม
  toStep          WorkflowStep    // ขั้นตอนใหม่
  action          WorkflowAction
  
  // ผู้ดำเนินการ
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Restrict)
  
  // รายละเอียด
  notes           String?
  reason          String?         // เหตุผล (สำหรับการปฏิเสธ/ยกเลิก)
  
  // เอกสารแนบ
  attachmentUrl   String?
  
  // การติดตาม
  timestamp       DateTime        @default(now())
  ipAddress       String?
  userAgent       String?
  
  // สถานะ
  isSystemGenerated Boolean       @default(false) // สร้างโดยระบบหรือไม่
  
  @@index([requisitionId])
  @@index([userId])
  @@index([timestamp])
  @@map("requisition_workflows")
}

// เอกสารแนบใบเบิก
model RequisitionAttachment {
  id            String      @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId String
  requisition   Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  // ข้อมูลไฟล์
  filename      String
  originalName  String
  fileSize      Int
  mimeType      String
  fileUrl       String
  
  // ประเภทเอกสาร
  documentType  String      // "PRESCRIPTION", "APPROVAL", "INVOICE", "DELIVERY_NOTE", "OTHER"
  description   String?
  
  // ผู้อัพโหลด
  uploadedBy    String
  uploader      User        @relation(fields: [uploadedBy], references: [id], onDelete: Restrict)
  
  // การติดตาม
  uploadedAt    DateTime    @default(now())
  
  @@index([requisitionId])
  @@map("requisition_attachments")
}

// เทมเพลตใบเบิก (สำหรับการเบิกประจำ)
model RequisitionTemplate {
  id            String      @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId    String
  hospital      Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  departmentId  String
  department    Department  @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  // ข้อมูลเทมเพลต
  name          String      // ชื่อเทมเพลต
  description   String?
  type          RequisitionType
  
  // การใช้งาน
  isActive      Boolean     @default(true)
  frequency     String?     // "WEEKLY", "MONTHLY", "QUARTERLY"
  
  // การตั้งค่า
  autoSubmit    Boolean     @default(false)
  reminderDays  Int?        // แจ้งเตือนก่อนกี่วัน
  
  // ผู้สร้าง
  createdBy     String
  creator       User        @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  
  // Audit fields
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  items         RequisitionTemplateItem[]
  
  @@index([hospitalId, departmentId])
  @@map("requisition_templates")
}

model RequisitionTemplateItem {
  id                    String              @id @default(uuid())
  
  // ความสัมพันธ์
  templateId            String
  template              RequisitionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  drugId                String
  drug                  Drug                @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // จำนวนมาตรฐาน
  standardQuantity      Int
  minimumQuantity       Int?
  maximumQuantity       Int?
  
  // การปรับปรุงอัตโนมัติ
  autoCalculateQty      Boolean             @default(false)
  calculationMethod     String?             // "CONSUMPTION_BASED", "PAR_LEVEL", "MANUAL"
  
  // หมายเหตุ
  notes                 String?
  
  @@index([templateId])
  @@map("requisition_template_items")
}

// ==========================================
// SUPPLIERS
// ==========================================

// prisma/schemas/suppliers.prisma
// Supplier Management Schema
// ระบบจัดการซัพพลายเออร์และการจัดซื้อ

enum SupplierType {
  MANUFACTURER    // บริษัทผลิต
  DISTRIBUTOR     // ผู้จัดจำหน่าย
  WHOLESALER      // ผู้ค้าส่ง
  IMPORTER        // ผู้นำเข้า
  LOCAL_PHARMACY  // ร้านยาท้องถิ่น
  GOVERNMENT      // หน่วยงานราชการ
  INTERNATIONAL   // ต่างประเทศ
}

enum SupplierStatus {
  ACTIVE          // ใช้งานปกติ
  INACTIVE        // ไม่ใช้งานชั่วคราว
  SUSPENDED       // ระงับการใช้งาน
  BLACKLISTED     // ขึ้นบัญชีดำ
  PENDING_APPROVAL // รอการอนุมัติ
  UNDER_REVIEW    // อยู่ระหว่างการทบทวน
}

enum SupplierRating {
  EXCELLENT       // ดีเยี่ยม
  GOOD           // ดี
  AVERAGE        // ปานกลาง
  POOR           // แย่
  UNRATED        // ไม่ได้รับการประเมิน
}

model Supplier {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์กับโรงพยาบาล
  hospitalId      String
  hospital        Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลพื้นฐาน
  code            String          // รหัสซัพพลายเออร์
  name            String          // ชื่อบริษัท
  nameEn          String?         // ชื่อภาษาอังกฤษ
  shortName       String?         // ชื่อย่อ
  
  // ประเภทและสถานะ
  type            SupplierType
  status          SupplierStatus  @default(PENDING_APPROVAL)
  rating          SupplierRating  @default(UNRATED)
  
  // ข้อมูลทางธุรกิจ
  taxId           String?         // เลขประจำตัวผู้เสียภาษี
  businessLicense String?         // ใบอนุญาตประกอบธุรกิจ
  pharmacyLicense String?         // ใบอนุญาตร้านยา (ถ้ามี)
  gmpCertificate  String?         // ใบรับรอง GMP
  
  // ที่อยู่
  address         Json            // ที่อยู่ทางไปรษณีย์
  billingAddress  Json?           // ที่อยู่สำหรับเรียกเก็บเงิน
  shippingAddress Json?           // ที่อยู่สำหรับจัดส่ง
  
  // ข้อมูลติดต่อ
  contactInfo     Json            // { phone, fax, email, website }
  emergencyContact Json?          // ติดต่อฉุกเฉิน
  
  // เงื่อนไขทางการค้า
  paymentTerms    String?         // เงื่อนไขการชำระเงิน
  creditLimit     Decimal?        // วงเงินเครดิต
  creditPeriod    Int?            // ระยะเวลาเครดิต (วัน)
  deliveryTerms   String?         // เงื่อนไขการส่งมอบ
  minimumOrder    Decimal?        // จำนวนสั่งซื้อขั้นต่ำ
  
  // การประเมินผลการปฏิบัติงาน
  onTimeDeliveryRate Decimal?     // อัตราการส่งมอบตรงเวลา (%)
  qualityScore    Decimal?        // คะแนนคุณภาพ
  serviceScore    Decimal?        // คะแนนการบริการ
  overallScore    Decimal?        // คะแนนรวม
  
  // การติดต่อทางเทคนิค
  ediCapable      Boolean         @default(false) // รองรับ EDI
  apiEndpoint     String?         // API สำหรับเชื่อมต่อ
  catalogUpdate   String?         // วิธีการอัพเดตแคตตาล็อก
  
  // ใบรับรองและมาตรฐาน
  certifications  Json?           // ใบรับรองต่างๆ
  accreditations  Json?           // การรับรอง
  
  // การติดตามการทำงาน
  lastOrderDate   DateTime?       // วันที่สั่งซื้อล่าสุด
  lastDeliveryDate DateTime?      // วันที่ส่งมอบล่าสุด
  totalOrders     Int             @default(0)
  totalValue      Decimal         @default(0)
  
  // หมายเหตุ
  notes           String?         // หมายเหตุทั่วไป
  internalNotes   String?         // หมายเหตุภายใน
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String?
  isActive        Boolean         @default(true)
  
  // Relations
  contacts        SupplierContact[]
  products        SupplierProduct[]
  batches         StockBatch[]
  purchaseOrders  PurchaseOrder[]
  evaluations     SupplierEvaluation[]
  goodsReceipts   GoodsReceipt[]
  
  @@unique([hospitalId, code])
  @@index([hospitalId, status])
  @@index([type])
  @@index([rating])
  @@map("suppliers")
}

model SupplierContact {
  id            String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId    String
  supplier      Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // ข้อมูลบุคคล
  name          String
  position      String?     // ตำแหน่ง
  department    String?     // แผนก
  
  // ข้อมูลติดต่อ
  phone         String?
  mobile        String?
  email         String?
  fax           String?
  
  // ประเภทการติดต่อ
  contactType   String      // "PRIMARY", "SECONDARY", "SALES", "TECHNICAL", "BILLING", "EMERGENCY"
  isPrimary     Boolean     @default(false)
  
  // สถานะ
  isActive      Boolean     @default(true)
  
  // การติดตาม
  lastContactDate DateTime?
  
  // หมายเหตุ
  notes         String?
  
  // Audit fields
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([supplierId])
  @@map("supplier_contacts")
}

model SupplierProduct {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug        @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // รหัสสินค้าของซัพพลายเออร์
  supplierProductCode String?
  supplierBarcode String?
  
  // ราคาและเงื่อนไข
  unitPrice       Decimal
  unitOfMeasure   String      // หน่วยนับ
  packSize        Int?        // ขนาดแพ็ค
  minimumOrderQty Int?        // จำนวนสั่งซื้อขั้นต่ำ
  
  // เวลาจัดส่ง
  leadTimeDays    Int?        // ระยะเวลาส่งมอบ (วัน)
  availability    String?     // สถานะความพร้อม
  
  // ข้อมูลผลิตภัณฑ์
  manufacturerLot String?     // รหัส lot ของผู้ผลิต
  expiryPeriod    Int?        // อายุการเก็บ (เดือน)
  storageCondition String?    // เงื่อนไขการเก็บ
  
  // สถานะ
  isPreferred     Boolean     @default(false) // ซัพพลายเออร์หลัก
  isActive        Boolean     @default(true)
  
  // การติดตาม
  lastOrderDate   DateTime?
  lastPurchasePrice Decimal?
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@unique([supplierId, drugId])
  @@index([supplierId])
  @@index([drugId])
  @@map("supplier_products")
}

enum PurchaseOrderStatus {
  DRAFT           // ร่าง
  SUBMITTED       // ส่งแล้ว
  CONFIRMED       // ยืนยันแล้ว
  PARTIALLY_RECEIVED // รับบางส่วน
  COMPLETED       // เสร็จสิ้น
  CANCELLED       // ยกเลิก
  ON_HOLD         // พักการดำเนินการ
}

model PurchaseOrder {
  id              String              @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital            @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // หมายเลขใบสั่งซื้อ
  poNumber        String              @unique
  supplierRef     String?             // เลขที่อ้างอิงของซัพพลายเออร์
  
  // สถานะ
  status          PurchaseOrderStatus @default(DRAFT)
  
  // วันที่สำคัญ
  orderDate       DateTime            @default(now())
  requiredDate    DateTime            // วันที่ต้องการรับ
  expectedDate    DateTime?           // วันที่คาดว่าจะได้รับ
  confirmedDate   DateTime?           // วันที่ซัพพลายเออร์ยืนยัน
  
  // ข้อมูลการสั่งซื้อ
  totalAmount     Decimal             @default(0)
  taxAmount       Decimal             @default(0)
  discountAmount  Decimal             @default(0)
  shippingCost    Decimal             @default(0)
  netAmount       Decimal             @default(0)
  
  // เงื่อนไขการชำระเงิน
  paymentTerms    String?
  creditPeriod    Int?                // วัน
  
  // การจัดส่ง
  deliveryAddress Json                // ที่อยู่จัดส่ง
  deliveryMethod  String?             // วิธีการจัดส่ง
  specialInstructions String?         // คำแนะนำพิเศษ
  
  // ผู้รับผิดชอบ
  orderedBy       String
  orderer         User      @relation("POOrderer", fields: [orderedBy], references: [id], onDelete: Restrict)
  approvedBy      String?
  approver        User?     @relation("POApprover", fields: [approvedBy], references: [id], onDelete: Restrict)
  
  // หมายเหตุ
  notes           String?
  internalNotes   String?             // หมายเหตุภายใน
  
  // Audit fields
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  items           PurchaseOrderItem[]
  receipts        GoodsReceipt[]
  
  @@index([hospitalId, supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // จำนวนและราคา
  orderedQty      Int           // จำนวนที่สั่ง
  receivedQty     Int           @default(0) // จำนวนที่รับแล้ว
  remainingQty    Int           @default(0) // จำนวนที่เหลือ
  unitPrice       Decimal       // ราคาต่อหน่วย
  totalPrice      Decimal       // ราคารวม
  
  // ข้อมูลผลิตภัณฑ์
  supplierProductCode String?   // รหัสสินค้าของซัพพลายเออร์
  unitOfMeasure   String        // หน่วยนับ
  packSize        Int?          // ขนาดแพ็ค
  
  // การส่งมอบ
  requiredDate    DateTime      // วันที่ต้องการ
  expectedDate    DateTime?     // วันที่คาดว่าจะได้รับ
  
  // สถานะ
  status          String        @default("PENDING") // "PENDING", "CONFIRMED", "PARTIALLY_RECEIVED", "RECEIVED", "CANCELLED"
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  goodsReceiptItems GoodsReceiptItem[]
  
  @@index([purchaseOrderId])
  @@index([drugId])
  @@map("purchase_order_items")
}

enum ReceiptStatus {
  PENDING         // รอการตรวจสอบ
  VERIFIED        // ตรวจสอบแล้ว
  DISCREPANCY     // มีความผิดปกติ
  COMPLETED       // เสร็จสิ้น
  REJECTED        // ปฏิเสธ
}

model GoodsReceipt {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  
  // หมายเลขเอกสาร
  receiptNumber   String        @unique
  supplierInvoice String?       // เลขที่ใบแจ้งหนี้ของซัพพลายเออร์
  deliveryNote    String?       // เลขที่ใบส่งของ
  
  // วันที่
  receivedDate    DateTime      @default(now())
  invoiceDate     DateTime?
  
  // สถานะ
  status          ReceiptStatus @default(PENDING)
  
  // ข้อมูลการรับ
  totalItems      Int           @default(0)
  totalAmount     Decimal       @default(0)
  
  // ผู้รับผิดชอบ
  receivedBy      String
  receiver        User      @relation("GRReceiver", fields: [receivedBy], references: [id], onDelete: Restrict)
  verifiedBy      String?
  verifier        User?     @relation("GRVerifier", fields: [verifiedBy], references: [id], onDelete: Restrict)
  
  // หมายเหตุ
  notes           String?
  discrepancyNotes String?      // หมายเหตุความผิดปกติ
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  goodsReceiptItems   GoodsReceiptItem[]
  
  @@index([hospitalId, supplierId])
  @@index([receivedDate])
  @@index([status])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  goodsReceiptId  String
  goodsReceipt    GoodsReceipt  @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  purchaseOrderItemId String?
  purchaseOrderItem   PurchaseOrderItem? @relation(fields: [purchaseOrderItemId], references: [id], onDelete: SetNull)
  
  // จำนวน
  orderedQty      Int?          // จำนวนที่สั่ง (จาก PO)
  receivedQty     Int           // จำนวนที่รับจริง
  acceptedQty     Int           // จำนวนที่ยอมรับ
  rejectedQty     Int           @default(0) // จำนวนที่ปฏิเสธ
  
  // ข้อมูล batch
  batchNumber     String
  manufacturingDate DateTime?
  expiryDate      DateTime
  
  // ราคา
  unitCost        Decimal
  totalCost       Decimal
  
  // เหตุผลการปฏิเสธ
  rejectionReason String?
  
  // การตรวจสอบคุณภาพ
  qcStatus        String?       // "PENDING", "PASSED", "FAILED"
  qcNotes         String?
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([goodsReceiptId])
  @@index([drugId])
  @@map("goods_receipt_items")
}

// การประเมินซัพพลายเออร์
model SupplierEvaluation {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // ช่วงเวลาประเมิน
  evaluationPeriod String     // "Q1 2024", "2024"
  fromDate        DateTime
  toDate          DateTime
  
  // คะแนนประเมิน
  qualityScore    Decimal     // คุณภาพสินค้า (1-5)
  deliveryScore   Decimal     // การส่งมอบตรงเวลา (1-5)
  serviceScore    Decimal     // การบริการ (1-5)
  priceScore      Decimal     // ความเหมาะสมราคา (1-5)
  overallScore    Decimal     // คะแนนรวม (1-5)
  
  // สถิติการปฏิบัติงาน
  totalOrders     Int         // จำนวนคำสั่งซื้อ
  onTimeDeliveries Int        // จำนวนการส่งมอบตรงเวลา
  qualityIssues   Int         // จำนวนปัญหาคุณภาพ
  
  // ความคิดเห็น
  strengths       String?     // จุดแข็ง
  weaknesses      String?     // จุดอ่อน
  recommendations String?     // ข้อเสนอแนะ
  
  // ผู้ประเมิน
  evaluatedBy     String
  evaluator       User        @relation(fields: [evaluatedBy], references: [id], onDelete: Restrict)
  
  // การติดตาม
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([supplierId])
  @@index([evaluationPeriod])
  @@map("supplier_evaluations")
}

// ==========================================
// ANALYTICS
// ==========================================

// prisma/schemas/analytics.prisma
// Analytics and Reporting Schema
// ระบบวิเคราะห์และรายงานสำหรับ Hospital Pharmacy System

enum ReportType {
  DAILY_STOCK_MOVEMENT     // รายงานการเคลื่อนไหวสต็อกรายวัน
  MONTHLY_CONSUMPTION      // รายงานการใช้ยารายเดือน
  ABC_ANALYSIS            // การวิเคราะห์ ABC
  SLOW_MOVING_INVENTORY   // รายงานสต็อกเคลื่อนไหวช้า
  EXPIRY_ALERT           // รายงานยาใกล้หมดอายุ
  COST_ANALYSIS          // รายงานการวิเคราะห์ต้นทุน
  SUPPLIER_PERFORMANCE   // รายงานประสิทธิภาพซัพพลายเออร์
  DEPARTMENT_UTILIZATION // รายงานการใช้งานของแผนก
  REGULATORY_COMPLIANCE  // รายงานตามกฎหมาย
  FINANCIAL_SUMMARY      // สรุปทางการเงิน
}

enum ReportStatus {
  PENDING     // รอการสร้าง
  GENERATING  // กำลังสร้าง
  COMPLETED   // เสร็จสิ้น
  FAILED      // ล้มเหลว
  EXPIRED     // หมดอายุ
}

enum ReportFormat {
  PDF         // ไฟล์ PDF
  EXCEL       // ไฟล์ Excel
  CSV         // ไฟล์ CSV
  JSON        // ข้อมูล JSON
  HTML        // หน้าเว็บ
}

model Report {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลรายงาน
  name            String        // ชื่อรายงาน
  description     String?       // คำอธิบาย
  type            ReportType
  format          ReportFormat
  
  // ช่วงเวลา
  fromDate        DateTime
  toDate          DateTime
  
  // ตัวกรอง
  filters         Json?         // ตัวกรองต่างๆ เช่น department, drug category
  parameters      Json?         // พารามิเตอร์เพิ่มเติม
  
  // สถานะ
  status          ReportStatus  @default(PENDING)
  
  // ไฟล์ผลลัพธ์
  fileUrl         String?       // URL ของไฟล์รายงาน
  fileSize        Int?          // ขนาดไฟล์ (bytes)
  
  // การประมวลผล
  startedAt       DateTime?     // เวลาเริ่มสร้าง
  completedAt     DateTime?     // เวลาเสร็จสิ้น
  errorMessage    String?       // ข้อความข้อผิดพลาด
  
  // ผู้ขอรายงาน
  requestedBy     String
  requester       User          @relation(fields: [requestedBy], references: [id], onDelete: Restrict)
  
  // การตั้งค่า
  isScheduled     Boolean       @default(false) // รายงานตามกำหนดเวลา
  scheduleConfig  Json?         // การตั้งค่าตารางเวลา
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  expiresAt       DateTime?     // วันหมดอายุของไฟล์
  
  @@index([hospitalId, type])
  @@index([status])
  @@index([requestedBy])
  @@map("reports")
}

// Dashboard สำหรับผู้ใช้แต่ละคน
model Dashboard {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ข้อมูล Dashboard
  name            String        // ชื่อ Dashboard
  description     String?       // คำอธิบาย
  layout          Json          // การจัดวาง widgets
  isDefault       Boolean       @default(false) // Dashboard หลัก
  
  // การแชร์
  isPublic        Boolean       @default(false)
  sharedWith      String[]      // User IDs ที่แชร์ให้
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  lastViewedAt    DateTime?     // เข้าดูล่าสุด
  
  // Relations
  widgets         DashboardWidget[]
  
  @@index([hospitalId, userId])
  @@map("dashboards")
}

enum WidgetType {
  KPI_CARD                // การ์ดแสดง KPI
  LINE_CHART             // กราฟเส้น
  BAR_CHART              // กราฟแท่ง
  PIE_CHART              // กราฟวงกลม
  TABLE                  // ตาราง
  ALERT_LIST             // รายการแจ้งเตือน
  STOCK_LEVEL_GAUGE      // เกจแสดงระดับสต็อก
  TREND_INDICATOR        // ตัวบ่งชี้แนวโน้ม
  HEATMAP                // แผนที่ความร้อน
  PROGRESS_BAR           // แถบความคืบหน้า
}

model DashboardWidget {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  dashboardId     String
  dashboard       Dashboard     @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  
  // ข้อมูล Widget
  title           String        // ชื่อ Widget
  type            WidgetType
  config          Json          // การตั้งค่า Widget
  dataSource      Json          // แหล่งข้อมูล
  
  // การจัดวาง
  x               Int           // ตำแหน่ง X
  y               Int           // ตำแหน่ง Y
  width           Int           // ความกว้าง
  height          Int           // ความสูง
  
  // การรีเฟรช
  refreshInterval Int?          // ความถี่การรีเฟรช (วินาที)
  lastRefreshed   DateTime?     // รีเฟรชล่าสุด
  
  // สถานะ
  isActive        Boolean       @default(true)
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([dashboardId])
  @@map("dashboard_widgets")
}

// การติดตาม KPI และเมตริกต่างๆ
model KPIMetric {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลเมตริก
  name            String        // ชื่อเมตริก
  category        String        // หมวดหมู่ เช่น "inventory", "cost", "performance"
  description     String?       // คำอธิบาย
  
  // ค่าเป้าหมาย
  targetValue     Decimal?      // ค่าเป้าหมาย
  thresholdMin    Decimal?      // ค่าขั้นต่ำ
  thresholdMax    Decimal?      // ค่าสูงสุด
  
  // หน่วย
  unit            String?       // หน่วยนับ เช่น "%", "บาท", "วัน"
  
  // การคำนวณ
  calculationMethod String      // วิธีการคำนวณ
  dataQuery       Json?         // SQL query หรือ config สำหรับดึงข้อมูล
  
  // การตั้งค่า
  isActive        Boolean       @default(true)
  updateFrequency String?       // ความถี่การอัพเดต
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  values          KPIValue[]
  
  @@index([hospitalId, category])
  @@map("kpi_metrics")
}

model KPIValue {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  kpiMetricId     String
  kpiMetric       KPIMetric     @relation(fields: [kpiMetricId], references: [id], onDelete: Cascade)
  
  // ข้อมูลค่า
  value           Decimal       // ค่าที่วัดได้
  periodType      String        // ประเภทช่วงเวลา "daily", "weekly", "monthly", "quarterly", "yearly"
  periodStart     DateTime      // เริ่มต้นช่วงเวลา
  periodEnd       DateTime      // สิ้นสุดช่วงเวลา
  
  // การเปรียบเทียบ
  previousValue   Decimal?      // ค่าช่วงก่อน
  changePercent   Decimal?      // เปอร์เซ็นต์การเปลี่ยนแปลง
  trendDirection  String?       // "UP", "DOWN", "STABLE"
  
  // การประเมิน
  isOnTarget      Boolean?      // อยู่ในเป้าหมายหรือไม่
  performanceLevel String?      // "EXCELLENT", "GOOD", "AVERAGE", "POOR"
  
  // หมายเหतุ
  notes           String?       // หมายเหตุการวัด
  
  // การติดตาม
  recordedAt      DateTime      @default(now())
  calculatedBy    String?       // ระบบหรือผู้ใช้ที่คำนวณ
  
  @@index([kpiMetricId, periodStart])
  @@index([periodType])
  @@map("kpi_values")
}

// การติดตามการใช้งานระบบ
model SystemUsage {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  userId          String?
  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // ข้อมูลการใช้งาน
  action          String        // การกระทำ เช่น "LOGIN", "STOCK_TRANSACTION", "REQUISITION_CREATE"
  module          String        // โมดูล เช่น "INVENTORY", "REQUISITION", "REPORTS"
  resourceType    String?       // ประเภทข้อมูล เช่น "STOCK_CARD", "DRUG"
  resourceId      String?       // ID ของข้อมูล
  
  // เวลาและระยะเวลา
  timestamp       DateTime      @default(now())
  duration        Int?          // ระยะเวลาใช้งาน (มิลลิวินาที)
  
  // ข้อมูลเทคนิค
  ipAddress       String?
  userAgent       String?
  deviceType      String?       // "DESKTOP", "MOBILE", "TABLET"
  browser         String?
  
  // ผลลัพธ์
  success         Boolean       @default(true)
  errorMessage    String?       // ข้อความข้อผิดพลาด (ถ้ามี)
  
  @@index([hospitalId, timestamp])
  @@index([userId, timestamp])
  @@index([action])
  @@index([module])
  @@map("system_usage")
}

// การเก็บข้อมูลสำหรับ Machine Learning
model MLDataPoint {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ประเภทข้อมูล
  dataType        String        // "CONSUMPTION_PATTERN", "DEMAND_FORECAST", "STOCK_OPTIMIZATION"
  features        Json          // ข้อมูล features สำหรับ ML
  target          Json?         // ค่าเป้าหมาย (สำหรับ supervised learning)
  
  // เวลาและบริบท
  timestamp       DateTime      @default(now())
  context         Json?         // บริบทเพิ่มเติม เช่น season, holiday, emergency
  
  // การประมวลผล
  isProcessed     Boolean       @default(false)
  processedAt     DateTime?
  modelVersion    String?       // เวอร์ชั่นของโมเดล
  
  // คุณภาพข้อมูล
  qualityScore    Decimal?      // คะแนนคุณภาพข้อมูล
  isAnomaly       Boolean       @default(false) // ข้อมูลผิดปกติ
  
  @@index([hospitalId, dataType])
  @@index([timestamp])
  @@index([isProcessed])
  @@map("ml_data_points")
}

// การพยากรณ์และ insights
model Forecast {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการพยากรณ์
  forecastType    String        // "DEMAND", "CONSUMPTION", "REORDER_POINT", "BUDGET"
  targetEntity    String        // "DRUG", "CATEGORY", "DEPARTMENT", "HOSPITAL"
  entityId        String?       // ID ของ entity
  
  // ช่วงเวลา
  forecastPeriod  String        // "DAILY", "WEEKLY", "MONTHLY", "QUARTERLY"
  periodStart     DateTime      // เริ่มต้นช่วงพยากรณ์
  periodEnd       DateTime      // สิ้นสุดช่วงพยากรณ์
  
  // ค่าพยากรณ์
  predictedValue  Decimal       // ค่าที่พยากรณ์
  confidenceLevel Decimal       // ระดับความเชื่อมั่น (0-1)
  lowerBound      Decimal?      // ขอบเขตล่าง
  upperBound      Decimal?      // ขอบเขตบน
  
  // โมเดล
  modelName       String        // ชื่อโมเดลที่ใช้
  modelVersion    String        // เวอร์ชั่นโมเดล
  accuracy        Decimal?      // ความแม่นยำของโมเดล
  
  // ข้อมูลเพิ่มเติม
  features        Json?         // Features ที่ใช้ในการพยากรณ์
  metadata        Json?         // ข้อมูลเพิ่มเติม
  
  // การติดตาม
  createdAt       DateTime      @default(now())
  actualValue     Decimal?      // ค่าจริงที่เกิดขึ้น (update ภายหลัง)
  accuracy_score  Decimal?      // คะแนนความแม่นยำเมื่อเปรียบเทียบกับค่าจริง
  
  @@index([hospitalId, forecastType])
  @@index([targetEntity, entityId])
  @@index([periodStart])
  @@map("forecasts")
}

// การวิเคราะห์แนวโน้มและ patterns
model TrendAnalysis {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการวิเคราะห์
  analysisType    String        // "SEASONAL", "GROWTH", "ANOMALY", "CORRELATION"
  targetMetric    String        // เมตริกที่วิเคราะห์
  timeframe       String        // ช่วงเวลาการวิเคราะห์
  
  // ผลการวิเคราะห์
  trendDirection  String        // "INCREASING", "DECREASING", "STABLE", "VOLATILE"
  trendStrength   Decimal       // ความแข็งแกร่งของแนวโน้ม (0-1)
  changeRate      Decimal?      // อัตราการเปลี่ยนแปลง
  
  // Insights
  summary         String        // สรุปผลการวิเคราะห์
  recommendations Json?         // ข้อเสนอแนะ
  actionItems     Json?         // รายการการดำเนินการ
  
  // ข้อมูลสถิติ
  statisticalData Json          // ข้อมูลสถิติต่างๆ
  visualizationData Json?       // ข้อมูลสำหรับการแสดงผลกราฟ
  
  // การติดตาม
  analyzedAt      DateTime      @default(now())
  validUntil      DateTime?     // ผลการวิเคราะห์ใช้ได้จนถึงเมื่อไร
  
  @@index([hospitalId, analysisType])
  @@index([analyzedAt])
  @@map("trend_analyses")
}

// Performance benchmarks และการเปรียบเทียบ
model Benchmark {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูล Benchmark
  metricName      String        // ชื่อเมตริก
  category        String        // หมวดหมู่
  period          String        // ช่วงเวลา
  
  // ค่าการเปรียบเทียบ
  hospitalValue   Decimal       // ค่าของโรงพยาบาลนี้
  industryAverage Decimal?      // ค่าเฉลี่ยอุตสาหกรรม
  bestPractice    Decimal?      // ค่า best practice
  percentile      Int?          // อยู่ใน percentile ไหน
  
  // การจัดอันดับ
  ranking         String?       // "EXCELLENT", "GOOD", "AVERAGE", "BELOW_AVERAGE", "POOR"
  improvementGap  Decimal?      // ช่องว่างที่ต้องปรับปรุง
  
  // ข้อเสนะแนะ
  recommendations String?       // ข้อเสนแนะการปรับปรุง
  actionPlan      Json?         // แผนการดำเนินการ
  
  // การติดตาม
  benchmarkedAt   DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([hospitalId, category])
  @@index([metricName])
  @@map("benchmarks")
}

// ==========================================
// AUDIT
// ==========================================

// prisma/schemas/audit.prisma
// Audit and Compliance Schema
// ระบบตรวจสอบและการปฏิบัติตามกฎระเบียบ

enum AuditAction {
  CREATE          // สร้าง
  READ            // อ่าน/ดู
  UPDATE          // แก้ไข
  DELETE          // ลบ
  LOGIN           // เข้าสู่ระบบ
  LOGOUT          // ออกจากระบบ
  APPROVE         // อนุมัติ
  REJECT          // ปฏิเสธ
  SUBMIT          // ส่ง
  CANCEL          // ยกเลิก
  TRANSFER        // โอน
  RECEIVE         // รับ
  DISPENSE        // จ่าย
  ADJUST          // ปรับปรุง
  COUNT           // นับสต็อก
  EXPORT          // ส่งออกข้อมูล
  IMPORT          // นำเข้าข้อมูล
  BACKUP          // สำรองข้อมูล
  RESTORE         // คืนค่าข้อมูล
}

enum AuditLevel {
  LOW             // ความสำคัญต่ำ
  MEDIUM          // ความสำคัญปานกลาง
  HIGH            // ความสำคัญสูง
  CRITICAL        // ความสำคัญวิกฤต
}

enum AuditCategory {
  SECURITY        // ความปลอดภัย
  DATA_ACCESS     // การเข้าถึงข้อมูล
  FINANCIAL       // การเงิน
  INVENTORY       // สต็อก
  USER_MANAGEMENT // การจัดการผู้ใช้
  SYSTEM_CONFIG   // การตั้งค่าระบบ
  COMPLIANCE      // การปฏิบัติตามกฎ
  PERFORMANCE     // ประสิทธิภาพ
}

model AuditLog {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  userId          String?
  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // ข้อมูลการตรวจสอบ
  action          AuditAction
  category        AuditCategory
  level           AuditLevel    @default(MEDIUM)
  
  // เป้าหมายของการกระทำ
  tableName       String?       // ชื่อตาราง
  recordId        String?       // ID ของเรคอร์ด
  resourceType    String?       // ประเภทข้อมูล
  resourceName    String?       // ชื่อข้อมูล
  
  // รายละเอียดการเปลี่ยนแปลง
  oldValues       Json?         // ค่าเดิม (ก่อนการเปลี่ยนแปลง)
  newValues       Json?         // ค่าใหม่ (หลังการเปลี่ยนแปลง)
  changedFields   String[]      // ฟิลด์ที่มีการเปลี่ยนแปลง
  
  // บริบทการกระทำ
  description     String        // คำอธิบายการกระทำ
  reason          String?       // เหตุผล
  notes           String?       // หมายเหตุเพิ่มเติม
  
  // ข้อมูลเทคนิค
  ipAddress       String?       // IP Address
  userAgent       String?       // User Agent
  sessionId       String?       // Session ID
  requestId       String?       // Request ID
  
  // ข้อมูลระบบ
  systemVersion   String?       // เวอร์ชั่นระบบ
  moduleVersion   String?       // เวอร์ชั่นโมดูล
  
  // ผลลัพธ์
  success         Boolean       @default(true)
  errorMessage    String?       // ข้อความข้อผิดพลาด
  duration        Int?          // ระยะเวลาดำเนินการ (ms)
  
  // การติดตาม
  timestamp       DateTime      @default(now())
  
  @@index([hospitalId, timestamp])
  @@index([userId, timestamp])
  @@index([action])
  @@index([category, level])
  @@index([tableName, recordId])
  @@map("audit_logs")
}

// การติดตามการเข้าถึงข้อมูลที่สำคัญ
model DataAccessLog {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการเข้าถึง
  dataType        String        // ประเภทข้อมูล
  dataId          String        // ID ของข้อมูล
  dataCategory    String        // หมวดหมู่ข้อมูล
  
  // วิธีการเข้าถึง
  accessMethod    String        // "API", "WEB", "EXPORT", "REPORT"
  accessLevel     String        // "READ", "WRITE", "DELETE", "ADMIN"
  
  // ข้อมูลที่เข้าถึง
  fieldsAccessed  String[]      // ฟิลด์ที่เข้าถึง
  recordCount     Int?          // จำนวนเรคอร์ดที่เข้าถึง
  
  // บริบท
  purpose         String?       // วัตถุประสงค์การเข้าถึง
  justification   String?       // เหตุผลความจำเป็น
  
  // การควบคุม
  approvedBy      String?       // ผู้อนุมัติ (สำหรับข้อมูลที่ต้องขออนุมัติ)
  approvalRef     String?       // เลขที่อนุมัติ
  
  // ข้อมูลเทคนิค
  ipAddress       String
  userAgent       String?
  
  // การติดตาม
  accessedAt      DateTime      @default(now())
  duration        Int?          // ระยะเวลาการเข้าถึง (วินาที)
  
  @@index([hospitalId, userId])
  @@index([dataType, dataId])
  @@index([accessedAt])
  @@map("data_access_logs")
}

enum ComplianceType {
  FDA_THAILAND    // กฎหมายอย.ไทย
  PHARMACY_ACT    // พระราชบัญญัติเภสัชกรรม
  NARCOTIC_ACT    // พระราชบัญญัติยาเสพติด
  HOSPITAL_ACCREDITATION // การรับรองโรงพยาบาล
  INTERNAL_POLICY // นโยบายภายใน
  QUALITY_STANDARD // มาตรฐานคุณภาพ
  GDPR            // GDPR (สำหรับข้อมูลส่วนบุคคล)
  HIPAA           // HIPAA (สำหรับโรงพยาบาลในอเมริกา)
}

enum ComplianceStatus {
  COMPLIANT       // ปฏิบัติตามครบถ้วน
  PARTIAL_COMPLIANT // ปฏิบัติตามบางส่วน
  NON_COMPLIANT   // ไม่ปฏิบัติตาม
  UNDER_REVIEW    // อยู่ระหว่างการตรวจสอบ
  PENDING_ACTION  // รอการดำเนินการ
  EXEMPTED        // ได้รับการยกเว้น
}

model ComplianceCheck {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการตรวจสอบ
  checkName       String          // ชื่อการตรวจสอบ
  complianceType  ComplianceType
  regulationRef   String?         // อ้างอิงกฎหมาย/ระเบียบ
  
  // ช่วงเวลา
  checkPeriod     String          // ช่วงเวลาการตรวจสอบ
  fromDate        DateTime
  toDate          DateTime
  
  // ผลการตรวจสอบ
  status          ComplianceStatus
  score           Decimal?        // คะแนนการปฏิบัติตาม (0-100)
  
  // รายละเอียด
  criteria        Json            // เกณฑ์การตรวจสอบ
  findings        Json            // ผลการตรวจพบ
  violations      Json?           // การละเมิดที่พบ
  recommendations Json?           // ข้อเสนะแนะ
  
  // การดำเนินการ
  actionPlan      Json?           // แผนการแก้ไข
  actionDeadline  DateTime?       // กำหนดเวลาการแก้ไข
  actionTaken     Json?           // การดำเนินการที่ทำแล้ว
  
  // ผู้รับผิดชอบ
  checkedBy       String
  checker         User      @relation("ComplianceChecker", fields: [checkedBy], references: [id], onDelete: Restrict)
  reviewedBy      String?
  reviewer        User?     @relation("ComplianceReviewer", fields: [reviewedBy], references: [id], onDelete: Restrict)
  
  // การติดตาม
  checkDate       DateTime        @default(now())
  dueDate         DateTime?       // วันที่ต้องตรวจสอบครั้งต่อไป
  isRecurring     Boolean         @default(false)
  frequency       String?         // ความถี่การตรวจสอบ
  
  @@index([hospitalId, complianceType])
  @@index([status])
  @@index([checkDate])
  @@map("compliance_checks")
}

// การติดตามยาเสพติดและยาควบคุม
model ControlledSubstanceLog {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการเคลื่อนไหว
  transactionType String        // "RECEIVE", "DISPENSE", "TRANSFER", "DISPOSE", "ADJUST"
  quantity        Int
  unit            String
  
  // ข้อมูล batch
  batchNumber     String
  expiryDate      DateTime
  
  // ผู้เกี่ยวข้อง
  handledBy       String
  handler         User      @relation("CSLHandler", fields: [handledBy], references: [id], onDelete: Restrict)
  witnessedBy     String?
  witness         User?     @relation("CSLWitness", fields: [witnessedBy], references: [id], onDelete: Restrict)
  authorizedBy    String?
  authorizer      User?     @relation("CSLAuthorizer", fields: [authorizedBy], references: [id], onDelete: Restrict)
  
  // เอกสารอ้างอิง
  referenceDoc    String?       // เลขที่เอกสารอ้างอิง
  prescription    String?       // ใบสั่งแพทย์ (สำหรับการจ่าย)
  patientId       String?       // รหัสผู้ป่วย (ถ้ามี)
  
  // ข้อมูลเพิ่มเติม
  purpose         String?       // วัตถุประสงค์
  notes           String?       // หมายเหตุ
  
  // การรักษาความปลอดภัย
  vaultLocation   String?       // ตำแหน่งเก็บในตู้นิรภัย
  lockSerial      String?       // เลขล็อค/ซีล
  
  // การติดตาม
  transactionDate DateTime      @default(now())
  reportedToAuthority Boolean   @default(false) // รายงานหน่วยงานแล้วหรือไม่
  reportDate      DateTime?     // วันที่รายงาน
  
  @@index([hospitalId, drugId])
  @@index([handledBy])
  @@index([transactionDate])
  @@map("controlled_substance_logs")
}

// การตรวจสอบภายใน
model InternalAudit {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการตรวจสอบ
  auditName       String        // ชื่อการตรวจสอบ
  auditType       String        // "SCHEDULED", "SURPRISE", "FOLLOW_UP", "COMPLAINT_BASED"
  scope           String        // ขอบเขตการตรวจสอบ
  objectives      Json          // วัตถุประสงค์
  
  // ช่วงเวลา
  plannedDate     DateTime      // วันที่วางแผน
  startDate       DateTime?     // วันที่เริ่มตรวจสอบ
  endDate         DateTime?     // วันที่สิ้นสุด
  
  // ผู้ตรวจสอบ
  auditorId       String
  auditor         User          @relation(fields: [auditorId], references: [id], onDelete: Restrict)
  auditTeam       String[]      // ทีมตรวจสอบ (User IDs)
  
  // ผลการตรวจสอบ
  status          String        @default("PLANNED") // "PLANNED", "IN_PROGRESS", "COMPLETED", "CANCELLED"
  findings        Json?         // ผลการตรวจพบ
  recommendations Json?         // ข้อเสนะแนะ
  riskAssessment  Json?         // การประเมินความเสี่ยง
  
  // การติดตามผล
  actionItems     Json?         // รายการการดำเนินการ
  followUpDate    DateTime?     // วันที่ติดตามผล
  managementResponse Json?      // การตอบสนองของฝ่ายบริหาร
  
  // เอกสาร
  reportUrl       String?       // URL ของรายงาน
  evidenceUrls    String[]      // URLs ของหลักฐาน
  
  // การติดตาม
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([hospitalId, status])
  @@index([auditorId])
  @@index([plannedDate])
  @@map("internal_audits")
}

// การติดตามข้อผิดพลาดและเหตุการณ์
model SecurityIncident {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลเหตุการณ์
  incidentType    String        // "UNAUTHORIZED_ACCESS", "DATA_BREACH", "SYSTEM_ABUSE", "POLICY_VIOLATION"
  severity        String        // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  title           String        // หัวข้อเหตุการณ์
  description     String        // รายละเอียด
  
  // ผู้เกี่ยวข้อง
  reportedBy      String
  reporter        User      @relation("SecurityReporter", fields: [reportedBy], references: [id], onDelete: Restrict)
  suspectedUserId String?
  suspectedUser   User?     @relation("SuspectedUser", fields: [suspectedUserId], references: [id], onDelete: Restrict)
  
  // เวลาและสถานที่
  occurredAt      DateTime      // เวลาที่เกิดเหตุ
  detectedAt      DateTime      @default(now()) // เวลาที่ตรวจพบ
  location        String?       // สถานที่
  ipAddress       String?       // IP Address
  
  // ผลกระทบ
  affectedSystems String[]      // ระบบที่ได้รับผลกระทบ
  affectedData    String[]      // ข้อมูลที่ได้รับผลกระทบ
  impactLevel     String        // ระดับผลกระทบ
  
  // การดำเนินการ
  status          String        @default("REPORTED") // "REPORTED", "INVESTIGATING", "RESOLVED", "CLOSED"
  investigatedBy  String?
  investigator    User?     @relation("Investigator", fields: [investigatedBy], references: [id], onDelete: Restrict)
  actionsTaken    Json?         // การดำเนินการที่ทำ
  resolution      String?       // การแก้ไข
  
  // การป้องกัน
  preventiveMeasures Json?      // มาตรการป้องกัน
  lessonsLearned  String?       // บทเรียนที่ได้
  
  // การติดตาม
  resolvedAt      DateTime?     // เวลาที่แก้ไขเสร็จ
  closedAt        DateTime?     // เวลาที่ปิดเรื่อง
  
  // การรายงาน
  reportedToAuthority Boolean   @default(false) // รายงานหน่วยงานแล้วหรือไม่
  authorityReportDate DateTime? // วันที่รายงานหน่วยงาน
  
  @@index([hospitalId, incidentType])
  @@index([severity])
  @@index([status])
  @@index([occurredAt])
  @@map("security_incidents")
}

// ==========================================
// NOTIFICATIONS
// ==========================================

// prisma/schemas/notifications.prisma
// Notification and Alert Management Schema
// ระบบจัดการการแจ้งเตือนและการแจ้งเตือนอัตโนมัติ

enum NotificationType {
  STOCK_LOW       // สต็อกต่ำ
  STOCK_OUT       // สต็อกหมด
  STOCK_EXPIRY    // ยาใกล้หมดอายุ
  REQUISITION     // เกี่ยวกับใบเบิก
  APPROVAL        // การอนุมัติ
  SYSTEM          // ระบบ
  SECURITY        // ความปลอดภัย
  MAINTENANCE     // การบำรุงรักษา
  AUDIT           // การตรวจสอบ
  QUALITY         // คุณภาพ
  URGENT          // เร่งด่วน
}

enum ChannelType {
  EMAIL     // อีเมล
  SMS       // ข้อความ
  LINE      // LINE
  SLACK     // Slack
  PUSH      // Push notification
  IN_APP    // ในแอปพลิเคชัน
  WEBHOOK   // Webhook
}

enum NotificationStatus {
  PENDING     // รอการส่ง
  SENT        // ส่งแล้ว
  DELIVERED   // ส่งถึงแล้ว
  READ        // อ่านแล้ว
  FAILED      // ล้มเหลว
  EXPIRED     // หมดอายุ
  CANCELLED   // ยกเลิก
}

// การแจ้งเตือนหลัก
model Notification {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital          @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการแจ้งเตือน
  type            NotificationType
  title           String
  message         String
  data            Json?             // ข้อมูลเพิ่มเติม (JSON)
  
  // ความสำคัญ
  priority        Priority          @default(NORMAL)
  
  // ช่องทางการส่ง
  channels        ChannelType[]
  
  // เป้าหมาย
  targetRoles     String[]          // บทบาทเป้าหมาย
  targetUsers     String[]          // ผู้ใช้เป้าหมายเฉพาะ
  targetDepartments String[]        // แผนกเป้าหมาย
  
  // การกำหนดเวลาส่ง
  scheduleAt      DateTime?         // กำหนดเวลาส่ง
  retryCount      Int               @default(0) // จำนวนครั้งที่พยายามส่งใหม่
  maxRetries      Int               @default(3) // จำนวนครั้งสูงสุดที่ลองส่งใหม่
  
  // สถานะ
  status          NotificationStatus @default(PENDING)
  
  // การติดตาม
  createdAt       DateTime          @default(now())
  sentAt          DateTime?         // เวลาที่ส่ง
  deliveredAt     DateTime?         // เวลาที่ส่งถึง
  expiresAt       DateTime?         // เวลาหมดอายุ
  
  // ข้อผิดพลาด
  errorMessage    String?           // ข้อความข้อผิดพลาด
  lastAttemptAt   DateTime?         // ครั้งสุดท้ายที่พยายามส่ง
  
  // Relations - เพิ่ม inverse relations
  recipients      NotificationUser[]
  deliveries      NotificationDelivery[]
  
  @@index([hospitalId, type])
  @@index([status])
  @@index([priority])
  @@index([scheduleAt])
  @@map("notifications")
}

model NotificationUser {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์
  notificationId  String
  notification    Notification      @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // สถานะสำหรับผู้ใช้แต่ละคน
  status          NotificationStatus @default(PENDING)
  channel         ChannelType       // ช่องทางที่ส่งให้ผู้ใช้คนนี้
  
  // การติดตาม
  sentAt          DateTime?         // เวลาที่ส่งให้ผู้ใช้คนนี้
  deliveredAt     DateTime?         // เวลาที่ส่งถึง
  readAt          DateTime?         // เวลาที่อ่าน
  acknowledgedAt  DateTime?         // เวลาที่รับทราบ
  
  // ข้อมูลการส่ง
  recipientAddress String?          // ที่อยู่ปลายทาง (email, phone, etc.)
  errorMessage    String?           // ข้อความข้อผิดพลาด
  
  @@unique([notificationId, userId, channel])
  @@index([userId, status])
  @@index([sentAt])
  @@map("notification_users")
}

// เทมเพลตการแจ้งเตือน
model NotificationTemplate {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital          @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลเทมเพลต
  name            String            // ชื่อเทมเพลต
  code            String            // รหัสเทมเพลต
  type            NotificationType
  
  // เนื้อหา
  titleTemplate   String            // เทมเพลตหัวข้อ
  messageTemplate String            // เทมเพลตข้อความ
  
  // การตั้งค่า
  defaultPriority Priority          @default(NORMAL)
  defaultChannels ChannelType[]
  
  // ตัวแปร
  variables       Json              // ตัวแปรที่ใช้ในเทมเพลต
  
  // การใช้งาน
  isActive        Boolean           @default(true)
  isSystem        Boolean           @default(false) // เทมเพลตระบบ
  
  // การติดตาม
  usageCount      Int               @default(0)
  lastUsedAt      DateTime?
  
  // Audit fields
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  
  // Relations - เพิ่ม inverse relations
  alertRules      AlertRule[]
  
  @@unique([hospitalId, code])
  @@index([type])
  @@map("notification_templates")
}

// การตั้งค่าการแจ้งเตือนของผู้ใช้
model NotificationPreference {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // การตั้งค่าทั่วไป
  enableAll       Boolean           @default(true)
  quietHoursStart String?           // เวลาเริ่มโหมดเงียบ (HH:mm)
  quietHoursEnd   String?           // เวลาสิ้นสุดโหมดเงียบ (HH:mm)
  timezone        String            @default("Asia/Bangkok")
  
  // การตั้งค่าตามประเภท
  stockAlerts     Json              // การตั้งค่าแจ้งเตือนสต็อก
  expiryAlerts    Json              // การตั้งค่าแจ้งเตือนหมดอายุ
  requisitionAlerts Json            // การตั้งค่าแจ้งเตือนใบเบิก
  systemAlerts    Json              // การตั้งค่าแจ้งเตือนระบบ
  
  // ช่องทางที่ต้องการ
  preferredChannels ChannelType[]
  
  // ข้อมูลติดต่อ
  email           String?           // อีเมลสำหรับแจ้งเตือน
  phoneNumber     String?           // เบอร์โทรสำหรับ SMS
  lineUserId      String?           // LINE User ID
  slackUserId     String?           // Slack User ID
  
  // การติดตาม
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@unique([userId])
  @@map("notification_preferences")
}

// กฎการแจ้งเตือนอัตโนมัติ
model AlertRule {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital          @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลกฎ
  name            String            // ชื่อกฎ
  description     String?           // คำอธิบาย
  type            NotificationType
  
  // เงื่อนไข
  conditions      Json              // เงื่อนไขการแจ้งเตือน
  threshold       Json?             // ค่าขีดจำกัด
  
  // การดำเนินการ
  actions         Json              // การดำเนินการเมื่อเข้าเงื่อนไข
  templateId      String?           // เทมเพลตที่ใช้
  template        NotificationTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  // เป้าหมาย
  targetRoles     String[]          // บทบาทเป้าหมาย
  targetUsers     String[]          // ผู้ใช้เป้าหมาย
  targetDepartments String[]        // แผนกเป้าหมาย
  
  // การตั้งค่า
  priority        Priority          @default(NORMAL)
  channels        ChannelType[]
  
  // ความถี่
  frequency       String?           // ความถี่การตรวจสอบ
  cooldownPeriod  Int?              // ช่วงเวลาหยุดพัก (นาที)
  
  // สถานะ
  isActive        Boolean           @default(true)
  isSystem        Boolean           @default(false) // กฎระบบ
  
  // การติดตาม
  lastTriggered   DateTime?         // ครั้งสุดท้ายที่ทำงาน
  triggerCount    Int               @default(0) // จำนวนครั้งที่ทำงาน
  
  // Audit fields
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  
  // Relations - เพิ่ม inverse relations
  alertLogs       AlertLog[]
  
  @@index([hospitalId, type])
  @@index([isActive])
  @@map("alert_rules")
}

// บันทึกการแจ้งเตือนที่เกิดขึ้น
model AlertLog {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital          @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  alertRuleId     String?
  alertRule       AlertRule?        @relation(fields: [alertRuleId], references: [id], onDelete: SetNull)
  
  // ข้อมูลการแจ้งเตือน
  alertType       String            // ประเภทการแจ้งเตือน
  message         String            // ข้อความ
  data            Json?             // ข้อมูลเพิ่มเติม
  
  // ความรุนแรง
  severity        String            // "INFO", "WARNING", "ERROR", "CRITICAL"
  priority        Priority
  
  // การตอบสนอง
  isAcknowledged  Boolean           @default(false) // รับทราบแล้ว
  acknowledgedBy  String?           // ผู้รับทราบ
  acknowledgedAt  DateTime?         // เวลาที่รับทราบ
  response        String?           // การตอบสนอง
  
  // การแก้ไข
  isResolved      Boolean           @default(false) // แก้ไขแล้ว
  resolvedBy      String?           // ผู้แก้ไข
  resolvedAt      DateTime?         // เวลาที่แก้ไข
  resolution      String?           // วิธีการแก้ไข
  
  // การติดตาม
  triggeredAt     DateTime          @default(now())
  
  @@index([hospitalId, alertType])
  @@index([severity])
  @@index([isAcknowledged])
  @@index([triggeredAt])
  @@map("alert_logs")
}

// การตั้งค่าช่องทางการแจ้งเตือน
model NotificationChannel {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital          @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลช่องทาง
  name            String            // ชื่อช่องทาง
  type            ChannelType
  
  // การตั้งค่า
  config          Json              // การตั้งค่าเฉพาะช่องทาง
  credentials     Json?             // ข้อมูลรับรอง (encrypted)
  
  // สถานะ
  isActive        Boolean           @default(true)
  isDefault       Boolean           @default(false) // ช่องทางหลัก
  
  // การทดสอบ
  lastTestAt      DateTime?         // ครั้งสุดท้ายที่ทดสอบ
  testResult      String?           // ผลการทดสอบ
  
  // สถิติ
  totalSent       Int               @default(0) // จำนวนที่ส่งทั้งหมด
  successRate     Decimal?          // อัตราความสำเร็จ
  
  // Audit fields
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  
  // Relations - เพิ่ม inverse relations
  deliveries      NotificationDelivery[]
  
  @@unique([hospitalId, type, name])
  @@index([type])
  @@map("notification_channels")
}

// บันทึกการส่งการแจ้งเตือน
model NotificationDelivery {
  id              String            @id @default(uuid())
  
  // ความสัมพันธ์
  notificationId  String
  notification    Notification      @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  channelId       String?
  channel         NotificationChannel? @relation(fields: [channelId], references: [id], onDelete: SetNull)
  
  // ข้อมูลการส่ง
  channelType     ChannelType
  recipient       String            // ที่อยู่ปลายทาง
  
  // สถานะ
  status          NotificationStatus
  
  // การลองส่งใหม่
  attempts        Int               @default(0)
  lastAttemptAt   DateTime?
  nextRetryAt     DateTime?
  
  // ข้อมูลการส่ง
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?
  
  // ข้อมูลเทคนิค
  messageId       String?           // ID จากระบบภายนอก
  response        Json?             // การตอบกลับจากระบบภายนอก
  errorCode       String?           // รหัสข้อผิดพลาด
  errorMessage    String?           // ข้อความข้อผิดพลาด
  
  // การติดตาม
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([notificationId])
  @@index([status])
  @@index([channelType])
  @@map("notification_deliveries")
}

// ==========================================
// SHARED ENUMS
// ==========================================

// prisma/schemas/shared-enums.prisma
// Shared Enums Schema
// Enums ที่ใช้ร่วมกันในหลายโมดูล - ต้อง load ก่อนไฟล์อื่นทั้งหมด

// ระดับความสำคัญ - ใช้ในทุกระบบ
enum Priority {
  LOW             // ความสำคัญต่ำ
  NORMAL          // ความสำคัญปกติ
  HIGH            // ความสำคัญสูง
  URGENT          // เร่งด่วน
  CRITICAL        // วิกฤต
}

// สถานะการอนุมัติ - ใช้ในหลายระบบ
enum ApprovalStatus {
  PENDING         // รอการอนุมัติ
  APPROVED        // อนุมัติแล้ว
  REJECTED        // ปฏิเสธ
  CANCELLED       // ยกเลิก
  EXPIRED         // หมดเวลา
}

// สถานะการใช้งานทั่วไป
enum ActiveStatus {
  ACTIVE          // ใช้งานปกติ
  INACTIVE        // ไม่ใช้งานชั่วคราว
  SUSPENDED       // ระงับการใช้งาน
  DELETED         // ลบแล้ว (soft delete)
}

// สกุลเงิน
enum Currency {
  THB             // บาทไทย
  USD             // ดอลลาร์สหรัฐ
  EUR             // ยูโร
  JPY             // เยนญี่ปุ่น
}

// ช่วงเวลา - ใช้ในการรายงานและวิเคราะห์
enum TimePeriod {
  HOURLY          // รายชั่วโมง
  DAILY           // รายวัน
  WEEKLY          // รายสัปดาห์
  MONTHLY         // รายเดือน
  QUARTERLY       // รายไตรมาส
  YEARLY          // รายปี
}

// ประเภทเอกสาร
enum DocumentType {
  PDF             // ไฟล์ PDF
  EXCEL           // ไฟล์ Excel
  WORD            // ไฟล์ Word
  IMAGE           // รูปภาพ
  CSV             // ไฟล์ CSV
  JSON            // ไฟล์ JSON
  XML             // ไฟล์ XML
  OTHER           // อื่นๆ
}
