// prisma/schemas/notifications.prisma
// Notification Management Schema
// ระบบจัดการการแจ้งเตือนสำหรับ Hospital Pharmacy System

enum NotificationType {
  STOCK_LOW           // สต็อกต่ำ
  STOCK_OUT           // สต็อกหมด
  STOCK_EXPIRED       // ยาหมดอายุ
  STOCK_EXPIRING      // ยาใกล้หมดอายุ
  REQUISITION_PENDING // ใบเบิกรอดำเนินการ
  REQUISITION_APPROVED // ใบเบิกอนุมัติแล้ว
  REQUISITION_REJECTED // ใบเบิกปฏิเสธ
  PO_CREATED          // สร้าง PO แล้ว
  PO_APPROVED         // PO อนุมัติแล้ว
  GOODS_RECEIVED      // รับของแล้ว
  COMPLIANCE_ALERT    // การแจ้งเตือนการปฏิบัติตาม
  SECURITY_ALERT      // การแจ้งเตือนความปลอดภัย
  SYSTEM_MAINTENANCE  // บำรุงรักษาระบบ
  USER_CREATED        // สร้างผู้ใช้ใหม่
  PASSWORD_RESET      // รีเซ็ตรหัสผ่าน
}

enum NotificationPriority {
  LOW                 // ต่ำ
  NORMAL              // ปกติ
  HIGH                // สูง
  URGENT              // เร่งด่วน
}

enum NotificationStatus {
  PENDING             // รอส่ง
  SENT                // ส่งแล้ว
  DELIVERED           // ส่งถึงแล้ว
  READ                // อ่านแล้ว
  FAILED              // ส่งไม่สำเร็จ
}

model Notification {
  id              String              @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital            @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลการแจ้งเตือน
  type            NotificationType
  priority        NotificationPriority @default(NORMAL)
  title           String
  message         String
  
  // การอ้างอิง
  referenceType   String?             // "DRUG", "REQUISITION", "PURCHASE_ORDER", etc.
  referenceId     String?             // ID ของข้อมูลที่อ้างอิง
  
  // การกำหนดเป้าหมาย
  targetRoles     String[]            // บทบาทเป้าหมาย
  targetUsers     Json?               // ผู้ใช้เฉพาะ (array of user IDs)
  targetDepartments Json?             // แผนกเป้าหมาย (array of department IDs)
  
  // การส่ง
  sendEmail       Boolean             @default(false)
  sendSMS         Boolean             @default(false)
  sendPush        Boolean             @default(true)
  sendInApp       Boolean             @default(true)
  
  // กำหนดการ
  scheduledAt     DateTime?           // เวลาที่กำหนดส่ง
  sentAt          DateTime?           // เวลาที่ส่งจริง
  expiresAt       DateTime?           // เวลาหมดอายุ
  
  // สถานะ
  status          NotificationStatus  @default(PENDING)
  
  // การติดตาม
  totalRecipients Int                 @default(0)
  readCount       Int                 @default(0)
  clickCount      Int                 @default(0)
  
  // ข้อมูลเพิ่มเติม
  metadata        Json?               // ข้อมูลเพิ่มเติม
  actionUrl       String?             // URL สำหรับการกระทำ
  
  // Audit fields
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  users           NotificationUser[]
  
  @@index([hospitalId])
  @@index([type])
  @@index([priority])
  @@index([status])
  @@index([scheduledAt])
  @@map("notifications")
}

model NotificationUser {
  id              String              @id @default(uuid())
  
  // ความสัมพันธ์
  notificationId  String
  notification    Notification        @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // สถานะการส่ง
  emailSent       Boolean             @default(false)
  smsSent         Boolean             @default(false)
  pushSent        Boolean             @default(false)
  inAppSent       Boolean             @default(false)
  
  // การอ่าน
  isRead          Boolean             @default(false)
  readAt          DateTime?
  
  // การกระทำ
  isClicked       Boolean             @default(false)
  clickedAt       DateTime?
  
  // การส่ง
  deliveredAt     DateTime?
  failedAt        DateTime?
  failureReason   String?
  
  @@unique([notificationId, userId])
  @@index([userId])
  @@index([isRead])
  @@map("notification_users")
}

model NotificationPreference {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ประเภทการแจ้งเตือน
  notificationType NotificationType
  
  // ช่องทางการแจ้งเตือน
  enableEmail     Boolean     @default(true)
  enableSMS       Boolean     @default(false)
  enablePush      Boolean     @default(true)
  enableInApp     Boolean     @default(true)
  
  // เวลาการแจ้งเตือน
  quietHoursStart String?     // เวลาเริ่มช่วงเงียบ (HH:mm)
  quietHoursEnd   String?     // เวลาสิ้นสุดช่วงเงียบ (HH:mm)
  weekendEnabled  Boolean     @default(true)
  
  // การกรอง
  minimumPriority NotificationPriority @default(NORMAL)
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@unique([userId, notificationType])
  @@index([userId])
  @@map("notification_preferences")
}