// prisma/schemas/requisitions.prisma - Enhanced with Signature Fields
// Requisition Management Schema
// ระบบจัดการการเบิกจ่ายยาสำหรับ Hospital Pharmacy System

enum RequisitionStatus {
  DRAFT           // ร่าง
  SUBMITTED       // ส่งแล้ว
  UNDER_REVIEW    // อยู่ระหว่างตรวจสอบ
  APPROVED        // อนุมัติแล้ว
  PARTIALLY_FILLED // จ่ายบางส่วน
  COMPLETED       // เสร็จสิ้น
  CANCELLED       // ยกเลิก
  REJECTED        // ปฏิเสธ
}

enum RequisitionType {
  REGULAR         // การเบิกปกติ
  EMERGENCY       // การเบิกฉุกเฉิน
  SCHEDULED       // การเบิกตามตารางเวลา
  RETURN          // การส่งคืนยา
}

enum RequisitionPriority {
  LOW             // ความสำคัญต่ำ
  NORMAL          // ปกติ
  HIGH            // สูง
  URGENT          // เร่งด่วน
}

model Requisition {
  id              String              @id @default(uuid())
  
  // ความสัมพันธ์หลัก
  hospitalId      String
  hospital        Hospital            @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  deliveryNotes           DeliveryNote[]
  emergencyFromOriginal   EmergencyRequisition[] @relation("EmergencyFromOriginal")
  originalForEmergency    EmergencyRequisition[]
  progressiveDeliveries ProgressiveDelivery[]
  
  // แผนกที่เบิก
  requestingDepartmentId String
  requestingDepartment   Department   @relation("RequestingDepartment", fields: [requestingDepartmentId], references: [id], onDelete: Cascade)
  
  // คลังที่จ่าย
  fulfillmentWarehouseId String
  fulfillmentWarehouse   Warehouse    @relation("FulfillmentWarehouse", fields: [fulfillmentWarehouseId], references: [id], onDelete: Cascade)
  
  // หมายเลขใบเบิก
  requisitionNumber   String          @unique
  referenceNumber     String?         // หมายเลขอ้างอิง
  
  // ประเภทและสถานะ
  type                RequisitionType
  status              RequisitionStatus @default(DRAFT)
  priority            RequisitionPriority @default(NORMAL)
  
  // วันที่สำคัญ
  requestedDate       DateTime        @default(now())
  requiredDate        DateTime        // วันที่ต้องการ
  approvedDate        DateTime?       // วันที่อนุมัติ
  fulfilledDate       DateTime?       // วันที่จ่ายเสร็จ
  
  // ================================
  // ENHANCED SIGNATURE SYSTEM
  // ================================
  
  // 1. ผู้เบิก (Requester)
  requesterId         String
  requester           User            @relation("RequesterRelation", fields: [requesterId], references: [id], onDelete: Restrict)
  requesterSignature  String?         // ลายเซ็นดิจิทัล หรือ hash
  requesterSignedAt   DateTime?       // วันที่ลงชื่อ
  requesterName       String?         // ชื่อ-สกุล ที่แสดงในใบ
  requesterPosition   String?         // ตำแหน่งที่แสดงในใบ
  
  // 2. ผู้อนุมัติ (Approver)
  approverId          String?
  approver            User?           @relation("ApproverRelation", fields: [approverId], references: [id], onDelete: Restrict)
  approverSignature   String?         // ลายเซ็นดิจิทัล
  approverSignedAt    DateTime?       // วันที่อนุมัติและลงชื่อ
  approverName        String?         // ชื่อ-สกุล ผู้อนุมัติ
  approverPosition    String?         // ตำแหน่งผู้อนุมัติ
  
  // 3. ผู้จ่าย (Dispenser/Fulfiller)
  fulfillerId         String?
  fulfiller           User?           @relation("FulfillerRelation", fields: [fulfillerId], references: [id], onDelete: Restrict)
  fulfillerSignature  String?         // ลายเซ็นผู้จ่าย
  fulfillerSignedAt   DateTime?       // วันที่จ่ายและลงชื่อ
  fulfillerName       String?         // ชื่อ-สกุล ผู้จ่าย
  fulfillerPosition   String?         // ตำแหน่งผู้จ่าย
  
  // 4. ผู้รับ (Receiver)
  receiverId          String?
  receiver            User?           @relation("ReceiverRelation", fields: [receiverId], references: [id], onDelete: Restrict)
  receiverSignature   String?         // ลายเซ็นผู้รับ
  receiverSignedAt    DateTime?       // วันที่รับและลงชื่อ
  receiverName        String?         // ชื่อ-สกุล ผู้รับ
  receiverPosition    String?         // ตำแหน่งผู้รับ
  
  // ================================
  // WORKFLOW TRACKING
  // ================================
  
  // การติดตาม workflow state
  workflowStage       String          @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, DISPENSED, RECEIVED
  nextActionRequired  String?         // บอกว่าต้องทำอะไรต่อไป
  nextActionBy        String?         // ใครต้องทำ action ต่อไป
  
  // สรุปใบเบิก
  totalItems          Int             @default(0)
  totalRequestedQty   Int             @default(0)
  totalApprovedQty    Int             @default(0)
  totalFulfilledQty   Int             @default(0)
  estimatedValue      Decimal         @default(0)
  actualValue         Decimal         @default(0)
  
  // หมายเหตุ
  requestNotes        String?         // หมายเหตุผู้เบิก
  approvalNotes       String?         // หมายเหตุผู้อนุมัติ
  fulfillmentNotes    String?         // หมายเหตุผู้จ่าย
  receivingNotes      String?         // หมายเหตุผู้รับ
  
  // การตั้งค่า
  isUrgent            Boolean         @default(false)
  requiresApproval    Boolean         @default(true)
  autoApproveLimit    Decimal?        // จำนวนเงินที่อนุมัติอัตโนมัติได้
  
  // สถานะพิเศษ
  isPartiallyFulfilled Boolean        @default(false)
  isFullyReceived     Boolean         @default(false)
  hasDiscrepancies    Boolean         @default(false) // มีความผิดปกติ
  
  // Audit fields
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  createdBy           String
  creator             User            @relation("RequisitionCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  
  // ความสัมพันธ์
  items               RequisitionItem[]
  workflows           RequisitionWorkflow[]
  attachments         RequisitionAttachment[]
  stockTransactions   StockTransaction[]  // ✅ เพิ่ม back-reference
  
  @@index([hospitalId])
  @@index([requestingDepartmentId])
  @@index([fulfillmentWarehouseId])
  @@index([status])
  @@index([workflowStage])
  @@index([requestedDate])
  @@index([requiredDate])
  @@index([requesterId])
  @@index([approverId])
  @@index([fulfillerId])
  @@index([receiverId])
  @@map("requisitions")
}

// รายการยาในใบเบิก (แก้ไขเพิ่ม drugId field)
model RequisitionItem {
  id                  String          @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId       String
  requisition         Requisition     @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  drugId              String          // ✅ เพิ่ม field นี้
  drug                Drug            @relation(fields: [drugId], references: [id], onDelete: Restrict)
  stockCardId         String
  stockCard           StockCard       @relation(fields: [stockCardId], references: [id], onDelete: Restrict)
  
  // จำนวนและสถานะ
  requestedQuantity   Int
  approvedQuantity    Int?
  fulfilledQuantity   Int             @default(0)
  unitPrice           Decimal?
  totalValue          Decimal?
  
  // การจัดการ batch
  preferredBatchId    String?
  preferredBatch      StockBatch?     @relation("PreferredBatch", fields: [preferredBatchId], references: [id], onDelete: SetNull)
  actualBatches       Json?           // บันทึกการจ่ายจาก batch ต่างๆ
  
  // สถานะรายการ
  status              String          @default("PENDING") // PENDING, APPROVED, PARTIALLY_FULFILLED, FULFILLED, CANCELLED
  priority            Int             @default(1)         // ลำดับความสำคัญ
  
  // หมายเหตุ
  notes               String?
  fulfillmentNotes    String?         // หมายเหตุการจ่าย
  
  // การติดตาม
  requestedAt         DateTime        @default(now())
  approvedAt          DateTime?
  fulfilledAt         DateTime?
  
  // Audit fields
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  // ✅ Relations - เพิ่ม back-reference
  progressiveDeliveryItems ProgressiveDeliveryItem[]
  
  @@index([requisitionId])
  @@index([drugId])  // ✅ เพิ่ม index
  @@index([stockCardId])
  @@index([status])
  @@map("requisition_items")
}

// การติดตาม workflow (ไม่เปลี่ยนแปลง)
model RequisitionWorkflow {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId   String
  requisition     Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  // การเปลี่ยนแปลงสถานะ
  fromStatus      String?     // สถานะเดิม
  toStatus        String      // สถานะใหม่
  action          String      // การกระทำ เช่น SUBMIT, APPROVE, REJECT, FULFILL
  
  // ผู้ดำเนินการ
  actionBy        String
  actor           User        @relation(fields: [actionBy], references: [id], onDelete: Restrict)
  
  // รายละเอียด
  notes           String?
  reason          String?     // เหตุผล (สำหรับการปฏิเสธ)
  attachments     Json?       // ไฟล์แนบ
  
  // การติดตาม
  actionAt        DateTime    @default(now())
  
  // Audit fields
  createdAt       DateTime    @default(now())
  
  @@index([requisitionId])
  @@index([actionBy])
  @@index([actionAt])
  @@map("requisition_workflows")
}

// ไฟล์แนบ (ไม่เปลี่ยนแปลง)
model RequisitionAttachment {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId   String
  requisition     Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  uploadedBy      String
  uploader        User        @relation(fields: [uploadedBy], references: [id], onDelete: Restrict)
  
  // ข้อมูลไฟล์
  fileName        String
  originalName    String
  filePath        String
  fileSize        Int
  mimeType        String
  
  // ประเภทเอกสาร
  category        String?     // "PRESCRIPTION", "AUTHORIZATION", "SUPPORTING_DOC", "OTHER"
  
  // สถานะ
  isActive        Boolean     @default(true)
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([requisitionId])
  @@index([uploadedBy])
  @@map("requisition_attachments")
}

// Template สำหรับการเบิกประจำ (ไม่เปลี่ยนแปลง)
model RequisitionTemplate {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  departmentId    String
  department      Department  @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  createdBy       String
  creator         User        @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  
  // ข้อมูลเทมเพลต
  templateName    String
  description     String?
  
  // การตั้งค่า
  type            RequisitionType
  priority        RequisitionPriority @default(NORMAL)
  isRecurring     Boolean     @default(false)
  recurringPattern String?    // "DAILY", "WEEKLY", "MONTHLY", "CUSTOM"
  
  // รายการยา (JSON)
  items           Json        // array of {drugId, requestedQty, notes}
  
  // สถานะ
  isActive        Boolean     @default(true)
  
  // การใช้งาน
  usageCount      Int         @default(0)
  lastUsedAt      DateTime?
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([hospitalId])
  @@index([departmentId])
  @@index([createdBy])
  @@map("requisition_templates")
}