// prisma/schemas/requisitions.prisma
// Requisition Management Schema
// ระบบจัดการการเบิกจ่ายยาสำหรับ Hospital Pharmacy System

enum RequisitionStatus {
  DRAFT           // ร่าง
  SUBMITTED       // ส่งแล้ว
  UNDER_REVIEW    // อยู่ระหว่างตรวจสอบ
  APPROVED        // อนุมัติแล้ว
  PARTIALLY_FILLED // จ่ายบางส่วน
  COMPLETED       // เสร็จสิ้น
  CANCELLED       // ยกเลิก
  REJECTED        // ปฏิเสธ
}

enum RequisitionType {
  REGULAR         // การเบิกปกติ
  EMERGENCY       // การเบิกฉุกเฉิน
  SCHEDULED       // การเบิกตามตารางเวลา
  RETURN          // การส่งคืนยา
}

enum RequisitionPriority {
  LOW             // ความสำคัญต่ำ
  NORMAL          // ปกติ
  HIGH            // สูง
  URGENT          // เร่งด่วน
}

model Requisition {
  id              String              @id @default(uuid())
  
  // ความสัมพันธ์หลัก
  hospitalId      String
  hospital        Hospital            @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // แผนกที่เบิก
  requestingDepartmentId String
  requestingDepartment   Department   @relation("RequestingDepartment", fields: [requestingDepartmentId], references: [id], onDelete: Cascade)
  
  // คลังที่จ่าย
  fulfillmentWarehouseId String
  fulfillmentWarehouse   Warehouse    @relation("FulfillmentWarehouse", fields: [fulfillmentWarehouseId], references: [id], onDelete: Cascade)
  
  // หมายเลขใบเบิก
  requisitionNumber   String          @unique
  referenceNumber     String?         // หมายเลขอ้างอิง
  
  // ประเภทและสถานะ
  type                RequisitionType
  status              RequisitionStatus @default(DRAFT)
  priority            RequisitionPriority @default(NORMAL)
  
  // วันที่สำคัญ
  requestedDate       DateTime        @default(now())
  requiredDate        DateTime        // วันที่ต้องการ
  approvedDate        DateTime?       // วันที่อนุมัติ
  fulfilledDate       DateTime?       // วันที่จ่ายเสร็จ
  
  // ผู้รับผิดชอบ
  requesterId         String
  requester           User            @relation("RequesterRelation", fields: [requesterId], references: [id], onDelete: Restrict)
  approverId          String?
  approver            User?           @relation("ApproverRelation", fields: [approverId], references: [id], onDelete: Restrict)
  fulfillerId         String?
  fulfiller           User?           @relation("FulfillerRelation", fields: [fulfillerId], references: [id], onDelete: Restrict)
  
  // สรุปใบเบิก
  totalItems          Int             @default(0)
  totalRequestedQty   Int             @default(0)
  totalApprovedQty    Int             @default(0)
  totalFulfilledQty   Int             @default(0)
  estimatedValue      Decimal         @default(0)
  actualValue         Decimal         @default(0)
  
  // หมายเหตุ
  requestNotes        String?         // หมายเหตุการเบิก
  approvalNotes       String?         // หมายเหตุการอนุมัติ
  fulfillmentNotes    String?         // หมายเหตุการจ่าย
  rejectionReason     String?         // เหตุผลการปฏิเสธ
  
  // การติดตาม
  isUrgent            Boolean         @default(false)
  isRecurring         Boolean         @default(false)
  recurringPattern    String?         // รูปแบบการเบิกประจำ
  
  // Audit fields
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  // ================================
  // RELATIONS (Fixed opposite fields)
  // ================================
  items               RequisitionItem[]
  workflow            RequisitionWorkflow[]
  transactions        StockTransaction[] // Fixed: เพิ่ม relation กลับ
  attachments         RequisitionAttachment[]
  
  @@index([hospitalId])
  @@index([requestingDepartmentId])
  @@index([fulfillmentWarehouseId])
  @@index([status])
  @@index([requestedDate])
  @@index([priority])
  @@map("requisitions")
}

model RequisitionItem {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId   String
  requisition     Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug        @relation(fields: [drugId], references: [id], onDelete: Cascade)
  stockCardId     String?
  stockCard       StockCard?  @relation(fields: [stockCardId], references: [id], onDelete: SetNull)
  
  // จำนวน
  requestedQty    Int         // จำนวนที่เบิก
  approvedQty     Int?        // จำนวนที่อนุมัติ
  fulfilledQty    Int         @default(0) // จำนวนที่จ่ายแล้ว
  
  // ราคา
  unitCost        Decimal?    // ต้นทุนต่อหน่วย
  totalCost       Decimal     @default(0) // ต้นทุนรวม
  
  // สถานะรายการ
  status          String      @default("PENDING") // "PENDING", "APPROVED", "PARTIAL", "COMPLETED", "CANCELLED"
  
  // การระบุ batch (สำหรับการจ่าย)
  preferredBatch  String?     // batch ที่ต้องการ
  actualBatches   Json?       // batch ที่จ่ายจริง (array of {batchId, quantity})
  
  // หมายเหตุ
  requestNotes    String?     // หมายเหตุการเบิก
  approvalNotes   String?     // หมายเหตุการอนุมัติ
  fulfillmentNotes String?    // หมายเหตุการจ่าย
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([requisitionId])
  @@index([drugId])
  @@index([status])
  @@map("requisition_items")
}

enum WorkflowAction {
  CREATE          // สร้างใบเบิก
  SUBMIT          // ส่งใบเบิก
  REVIEW          // ตรวจสอบ
  APPROVE         // อนุมัติ
  REJECT          // ปฏิเสธ
  FULFILL         // จ่ายยา
  PARTIAL_FULFILL // จ่ายบางส่วน
  COMPLETE        // เสร็จสิ้น
  CANCEL          // ยกเลิก
  REQUEST_INFO    // ขอข้อมูลเพิ่มเติม
  PROVIDE_INFO    // ให้ข้อมูลเพิ่มเติม
}

model RequisitionWorkflow {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId   String
  requisition     Requisition     @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Restrict)
  
  // การดำเนินการ
  action          WorkflowAction
  fromStatus      RequisitionStatus?
  toStatus        RequisitionStatus?
  
  // รายละเอียด
  comments        String?
  attachments     Json?           // array of file paths/URLs
  
  // การติดตาม
  processedAt     DateTime        @default(now())
  ipAddress       String?
  userAgent       String?
  
  @@index([requisitionId])
  @@index([userId])
  @@index([action])
  @@index([processedAt])
  @@map("requisition_workflows")
}

model RequisitionAttachment {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  requisitionId   String
  requisition     Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  uploadedBy      String
  uploader        User        @relation(fields: [uploadedBy], references: [id], onDelete: Restrict)
  
  // ข้อมูลไฟล์
  fileName        String
  originalName    String
  fileSize        Int
  mimeType        String
  filePath        String      // path in storage
  
  // รายละเอียด
  description     String?
  category        String?     // "PRESCRIPTION", "AUTHORIZATION", "SUPPORTING_DOC", "OTHER"
  
  // สถานะ
  isActive        Boolean     @default(true)
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([requisitionId])
  @@index([uploadedBy])
  @@map("requisition_attachments")
}

model RequisitionTemplate {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  departmentId    String
  department      Department  @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  createdBy       String
  creator         User        @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  
  // ข้อมูลเทมเพลต
  templateName    String
  description     String?
  
  // การตั้งค่า
  type            RequisitionType
  priority        RequisitionPriority @default(NORMAL)
  isRecurring     Boolean     @default(false)
  recurringPattern String?    // "DAILY", "WEEKLY", "MONTHLY", "CUSTOM"
  
  // รายการยา (JSON)
  items           Json        // array of {drugId, requestedQty, notes}
  
  // สถานะ
  isActive        Boolean     @default(true)
  
  // การใช้งาน
  usageCount      Int         @default(0)
  lastUsedAt      DateTime?
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([hospitalId])
  @@index([departmentId])
  @@index([createdBy])
  @@map("requisition_templates")
}