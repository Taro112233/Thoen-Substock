// prisma/schemas/auth.prisma
// Authentication and User Management Schema (Fixed Relations)
// ระบบจัดการผู้ใช้และการยืนยันตัวตนสำหรับ Hospital Pharmacy System

enum Role {
  DEVELOPER           // นักพัฒนา - สิทธิ์สูงสุด (ใหม่)
  HOSPITAL_ADMIN      // ผู้ดูแลระบบโรงพยาบาล - สิทธิ์เต็ม
  PHARMACY_MANAGER    // ผู้จัดการเภสัชกรรม - จัดการสต็อกและอนุมัติ
  SENIOR_PHARMACIST   // เภสัชกรอาวุโส - จัดการสต็อกและจ่ายยา
  STAFF_PHARMACIST    // เภสัชกรประจำ - จ่ายยาและรับสต็อก
  DEPARTMENT_HEAD     // หัวหน้าแผนก - เบิกยาและจัดการงบประมาณ
  STAFF_NURSE         // พยาบาลประจำ - เบิกยาพื้นฐาน
  PHARMACY_TECHNICIAN // เทคนิคเภสัชกรรม - รับสต็อกและจัดระเบียบ
  DIRECTOR            // ผู้อำนวยการ (ใหม่)
  GROUP_HEAD          // หัวหน้ากลุ่มงาน (ใหม่)  
  STAFF               // พนักงาน (ใหม่)
  STUDENT             // นักศึกษา (ใหม่)
}

enum UserStatus {
  PENDING   // รอการอนุมัติ
  ACTIVE    // ใช้งานได้
  INACTIVE  // ปิดการใช้งานชั่วคราว
  SUSPENDED // ระงับการใช้งาน
  DELETED   // ลบแล้ว (soft delete)
}

model User {
  id            String      @id @default(uuid())
  
  // ข้อมูลพื้นฐาน
  email         String      @unique
  name          String
  username      String      @unique  // เพิ่มสำหรับ login
  firstName     String?     // ชื่อ
  lastName      String?     // นามสกุล
  phoneNumber   String?
  employeeId    String?     // รหัสพนักงาน
  position      String?     // ตำแหน่ง
  
  // การยืนยันตัวตน
  emailVerified Boolean     @default(false)
  password      String?     // hashed password
  
  // Profile completion tracking
  isProfileComplete Boolean @default(false)
  
  // บทบาทและสิทธิ์
  role          Role
  status        UserStatus  @default(PENDING)
  
  // ความสัมพันธ์กับ Personnel Type (Master Data) - Fixed relation name
  personnelTypeId String?
  personnelType PersonnelType? @relation("UserPersonnelType", fields: [personnelTypeId], references: [id], onDelete: SetNull)
  
  // ความสัมพันธ์กับโรงพยาบาล
  hospitalId    String
  hospital      Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ความสัมพันธ์
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  stockMovements      StockMovementHistory[]
  inventorySnapshots  InventoryValueSnapshot[]
  operatedCarts         DeliveryCart[] @relation("CartOperator")
  drivenTrips           DeliveryTrip[] @relation("TripDriver")
  assistedTrips         DeliveryTrip[] @relation("TripAssistant")
  deliveries            ProgressiveDelivery[] @relation("Deliverer")
  receivedDeliveries    ProgressiveDelivery[] @relation("Receiver")
  recordedCheckpoints   TripCheckpoint[]
  cartActivities        CartActivityLog[]
  createdRoutes         DeliveryRoute[]
  
  // การติดตามการเข้าสู่ระบบ
  lastLoginAt   DateTime?
  lastLoginIP   String?
  loginCount    Int         @default(0)
  
  // การอนุมัติผู้ใช้งาน
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  
  // การติดตาม changes
  lastModifiedBy  String?
  statusChangedAt DateTime?
  statusHistory   Json?
  
  // ข้อมูลเพิ่มเติมสำหรับการอนุมัติ
  applicationNotes String?
  approvalNotes   String?
  requestedRole   Role?
  
  // Audit fields
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdBy     String?
  
  // Better Auth required relations
  accounts      Account[]
  sessions      Session[]
  
  // Authentication Relations
  refreshTokens            RefreshToken[]
  passwordResetTokens      PasswordResetToken[]
  emailVerificationTokens  EmailVerificationToken[]
  loginAttempts            LoginAttempt[]
  
  // Department & Warehouse Management
  departmentsManaged       Department[]     @relation("DepartmentHead")
  warehousesManaged        Warehouse[]      @relation("WarehouseManager")
  
  // Stock Management
  stockTransactions        StockTransaction[]
  stockCountsAsCounter     StockCount[]     @relation("StockCounter")
  stockCountsAsVerifier    StockCount[]     @relation("StockCountVerifier")
  
  // Requisition System
  requisitionsCreated      Requisition[]    @relation("RequisitionCreator")
  requisitionsRequested    Requisition[]    @relation("RequesterRelation")
  requisitionsApproved     Requisition[]    @relation("ApproverRelation")
  requisitionsFulfilled    Requisition[]    @relation("FulfillerRelation")
  requisitionsReceived     Requisition[]    @relation("ReceiverRelation")
  workflowActions          RequisitionWorkflow[]
  requisitionAttachments   RequisitionAttachment[]
  requisitionTemplatesCreated RequisitionTemplate[]
  
  // Supplier Management
  purchaseOrdersCreated    PurchaseOrder[]  @relation("POOrderer")
  purchaseOrdersApproved   PurchaseOrder[]  @relation("POApprover")
  goodsReceiptsReceived    GoodsReceipt[]   @relation("GRReceiver")
  goodsReceiptsVerified    GoodsReceipt[]   @relation("GRVerifier")
  supplierEvaluations      SupplierEvaluation[]
  
  // Analytics & Reporting
  reportsRequested         Report[]
  dashboards               Dashboard[]
  systemUsageLogs          SystemUsage[]
  
  // Audit & Compliance
  auditLogs                AuditLog[]
  dataAccessLogs           DataAccessLog[]
  complianceChecksPerformed ComplianceCheck[] @relation("ComplianceChecker")
  complianceChecksReviewed ComplianceCheck[] @relation("ComplianceReviewer")
  controlledSubstanceLogsHandled ControlledSubstanceLog[] @relation("CSLHandler")
  controlledSubstanceLogsWitnessed ControlledSubstanceLog[] @relation("CSLWitness")
  controlledSubstanceLogsAuthorized ControlledSubstanceLog[] @relation("CSLAuthorizer")
  internalAudits           InternalAudit[]
  securityIncidentsReported SecurityIncident[] @relation("SecurityReporter")
  securityIncidentsSuspected SecurityIncident[] @relation("SuspectedUser")
  securityIncidentsInvestigated SecurityIncident[] @relation("Investigator")
  
  // Notifications
  notificationPreferences  NotificationPreference[]
  notifications            NotificationUser[]
  
  // User approval relations
  usersApproved           User[] @relation("UserApprover")
  usersRejected           User[] @relation("UserRejecter")
  approver                User?  @relation("UserApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  rejecter                User?  @relation("UserRejecter", fields: [rejectedBy], references: [id], onDelete: SetNull)
  
  // Master Data Management Relations
  personnelTypesCreated   PersonnelType[] @relation("PersonnelTypeCreator")
  drugFormsCreated        DrugForm[]      @relation("DrugFormCreator")
  drugGroupsCreated       DrugGroup[]     @relation("DrugGroupCreator")
  drugTypesCreated        DrugType[]      @relation("DrugTypeCreator")
  drugStorageCreated      DrugStorage[]   @relation("DrugStorageCreator")
  
  @@index([hospitalId])
  @@index([role])
  @@index([status])
  @@index([personnelTypeId])
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([userId])
  @@index([sessionToken])
  @@index([expires])
  @@map("sessions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token     String   @unique
  expiresAt DateTime
  
  isRevoked Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token     String   @unique
  expiresAt DateTime
  
  isUsed    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token     String   @unique
  expiresAt DateTime
  
  isUsed    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@map("email_verification_tokens")
}

model LoginAttempt {
  id        String   @id @default(uuid())
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  email     String
  ipAddress String
  userAgent String?
  
  success   Boolean
  failureReason String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("login_attempts")
}