// prisma/schemas/inventory.prisma
// Inventory Management Schema
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Hospital Pharmacy System

enum TransactionType {
  RECEIVE         // ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏à‡∏≤‡∏Å‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå
  DISPENSE        // ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏Å
  TRANSFER_OUT    // ‡πÇ‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô
  TRANSFER_IN     // ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô
  ADJUST_INCREASE // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏û‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°)
  ADJUST_DECREASE // ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î (‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏û‡∏ö‡∏•‡∏î, ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢)
  RETURN          // ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å
  DISPOSE         // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏¢‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
  RESERVE         // ‡∏à‡∏≠‡∏á‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å
  UNRESERVE       // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  QUARANTINE      // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏Å‡∏Å‡∏±‡∏ô
  RELEASE_QUARANTINE // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏Å‡∏Å‡∏±‡∏ô
  THEFT           // ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢/‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢
  DAMAGE          // ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤
}

model StockTransaction {
  id               String          @id @default(uuid())
  
  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å
  hospitalId       String
  warehouseId      String
  warehouse        Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  drugId           String
  drug             Drug            @relation(fields: [drugId], references: [id], onDelete: Cascade)
  stockCardId      String
  stockCard        StockCard       @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  batchId          String?
  batch            StockBatch?     @relation(fields: [batchId], references: [id], onDelete: SetNull)
  
  // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  transactionType  TransactionType
  quantity         Int             // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (+/-)
  unitCost         Decimal         // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢
  totalCost        Decimal         // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°
  
  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏á
  stockBefore      Int             // ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  stockAfter       Int             // ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  
  // ‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
  referenceDocument String?        // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (PO, REQ, etc.)
  referenceId      String?         // ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
  notes            String?         // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
  
  // ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TRANSFER)
  fromWarehouseId  String?         // ‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
  fromWarehouse    Warehouse?      @relation("TransferFrom", fields: [fromWarehouseId], references: [id], onDelete: SetNull)
  toWarehouseId    String?         // ‡∏Ñ‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
  toWarehouse      Warehouse?      @relation("TransferTo", fields: [toWarehouseId], references: [id], onDelete: SetNull)
  
  // ‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
  performedBy      String
  performer        User            @relation(fields: [performedBy], references: [id], onDelete: Restrict)
  
  // ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
  requiresApproval Boolean         @default(false)
  approvedBy       String?
  approvedAt       DateTime?
  
  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å
  requisitionId    String?
  requisition      Requisition?    @relation(fields: [requisitionId], references: [id], onDelete: SetNull)
  
  // ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
  isSystemGenerated Boolean        @default(false) // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  ipAddress        String?
  userAgent        String?
  
  // Audit fields
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  
  @@index([hospitalId, warehouseId])
  @@index([drugId])
  @@index([stockCardId])
  @@index([transactionType])
  @@index([createdAt])
  @@index([performedBy])
  @@index([requisitionId])
  @@map("stock_transactions")
}

enum BatchStatus {
  ACTIVE          // ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  QUARANTINE      // ‡∏Å‡∏±‡∏Å‡∏Å‡∏±‡∏ô
  EXPIRED         // ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  RECALLED        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô
  DAMAGED         // ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
  DISPOSED        // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
}

model StockBatch {
  id              String        @id @default(uuid())
  
  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
  hospitalId      String
  stockCardId     String
  stockCard       StockCard     @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• batch
  batchNumber     String        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç batch
  manufacturingDate DateTime?   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï
  expiryDate      DateTime      // ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
  
  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
  initialQty      Int           // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  currentQty      Int           // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  reservedQty     Int           @default(0) // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á
  availableQty    Int           // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ (computed: currentQty - reservedQty)
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
  supplierId      String?       // ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå
  purchaseOrderId String?       // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PO
  invoiceNo       String?       // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ
  
  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  receivedDate    DateTime      // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
  firstUsedDate   DateTime?     // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  
  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  status          BatchStatus   @default(ACTIVE)
  
  // ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û
  qcStatus        String?       // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ QC: "PENDING", "PASSED", "FAILED"
  qcDate          DateTime?     // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö QC
  qcNotes         String?       // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ QC
  
  // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö
  storageLocation String?       // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö
  storageCondition String?      // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // ‚úÖ Relations - ‡πÄ‡∏û‡∏¥‡πà‡∏° back-references
  stockTransactions StockTransaction[]
  deliveryItems   DeliveryItem[]
  preferredByRequisitions RequisitionItem[] @relation("PreferredBatch")  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° back-reference
  stockCountItems StockCountItem[]
  
  @@unique([hospitalId, stockCardId, batchNumber])
  @@index([hospitalId, expiryDate])
  @@index([status])
  @@map("stock_batches")
}

model StockCard {
  id              String        @id @default(uuid())
  
  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  warehouseId     String
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î
  cardNumber      String        @unique // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å
  
  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
  currentStock    Int           @default(0)
  reservedStock   Int           @default(0)
  availableStock  Int           @default(0) // currentStock - reservedStock
  
  // ‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  reorderPoint    Int           @default(0)
  reorderQty      Int           @default(0)
  maxStock        Int?          // ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
  minStock        Int?          // ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î
  
  // üÜï ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Package ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤
  packageSize     Int           @default(1) // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡πÅ‡∏û‡πá‡∏Ñ
  packageUnit     String?       // ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÅ‡∏û‡πá‡∏Ñ (tablets, capsules, vials, etc.)
  
  // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
  averageCost     Decimal       @default(0) // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢
  lastCost        Decimal       @default(0) // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢
  
  // üÜï ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏û‡πá‡∏Ñ
  packageCost     Decimal       @default(0) // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏û‡πá‡∏Ñ (averageCost * packageSize)
  lastPackageCost Decimal       @default(0) // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏û‡πá‡∏Ñ
  pricePerBox     Decimal       @default(0) // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏á/‡πÅ‡∏û‡πá‡∏Ñ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô packageCost ‡πÅ‡∏ï‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
  
  // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°
  totalValue      Decimal       @default(0) // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  
  // ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  lastIssueDate   DateTime?     // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  lastReceiveDate DateTime?     // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  monthlyUsage    Int           @default(0) // ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏´‡∏ô‡πà‡∏ß‡∏¢)
  monthlyPackageUsage Int       @default(0) // ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÅ‡∏û‡πá‡∏Ñ)
  
  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  isActive        Boolean       @default(true)
  isControlled    Boolean       @default(false) // ‡∏¢‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
  isNarcotic      Boolean       @default(false) // ‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î
  
  // ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  lowStockAlert   Boolean       @default(false)
  expiryAlert     Boolean       @default(false)
  overStockAlert  Boolean       @default(false)
  
  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  batches         StockBatch[]
  transactions    StockTransaction[]
  stockCounts     StockCountItem[]
  requisitionItems RequisitionItem[]
  expiryLots      ExpiryLot[]
  movementHistory StockMovementHistory[]
  
  @@unique([hospitalId, drugId, warehouseId])
  @@index([hospitalId, warehouseId])
  @@index([drugId])
  @@index([currentStock])
  @@index([isActive])
  @@map("stock_cards")
}

enum CountStatus {
  PLANNED         // ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡πâ‡∏ß
  IN_PROGRESS     // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏±‡∏ö
  COMPLETED       // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
  VERIFIED        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  ADJUSTED        // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß
  CANCELLED       // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
}

model StockCount {
  id              String        @id @default(uuid())
  
  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  warehouseId     String
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
  countNumber     String        @unique // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
  countType       String        // "FULL", "PARTIAL", "CYCLE", "SPOT"
  reason          String?       // ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
  
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
  scheduledDate   DateTime      // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡∏±‡∏ö
  startedAt       DateTime?     // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö
  completedAt     DateTime?     // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
  
  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  status          CountStatus   @default(PLANNED)
  
  // ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
  countedBy       String
  counter         User          @relation("StockCounter", fields: [countedBy], references: [id], onDelete: Restrict)
  verifiedBy      String?
  verifier        User?         @relation("StockCountVerifier", fields: [verifiedBy], references: [id], onDelete: Restrict)
  
  // ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
  totalItems      Int           @default(0)
  itemsWithVariance Int         @default(0) // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á
  totalVarianceValue Decimal    @default(0) // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°
  
  // ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  requiresApproval Boolean      @default(false)
  approvedBy      String?
  approvedAt      DateTime?
  
  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  items           StockCountItem[]
  
  @@index([hospitalId, warehouseId])
  @@index([countedBy])
  @@index([status])
  @@index([scheduledDate])
  @@map("stock_counts")
}

model StockCountItem {
  id              String      @id @default(uuid())
  
  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
  stockCountId    String
  stockCount      StockCount  @relation(fields: [stockCountId], references: [id], onDelete: Cascade)
  stockCardId     String
  stockCard       StockCard   @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  batchId         String?
  batch           StockBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)
  
  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ
  systemQty       Int         // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
  countedQty      Int         // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ
  variance        Int         // ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (countedQty - systemQty)
  varianceValue   Decimal     @default(0) // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á
  
  // ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
  isVerified      Boolean     @default(false)
  verificationNotes String?
  
  // ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á
  varianceReason  String?     // "DAMAGE", "THEFT", "EXPIRED", "MISPLACED", "SYSTEM_ERROR", "OTHER"
  adjustmentRequired Boolean  @default(false)
  
  // ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
  countedAt       DateTime?   // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö
  verifiedAt      DateTime?   // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
  
  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
  notes           String?
  
  @@index([stockCountId])
  @@index([stockCardId])
  @@map("stock_count_items")
}