// prisma/schemas/inventory.prisma
// Inventory Management Schema
// ระบบจัดการคลังยาและสต็อกสำหรับ Hospital Pharmacy System

enum TransactionType {
  RECEIVE         // รับยาจากซัพพลายเออร์
  DISPENSE        // จ่ายยาให้แผนก
  TRANSFER_OUT    // โอนออกไปคลังอื่น
  TRANSFER_IN     // รับโอนจากคลังอื่น
  ADJUST_INCREASE // ปรับเพิ่ม (การนับพบเพิ่ม)
  ADJUST_DECREASE // ปรับลด (การนับพบลด, เสียหาย)
  RETURN          // รับคืนยาจากแผนก
  DISPOSE         // ทำลายยาหมดอายุ/เสียหาย
  RESERVE         // จองยาสำหรับใบเบิก
  UNRESERVE       // ยกเลิกการจอง
  QUARANTINE      // เข้าห้องกักกัน
  RELEASE_QUARANTINE // ออกจากห้องกักกัน
  THEFT           // สูญหาย/ถูกขโมย
  DAMAGE          // เสียหายจากการเก็บรักษา
}

model StockTransaction {
  id               String          @id @default(uuid())
  
  // ความสัมพันธ์หลัก
  hospitalId       String
  warehouseId      String
  warehouse        Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  drugId           String
  drug             Drug            @relation(fields: [drugId], references: [id], onDelete: Cascade)
  stockCardId      String
  stockCard        StockCard       @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  batchId          String?
  batch            StockBatch?     @relation(fields: [batchId], references: [id], onDelete: SetNull)
  
  // รายละเอียดการทำรายการ
  transactionType  TransactionType
  quantity         Int             // จำนวน (+/-)
  unitCost         Decimal         // ต้นทุนต่อหน่วย
  totalCost        Decimal         // ต้นทุนรวม
  
  // จำนวนก่อนและหลัง
  stockBefore      Int             // สต็อกก่อนทำรายการ
  stockAfter       Int             // สต็อกหลังทำรายการ
  
  // การอ้างอิง
  referenceDocument String?        // เลขที่เอกสารอ้างอิง (PO, REQ, etc.)
  referenceId      String?         // ID ของเอกสารอ้างอิง
  notes            String?         // หมายเหตุ
  
  // การโอน (สำหรับ TRANSFER)
  fromWarehouseId  String?         // คลังต้นทาง
  fromWarehouse    Warehouse?      @relation("TransferFrom", fields: [fromWarehouseId], references: [id], onDelete: SetNull)
  toWarehouseId    String?         // คลังปลายทาง
  toWarehouse      Warehouse?      @relation("TransferTo", fields: [toWarehouseId], references: [id], onDelete: SetNull)
  
  // ผู้ดำเนินการ
  performedBy      String
  performer        User            @relation(fields: [performedBy], references: [id], onDelete: Restrict)
  
  // การอนุมัติ (สำหรับรายการที่ต้องอนุมัติ)
  requiresApproval Boolean         @default(false)
  approvedBy       String?
  approvedAt       DateTime?
  
  // ความสัมพันธ์กับใบเบิก
  requisitionId    String?
  requisition      Requisition?    @relation(fields: [requisitionId], references: [id], onDelete: SetNull)
  
  // การติดตาม
  isSystemGenerated Boolean        @default(false) // สร้างโดยระบบอัตโนมัติ
  ipAddress        String?
  userAgent        String?
  
  // Audit fields
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  
  @@index([hospitalId, warehouseId])
  @@index([drugId])
  @@index([stockCardId])
  @@index([transactionType])
  @@index([createdAt])
  @@index([performedBy])
  @@index([requisitionId])
  @@map("stock_transactions")
}

enum BatchStatus {
  ACTIVE          // ใช้งานได้
  QUARANTINE      // กักกัน
  EXPIRED         // หมดอายุ
  RECALLED        // เรียกคืน
  DAMAGED         // เสียหาย
  DISPOSED        // ทำลายแล้ว
}

model StockBatch {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  stockCardId     String
  stockCard       StockCard     @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  deliveryItems   DeliveryItem[]
  
  // ข้อมูล batch
  batchNumber     String        // หมายเลข batch
  manufacturingDate DateTime?   // วันที่ผลิต
  expiryDate      DateTime      // วันหมดอายุ
  
  // จำนวนสต็อก
  initialQty      Int           // จำนวนเริ่มต้น
  currentQty      Int           // จำนวนปัจจุบัน
  reservedQty     Int           @default(0) // จำนวนที่จอง
  availableQty    Int           // จำนวนที่พร้อมใช้ (computed: currentQty - reservedQty)
  
  // ข้อมูลการซื้อ
  supplierId      String?       // ซัพพลายเออร์
  purchaseOrderId String?       // หมายเลข PO
  invoiceNo       String?       // หมายเลขใบแจ้งหนี้
  
  // วันที่สำคัญ
  receivedDate    DateTime      // วันที่รับเข้า
  firstUsedDate   DateTime?     // วันที่ใช้ครั้งแรก
  
  // สถานะ
  status          BatchStatus   @default(ACTIVE)
  
  // การตรวจสอบคุณภาพ
  qcStatus        String?       // สถานะ QC: "PENDING", "PASSED", "FAILED"
  qcDate          DateTime?     // วันที่ตรวจสอบ QC
  qcNotes         String?       // หมายเหตุ QC
  
  // การจัดเก็บ
  storageLocation String?       // ตำแหน่งเก็บ
  storageCondition String?      // เงื่อนไขการเก็บ
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations - เพิ่ม inverse relations
  transactions    StockTransaction[]
  stockCountItems StockCountItem[]
  
  @@unique([hospitalId, stockCardId, batchNumber])
  @@index([hospitalId, expiryDate])
  @@index([status])
  @@map("stock_batches")
}

model StockCard {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  warehouseId     String
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  // รหัสสต็อกการ์ด
  cardNumber      String        @unique // เลขที่บัตรสต็อก
  
  // จำนวนสต็อก
  currentStock    Int           @default(0)
  reservedStock   Int           @default(0)
  availableStock  Int           @default(0) // currentStock - reservedStock
  
  // จุดสั่งซื้อ
  reorderPoint    Int           @default(0)
  reorderQty      Int           @default(0)
  maxStock        Int?          // สต็อกสูงสุด
  minStock        Int?          // สต็อกต่ำสุด
  
  // การคำนวณต้นทุน
  averageCost     Decimal       @default(0) // ต้นทุนเฉลี่ย
  lastCost        Decimal       @default(0) // ต้นทุนล่าสุด
  totalValue      Decimal       @default(0) // มูลค่ารวม
  
  // การติดตามการใช้งาน
  lastIssueDate   DateTime?     // วันที่จ่ายล่าสุด
  lastReceiveDate DateTime?     // วันที่รับล่าสุด
  monthlyUsage    Int           @default(0) // การใช้เฉลี่ยต่อเดือน
  
  // สถานะ
  isActive        Boolean       @default(true)
  isControlled    Boolean       @default(false) // ยาควบคุม
  isNarcotic      Boolean       @default(false) // ยาเสพติด
  
  // การแจ้งเตือน
  lowStockAlert   Boolean       @default(false)
  expiryAlert     Boolean       @default(false)
  overStockAlert  Boolean       @default(false)
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  batches         StockBatch[]
  transactions    StockTransaction[]
  stockCounts     StockCountItem[]
  requisitionItems RequisitionItem[]
  expiryLots      ExpiryLot[]
  movementHistory StockMovementHistory[]
  
  @@unique([hospitalId, drugId, warehouseId])
  @@index([hospitalId, warehouseId])
  @@index([drugId])
  @@index([currentStock])
  @@index([isActive])
  @@map("stock_cards")
}

enum CountStatus {
  PLANNED         // วางแผนแล้ว
  IN_PROGRESS     // กำลังนับ
  COMPLETED       // เสร็จสิ้น
  VERIFIED        // ตรวจสอบแล้ว
  ADJUSTED        // ปรับปรุงแล้ว
  CANCELLED       // ยกเลิก
}

model StockCount {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  warehouseId     String
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  // รายละเอียดการนับ
  countNumber     String        @unique // เลขที่การนับ
  countType       String        // "FULL", "PARTIAL", "CYCLE", "SPOT"
  reason          String?       // เหตุผลการนับ
  
  // กำหนดการ
  scheduledDate   DateTime      // วันที่กำหนดนับ
  startedAt       DateTime?     // เวลาเริ่มนับ
  completedAt     DateTime?     // เวลาเสร็จสิ้น
  
  // สถานะ
  status          CountStatus   @default(PLANNED)
  
  // ผู้รับผิดชอบ
  countedBy       String
  counter         User          @relation("StockCounter", fields: [countedBy], references: [id], onDelete: Restrict)
  verifiedBy      String?
  verifier        User?         @relation("StockCountVerifier", fields: [verifiedBy], references: [id], onDelete: Restrict)
  
  // สรุปผล
  totalItems      Int           @default(0)
  itemsWithVariance Int         @default(0) // รายการที่มีส่วนต่าง
  totalVarianceValue Decimal    @default(0) // มูลค่าส่วนต่างรวม
  
  // การอนุมัติ
  requiresApproval Boolean      @default(false)
  approvedBy      String?
  approvedAt      DateTime?
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  items           StockCountItem[]
  
  @@index([hospitalId, warehouseId])
  @@index([countedBy])
  @@index([status])
  @@index([scheduledDate])
  @@map("stock_counts")
}

model StockCountItem {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  stockCountId    String
  stockCount      StockCount  @relation(fields: [stockCountId], references: [id], onDelete: Cascade)
  stockCardId     String
  stockCard       StockCard   @relation(fields: [stockCardId], references: [id], onDelete: Cascade)
  batchId         String?
  batch           StockBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)
  
  // จำนวนในระบบและจำนวนนับได้
  systemQty       Int         // จำนวนในระบบ
  countedQty      Int         // จำนวนที่นับได้
  variance        Int         // ส่วนต่าง (countedQty - systemQty)
  varianceValue   Decimal     @default(0) // มูลค่าส่วนต่าง
  
  // การตรวจสอบ
  isVerified      Boolean     @default(false)
  verificationNotes String?
  
  // เหตุผลส่วนต่าง
  varianceReason  String?     // "DAMAGE", "THEFT", "EXPIRED", "MISPLACED", "SYSTEM_ERROR", "OTHER"
  adjustmentRequired Boolean  @default(false)
  
  // การติดตาม
  countedAt       DateTime?   // เวลาที่นับ
  verifiedAt      DateTime?   // เวลาที่ตรวจสอบ
  
  // หมายเหตุ
  notes           String?
  
  @@index([stockCountId])
  @@index([stockCardId])
  @@map("stock_count_items")
}