// prisma/schemas/suppliers.prisma
// Supplier Management Schema
// ระบบจัดการซัพพลายเออร์และการจัดซื้อ

enum SupplierType {
  MANUFACTURER    // บริษัทผลิต
  DISTRIBUTOR     // ผู้จัดจำหน่าย
  WHOLESALER      // ผู้ค้าส่ง
  IMPORTER        // ผู้นำเข้า
  LOCAL_PHARMACY  // ร้านยาท้องถิ่น
  GOVERNMENT      // หน่วยงานราชการ
  INTERNATIONAL   // ต่างประเทศ
}

enum SupplierStatus {
  ACTIVE          // ใช้งานปกติ
  INACTIVE        // ไม่ใช้งานชั่วคราว
  SUSPENDED       // ระงับการใช้งาน
  BLACKLISTED     // ขึ้นบัญชีดำ
  PENDING_APPROVAL // รอการอนุมัติ
  UNDER_REVIEW    // อยู่ระหว่างการทบทวน
}

enum SupplierRating {
  EXCELLENT       // ดีเยี่ยม
  GOOD           // ดี
  AVERAGE        // ปานกลาง
  POOR           // แย่
  UNRATED        // ไม่ได้รับการประเมิน
}

model Supplier {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์กับโรงพยาบาล
  hospitalId      String
  hospital        Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  
  // ข้อมูลพื้นฐาน
  code            String          // รหัสซัพพลายเออร์
  name            String          // ชื่อบริษัท
  nameEn          String?         // ชื่อภาษาอังกฤษ
  shortName       String?         // ชื่อย่อ
  
  // ประเภทและสถานะ
  type            SupplierType
  status          SupplierStatus  @default(PENDING_APPROVAL)
  rating          SupplierRating  @default(UNRATED)
  
  // ข้อมูลทางธุรกิจ
  taxId           String?         // เลขประจำตัวผู้เสียภาษี
  businessLicense String?         // ใบอนุญาตประกอบธุรกิจ
  pharmacyLicense String?         // ใบอนุญาตร้านยา (ถ้ามี)
  gmpCertificate  String?         // ใบรับรอง GMP
  
  // ที่อยู่
  address         Json            // ที่อยู่ทางไปรษณีย์
  billingAddress  Json?           // ที่อยู่สำหรับเรียกเก็บเงิน
  shippingAddress Json?           // ที่อยู่สำหรับจัดส่ง
  
  // ข้อมูลติดต่อ
  contactInfo     Json            // { phone, fax, email, website }
  emergencyContact Json?          // ติดต่อฉุกเฉิน
  
  // เงื่อนไขทางการค้า
  paymentTerms    String?         // เงื่อนไขการชำระเงิน
  creditLimit     Decimal?        // วงเงินเครดิต
  creditPeriod    Int?            // ระยะเวลาเครดิต (วัน)
  deliveryTerms   String?         // เงื่อนไขการส่งมอบ
  minimumOrder    Decimal?        // จำนวนสั่งซื้อขั้นต่ำ
  
  // การประเมินผลการปฏิบัติงาน
  onTimeDeliveryRate Decimal?     // อัตราการส่งมอบตรงเวลา (%)
  qualityScore    Decimal?        // คะแนนคุณภาพ
  serviceScore    Decimal?        // คะแนนการบริการ
  overallScore    Decimal?        // คะแนนรวม
  
  // การติดต่อทางเทคนิค
  ediCapable      Boolean         @default(false) // รองรับ EDI
  apiEndpoint     String?         // API สำหรับเชื่อมต่อ
  catalogUpdate   String?         // วิธีการอัพเดตแคตตาล็อก
  
  // ใบรับรองและมาตรฐาน
  certifications  Json?           // ใบรับรองต่างๆ
  accreditations  Json?           // การรับรอง
  
  // การติดตามการทำงาน
  lastOrderDate   DateTime?       // วันที่สั่งซื้อล่าสุด
  lastDeliveryDate DateTime?      // วันที่ส่งมอบล่าสุด
  totalOrders     Int             @default(0)
  totalValue      Decimal         @default(0)
  
  // หมายเหตุ
  notes           String?         // หมายเหตุทั่วไป
  internalNotes   String?         // หมายเหตุภายใน
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String?
  isActive        Boolean         @default(true)
  
  // Relations
  contacts        SupplierContact[]
  products        SupplierProduct[]
  batches         StockBatch[]
  purchaseOrders  PurchaseOrder[]
  evaluations     SupplierEvaluation[]
  goodsReceipts   GoodsReceipt[]
  
  @@unique([hospitalId, code])
  @@index([hospitalId, status])
  @@index([type])
  @@index([rating])
  @@map("suppliers")
}

model SupplierContact {
  id            String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId    String
  supplier      Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // ข้อมูลบุคคล
  name          String
  position      String?     // ตำแหน่ง
  department    String?     // แผนก
  
  // ข้อมูลติดต่อ
  phone         String?
  mobile        String?
  email         String?
  fax           String?
  
  // ประเภทการติดต่อ
  contactType   String      // "PRIMARY", "SECONDARY", "SALES", "TECHNICAL", "BILLING", "EMERGENCY"
  isPrimary     Boolean     @default(false)
  
  // สถานะ
  isActive      Boolean     @default(true)
  
  // การติดตาม
  lastContactDate DateTime?
  
  // หมายเหตุ
  notes         String?
  
  // Audit fields
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([supplierId])
  @@map("supplier_contacts")
}

model SupplierProduct {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug        @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // รหัสสินค้าของซัพพลายเออร์
  supplierProductCode String?
  supplierBarcode String?
  
  // ราคาและเงื่อนไข
  unitPrice       Decimal
  unitOfMeasure   String      // หน่วยนับ
  packSize        Int?        // ขนาดแพ็ค
  minimumOrderQty Int?        // จำนวนสั่งซื้อขั้นต่ำ
  
  // เวลาจัดส่ง
  leadTimeDays    Int?        // ระยะเวลาส่งมอบ (วัน)
  availability    String?     // สถานะความพร้อม
  
  // ข้อมูลผลิตภัณฑ์
  manufacturerLot String?     // รหัส lot ของผู้ผลิต
  expiryPeriod    Int?        // อายุการเก็บ (เดือน)
  storageCondition String?    // เงื่อนไขการเก็บ
  
  // สถานะ
  isPreferred     Boolean     @default(false) // ซัพพลายเออร์หลัก
  isActive        Boolean     @default(true)
  
  // การติดตาม
  lastOrderDate   DateTime?
  lastPurchasePrice Decimal?
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@unique([supplierId, drugId])
  @@index([supplierId])
  @@index([drugId])
  @@map("supplier_products")
}

enum PurchaseOrderStatus {
  DRAFT           // ร่าง
  SUBMITTED       // ส่งแล้ว
  CONFIRMED       // ยืนยันแล้ว
  PARTIALLY_RECEIVED // รับบางส่วน
  COMPLETED       // เสร็จสิ้น
  CANCELLED       // ยกเลิก
  ON_HOLD         // พักการดำเนินการ
}

model PurchaseOrder {
  id              String              @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital            @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // หมายเลขใบสั่งซื้อ
  poNumber        String              @unique
  supplierRef     String?             // เลขที่อ้างอิงของซัพพลายเออร์
  
  // สถานะ
  status          PurchaseOrderStatus @default(DRAFT)
  
  // วันที่สำคัญ
  orderDate       DateTime            @default(now())
  requiredDate    DateTime            // วันที่ต้องการรับ
  expectedDate    DateTime?           // วันที่คาดว่าจะได้รับ
  confirmedDate   DateTime?           // วันที่ซัพพลายเออร์ยืนยัน
  
  // ข้อมูลการสั่งซื้อ
  totalAmount     Decimal             @default(0)
  taxAmount       Decimal             @default(0)
  discountAmount  Decimal             @default(0)
  shippingCost    Decimal             @default(0)
  netAmount       Decimal             @default(0)
  
  // เงื่อนไขการชำระเงิน
  paymentTerms    String?
  creditPeriod    Int?                // วัน
  
  // การจัดส่ง
  deliveryAddress Json                // ที่อยู่จัดส่ง
  deliveryMethod  String?             // วิธีการจัดส่ง
  specialInstructions String?         // คำแนะนำพิเศษ
  
  // ผู้รับผิดชอบ
  orderedBy       String
  orderer         User      @relation("POOrderer", fields: [orderedBy], references: [id], onDelete: Restrict)
  approvedBy      String?
  approver        User?     @relation("POApprover", fields: [approvedBy], references: [id], onDelete: Restrict)
  
  // หมายเหตุ
  notes           String?
  internalNotes   String?             // หมายเหตุภายใน
  
  // Audit fields
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  items           PurchaseOrderItem[]
  receipts        GoodsReceipt[]
  
  @@index([hospitalId, supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // จำนวนและราคา
  orderedQty      Int           // จำนวนที่สั่ง
  receivedQty     Int           @default(0) // จำนวนที่รับแล้ว
  remainingQty    Int           @default(0) // จำนวนที่เหลือ
  unitPrice       Decimal       // ราคาต่อหน่วย
  totalPrice      Decimal       // ราคารวม
  
  // ข้อมูลผลิตภัณฑ์
  supplierProductCode String?   // รหัสสินค้าของซัพพลายเออร์
  unitOfMeasure   String        // หน่วยนับ
  packSize        Int?          // ขนาดแพ็ค
  
  // การส่งมอบ
  requiredDate    DateTime      // วันที่ต้องการ
  expectedDate    DateTime?     // วันที่คาดว่าจะได้รับ
  
  // สถานะ
  status          String        @default("PENDING") // "PENDING", "CONFIRMED", "PARTIALLY_RECEIVED", "RECEIVED", "CANCELLED"
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  goodsReceiptItems GoodsReceiptItem[]
  
  @@index([purchaseOrderId])
  @@index([drugId])
  @@map("purchase_order_items")
}

enum ReceiptStatus {
  PENDING         // รอการตรวจสอบ
  VERIFIED        // ตรวจสอบแล้ว
  DISCREPANCY     // มีความผิดปกติ
  COMPLETED       // เสร็จสิ้น
  REJECTED        // ปฏิเสธ
}

model GoodsReceipt {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  
  // หมายเลขเอกสาร
  receiptNumber   String        @unique
  supplierInvoice String?       // เลขที่ใบแจ้งหนี้ของซัพพลายเออร์
  deliveryNote    String?       // เลขที่ใบส่งของ
  
  // วันที่
  receivedDate    DateTime      @default(now())
  invoiceDate     DateTime?
  
  // สถานะ
  status          ReceiptStatus @default(PENDING)
  
  // ข้อมูลการรับ
  totalItems      Int           @default(0)
  totalAmount     Decimal       @default(0)
  
  // ผู้รับผิดชอบ
  receivedBy      String
  receiver        User      @relation("GRReceiver", fields: [receivedBy], references: [id], onDelete: Restrict)
  verifiedBy      String?
  verifier        User?     @relation("GRVerifier", fields: [verifiedBy], references: [id], onDelete: Restrict)
  
  // หมายเหตุ
  notes           String?
  discrepancyNotes String?      // หมายเหตุความผิดปกติ
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  goodsReceiptItems   GoodsReceiptItem[]
  
  @@index([hospitalId, supplierId])
  @@index([receivedDate])
  @@index([status])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  goodsReceiptId  String
  goodsReceipt    GoodsReceipt  @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  purchaseOrderItemId String?
  purchaseOrderItem   PurchaseOrderItem? @relation(fields: [purchaseOrderItemId], references: [id], onDelete: SetNull)
  
  // จำนวน
  orderedQty      Int?          // จำนวนที่สั่ง (จาก PO)
  receivedQty     Int           // จำนวนที่รับจริง
  acceptedQty     Int           // จำนวนที่ยอมรับ
  rejectedQty     Int           @default(0) // จำนวนที่ปฏิเสธ
  
  // ข้อมูล batch
  batchNumber     String
  manufacturingDate DateTime?
  expiryDate      DateTime
  
  // ราคา
  unitCost        Decimal
  totalCost       Decimal
  
  // เหตุผลการปฏิเสธ
  rejectionReason String?
  
  // การตรวจสอบคุณภาพ
  qcStatus        String?       // "PENDING", "PASSED", "FAILED"
  qcNotes         String?
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([goodsReceiptId])
  @@index([drugId])
  @@map("goods_receipt_items")
}

// การประเมินซัพพลายเออร์
model SupplierEvaluation {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // ช่วงเวลาประเมิน
  evaluationPeriod String     // "Q1 2024", "2024"
  fromDate        DateTime
  toDate          DateTime
  
  // คะแนนประเมิน
  qualityScore    Decimal     // คุณภาพสินค้า (1-5)
  deliveryScore   Decimal     // การส่งมอบตรงเวลา (1-5)
  serviceScore    Decimal     // การบริการ (1-5)
  priceScore      Decimal     // ความเหมาะสมราคา (1-5)
  overallScore    Decimal     // คะแนนรวม (1-5)
  
  // สถิติการปฏิบัติงาน
  totalOrders     Int         // จำนวนคำสั่งซื้อ
  onTimeDeliveries Int        // จำนวนการส่งมอบตรงเวลา
  qualityIssues   Int         // จำนวนปัญหาคุณภาพ
  
  // ความคิดเห็น
  strengths       String?     // จุดแข็ง
  weaknesses      String?     // จุดอ่อน
  recommendations String?     // ข้อเสนอแนะ
  
  // ผู้ประเมิน
  evaluatedBy     String
  evaluator       User        @relation(fields: [evaluatedBy], references: [id], onDelete: Restrict)
  
  // การติดตาม
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([supplierId])
  @@index([evaluationPeriod])
  @@map("supplier_evaluations")
}