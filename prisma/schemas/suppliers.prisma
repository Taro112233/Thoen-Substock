// prisma/schemas/suppliers.prisma
// Supplier Management Schema
// ระบบจัดการซัพพลายเออร์และการจัดซื้อสำหรับ Hospital Pharmacy System

enum SupplierStatus {
  PENDING     // รอการอนุมัติ
  ACTIVE      // ใช้งานได้
  SUSPENDED   // ระงับการใช้งาน
  INACTIVE    // ปิดการใช้งาน
  BLACKLISTED // อยู่ในบัญชีดำ
}

enum SupplierType {
  PHARMACEUTICAL  // บริษัทยา
  MEDICAL_DEVICE  // อุปกรณ์การแพทย์
  CONSUMABLE     // วัสดุสิ้นเปลือง
  LABORATORY     // เครื่องมือห้องปฏิบัติการ
  OTHER          // อื่นๆ
}

model Supplier {
  id              String          @id @default(uuid())
  
  // ข้อมูลซัพพลายเออร์
  supplierCode    String          @unique // รหัสซัพพลายเออร์
  name            String
  nameEn          String?         // ชื่อภาษาอังกฤษ
  
  // ประเภทและสถานะ
  type            SupplierType
  status          SupplierStatus  @default(ACTIVE)
  
  // ข้อมูลการจดทะเบียน
  taxId           String?         // เลขประจำตัวผู้เสียภาษี
  registrationNo  String?         // เลขที่จดทะเบียน
  licenseNo       String?         // เลขที่ใบอนุญาต
  licenseExpiry   DateTime?       // วันหมดอายุใบอนุญาต
  
  // ที่อยู่
  address         String
  district        String?         // ตำบล/แขวง
  subDistrict     String?         // อำเภอ/เขต
  province        String
  postalCode      String?
  country         String          @default("Thailand")
  
  // ข้อมูลติดต่อ
  phone           String?
  fax             String?
  email           String?
  website         String?
  
  // ข้อมูลทางการเงิน
  paymentTerms    String?         // เงื่อนไขการชำระเงิน (30 days, COD, etc.)
  creditLimit     Decimal?        // วงเงินเครดิต
  currency        String          @default("THB")
  
  // การประเมิน
  rating          Decimal?        // คะแนนประเมิน (1-5)
  qualityScore    Decimal?        // คะแนนคุณภาพ
  deliveryScore   Decimal?        // คะแนนการส่งมอบ
  serviceScore    Decimal?        // คะแนนบริการ
  
  // หมายเหตุ
  notes           String?
  internalNotes   String?         // หมายเหตุภายใน
  
  // การติดตาม
  lastOrderDate   DateTime?       // วันที่สั่งซื้อล่าสุด
  totalOrders     Int             @default(0)
  totalValue      Decimal         @default(0)
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // ================================
  // RELATIONS (Fixed opposite fields)
  // ================================
  contacts        SupplierContact[]
  products        SupplierProduct[]
  purchaseOrders  PurchaseOrder[]
  goodsReceipts   GoodsReceipt[]  // Fixed: เพิ่ม relation กลับ
  evaluations     SupplierEvaluation[]
  
  @@index([supplierCode])
  @@index([status])
  @@index([type])
  @@map("suppliers")
}

model SupplierContact {
  id          String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId  String
  supplier    Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // ข้อมูลผู้ติดต่อ
  name        String
  position    String?     // ตำแหน่ง
  department  String?     // แผนก
  
  // ข้อมูลติดต่อ
  phone       String?
  mobile      String?
  email       String?
  fax         String?
  
  // ประเภทการติดต่อ
  contactType String      // "PRIMARY", "SECONDARY", "SALES", "TECHNICAL", "BILLING", "EMERGENCY"
  isPrimary   Boolean     @default(false)
  
  // สถานะ
  isActive    Boolean     @default(true)
  
  // การติดตาม
  lastContactDate DateTime?
  
  // หมายเหตุ
  notes       String?
  
  // Audit fields
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([supplierId])
  @@map("supplier_contacts")
}

model SupplierProduct {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug        @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // รหัสสินค้าของซัพพลายเออร์
  supplierProductCode String?
  supplierBarcode String?
  
  // ราคาและเงื่อนไข
  unitPrice       Decimal
  unitOfMeasure   String      // หน่วยนับ
  packSize        Int?        // ขนาดแพ็ค
  minimumOrderQty Int?        // จำนวนสั่งซื้อขั้นต่ำ
  
  // เวลาจัดส่ง
  leadTimeDays    Int?        // ระยะเวลาส่งมอบ (วัน)
  availability    String?     // สถานะความพร้อม
  
  // ข้อมูลผลิตภัณฑ์
  manufacturerLot String?     // รหัส lot ของผู้ผลิต
  expiryPeriod    Int?        // อายุการเก็บ (เดือน)
  storageCondition String?    // เงื่อนไขการเก็บ
  
  // สถานะ
  isPreferred     Boolean     @default(false) // ซัพพลายเออร์หลัก
  isActive        Boolean     @default(true)
  
  // การติดตาม
  lastOrderDate   DateTime?
  lastPurchasePrice Decimal?
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@unique([supplierId, drugId])
  @@index([supplierId])
  @@index([drugId])
  @@map("supplier_products")
}

enum PurchaseOrderStatus {
  DRAFT           // ร่าง
  SUBMITTED       // ส่งแล้ว
  CONFIRMED       // ยืนยันแล้ว
  PARTIALLY_RECEIVED // รับบางส่วน
  COMPLETED       // เสร็จสิ้น
  CANCELLED       // ยกเลิก
  ON_HOLD         // พักการดำเนินการ
}

model PurchaseOrder {
  id              String              @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital            @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  // หมายเลขใบสั่งซื้อ
  poNumber        String              @unique
  supplierRef     String?             // เลขที่อ้างอิงของซัพพลายเออร์
  
  // สถานะ
  status          PurchaseOrderStatus @default(DRAFT)
  
  // วันที่สำคัญ
  orderDate       DateTime            @default(now())
  requiredDate    DateTime            // วันที่ต้องการรับ
  expectedDate    DateTime?           // วันที่คาดว่าจะได้รับ
  confirmedDate   DateTime?           // วันที่ยืนยัน
  
  // มูลค่า
  subtotal        Decimal             @default(0)
  discountAmount  Decimal             @default(0)
  taxAmount       Decimal             @default(0)
  totalAmount     Decimal             @default(0)
  
  // ผู้รับผิดชอบ
  orderedBy       String
  orderer         User                @relation("POOrderer", fields: [orderedBy], references: [id], onDelete: Restrict)
  approvedBy      String?
  approver        User?               @relation("POApprover", fields: [approvedBy], references: [id], onDelete: Restrict)
  
  // เงื่อนไขการชำระเงิน
  paymentTerms    String?
  deliveryTerms   String?
  
  // หมายเหตุ
  notes           String?
  internalNotes   String?
  
  // Audit fields
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  items           PurchaseOrderItem[]
  goodsReceipts   GoodsReceipt[]
  
  @@index([hospitalId, supplierId])
  @@index([orderDate])
  @@index([status])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // รายละเอียดสินค้า
  description     String?       // รายละเอียดเพิ่มเติม
  specification   String?       // รายละเอียดทางเทคนิค
  
  // จำนวนและราคา
  quantity        Int
  unitPrice       Decimal
  discountPercent Decimal       @default(0)
  discountAmount  Decimal       @default(0)
  lineTotal       Decimal
  
  // การส่งมอบ
  requestedDate   DateTime?     // วันที่ต้องการ
  deliveredQty    Int           @default(0) // จำนวนที่ส่งแล้ว
  
  // สถานะ
  status          String        @default("PENDING") // "PENDING", "PARTIAL", "COMPLETED", "CANCELLED"
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // ================================
  // RELATIONS (Fixed opposite fields)
  // ================================
  goodsReceiptItems GoodsReceiptItem[] // Fixed: เพิ่ม relation กลับ
  
  @@index([purchaseOrderId])
  @@index([drugId])
  @@map("purchase_order_items")
}

enum ReceiptStatus {
  PENDING     // รอตรวจสอบ
  VERIFIED    // ตรวจสอบแล้ว
  APPROVED    // อนุมัติแล้ว
  REJECTED    // ปฏิเสธ
  CANCELLED   // ยกเลิก
}

model GoodsReceipt {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier      @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  
  // หมายเลขเอกสาร
  receiptNumber   String        @unique
  supplierInvoice String?       // เลขที่ใบแจ้งหนี้ของซัพพลายเออร์
  deliveryNote    String?       // เลขที่ใบส่งของ
  
  // วันที่
  receivedDate    DateTime      @default(now())
  invoiceDate     DateTime?
  
  // สถานะ
  status          ReceiptStatus @default(PENDING)
  
  // ข้อมูลการรับ
  totalItems      Int           @default(0)
  totalAmount     Decimal       @default(0)
  
  // ผู้รับผิดชอบ
  receivedBy      String
  receiver        User          @relation("GRReceiver", fields: [receivedBy], references: [id], onDelete: Restrict)
  verifiedBy      String?
  verifier        User?         @relation("GRVerifier", fields: [verifiedBy], references: [id], onDelete: SetNull)
  
  // หมายเหตุ
  notes           String?
  discrepancyNotes String?      // หมายเหตุความผิดปกติ
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  items           GoodsReceiptItem[]
  
  @@index([hospitalId, supplierId])
  @@index([receivedDate])
  @@index([status])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id              String        @id @default(uuid())
  
  // ความสัมพันธ์
  goodsReceiptId  String
  goodsReceipt    GoodsReceipt  @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  purchaseOrderItemId String?
  purchaseOrderItem PurchaseOrderItem? @relation(fields: [purchaseOrderItemId], references: [id], onDelete: SetNull)
  
  // จำนวน
  orderedQty      Int?          // จำนวนที่สั่ง (จาก PO)
  receivedQty     Int           // จำนวนที่รับจริง
  acceptedQty     Int           // จำนวนที่ยอมรับ
  rejectedQty     Int           @default(0) // จำนวนที่ปฏิเสธ
  
  // ข้อมูล batch
  batchNumber     String
  manufacturingDate DateTime?
  expiryDate      DateTime
  
  // ราคา
  unitCost        Decimal
  totalCost       Decimal
  
  // เหตุผลการปฏิเสธ
  rejectionReason String?
  
  // การตรวจสอบคุณภาพ
  qcStatus        String?       // "PENDING", "PASSED", "FAILED"
  qcNotes         String?
  
  // หมายเหตุ
  notes           String?
  
  // Audit fields
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([goodsReceiptId])
  @@index([drugId])
  @@map("goods_receipt_items")
}

model SupplierEvaluation {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  hospitalId      String
  hospital        Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  evaluatedBy     String
  evaluator       User        @relation(fields: [evaluatedBy], references: [id], onDelete: Restrict)
  
  // ระยะเวลาการประเมิน
  periodStart     DateTime
  periodEnd       DateTime
  
  // คะแนนประเมิน (1-5)
  qualityScore    Decimal     // คุณภาพสินค้า
  deliveryScore   Decimal     // การส่งมอบตรงเวลา
  serviceScore    Decimal     // คุณภาพบริการ
  priceScore      Decimal     // ความเหมาะสมของราคา
  responseScore   Decimal     // การตอบสนอง
  overallScore    Decimal     // คะแนนรวม
  
  // ความคิดเห็น
  strengths       String?     // จุดแข็ง
  weaknesses      String?     // จุดอ่อน
  recommendations String?     // ข้อเสนอแนะ
  
  // การดำเนินการ
  actionRequired  Boolean     @default(false)
  followUpDate    DateTime?
  
  // สถานะ
  status          String      @default("DRAFT") // "DRAFT", "SUBMITTED", "APPROVED"
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([supplierId])
  @@index([hospitalId])
  @@index([periodStart, periodEnd])
  @@map("supplier_evaluations")
}