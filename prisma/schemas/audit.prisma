// prisma/schemas/audit.prisma
// Audit and Compliance Management Schema (Enhanced for User Approval)
// ระบบจัดการการตรวจสอบและการปฏิบัติตามกฎระเบียบ

enum AuditAction {
  CREATE          // สร้าง
  READ            // อ่าน
  UPDATE          // แก้ไข
  DELETE          // ลบ
  LOGIN           // เข้าสู่ระบบ
  LOGOUT          // ออกจากระบบ
  APPROVE         // อนุมัติ
  REJECT          // ปฏิเสธ
  TRANSFER        // โอน
  RECEIVE         // รับ
  DISPENSE        // จ่าย
  ADJUST          // ปรับปรุง
  EXPORT          // ส่งออกข้อมูล
  IMPORT          // นำเข้าข้อมูล
  PRINT           // พิมพ์
  EMAIL           // ส่งอีเมล
  
  // User Management Actions
  USER_APPROVED   // อนุมัติผู้ใช้
  USER_REJECTED   // ปฏิเสธผู้ใช้
  USER_SUSPENDED  // ระงับผู้ใช้
  USER_ACTIVATED  // เปิดใช้ผู้ใช้
  ROLE_CHANGED    // เปลี่ยนบทบาท
  STATUS_CHANGED  // เปลี่ยนสถานะ
}

model AuditLog {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  userId          String?
  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // การดำเนินการ
  action          AuditAction
  entityType      String      // ประเภทข้อมูล (User, Drug, StockCard, etc.)
  entityId        String?     // ID ของข้อมูล
  
  // รายละเอียด
  description     String
  oldValues       Json?       // ค่าเดิม (สำหรับ UPDATE, DELETE)
  newValues       Json?       // ค่าใหม่ (สำหรับ CREATE, UPDATE)
  details         Json?       // รายละเอียดเพิ่มเติม
  
  // การติดตาม
  ipAddress       String?
  userAgent       String?
  sessionId       String?
  
  // ข้อมูลเพิ่มเติม
  severity        String      @default("INFO") // "LOW", "INFO", "WARNING", "ERROR", "CRITICAL"
  category        String?     // หมวดหมู่การตรวจสอบ
  tags            String[]    // แท็กสำหรับการจัดกลุ่ม
  
  // การเก็บรักษา
  retentionDate   DateTime?   // วันที่สามารถลบได้
  isArchived      Boolean     @default(false)
  
  // Audit fields
  timestamp       DateTime    @default(now())
  
  @@index([hospitalId, userId])
  @@index([action])
  @@index([entityType])
  @@index([timestamp])
  @@index([severity])
  @@map("audit_logs")
}

model DataAccessLog {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // การเข้าถึงข้อมูล
  resourceType    String      // ประเภทข้อมูล
  resourceId      String?     // ID ของข้อมูล
  operation       String      // การดำเนินการ (READ, SEARCH, EXPORT, etc.)
  
  // ผลลัพธ์
  success         Boolean
  errorMessage    String?
  recordCount     Int?        // จำนวนข้อมูลที่เข้าถึง
  
  // การติดตาม
  ipAddress       String?
  userAgent       String?
  requestPath     String?     // API path
  queryParams     Json?       // query parameters
  
  // การวิเคราะห์
  responseTime    Int?        // เวลาตอบสนอง (ms)
  dataSize        Int?        // ขนาดข้อมูล (bytes)
  
  // ความปลอดภัย
  riskLevel       String      @default("LOW") // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  sensitiveData   Boolean     @default(false) // มีข้อมูลที่ละเอียดอ่อนหรือไม่
  
  // Audit fields
  timestamp       DateTime    @default(now())
  
  @@index([hospitalId, userId])
  @@index([resourceType])
  @@index([timestamp])
  @@index([success])
  @@index([riskLevel])
  @@map("data_access_logs")
}

enum ComplianceType {
  REGULATORY      // กฎระเบียบของรัฐ
  INTERNAL        // นโยบายภายใน
  QUALITY         // มาตรฐานคุณภาพ
  SAFETY          // ความปลอดภัย
  FINANCIAL       // ด้านการเงิน
  PRIVACY         // ความเป็นส่วนตัว
  SECURITY        // ความปลอดภัยข้อมูล
}

enum ComplianceStatus {
  COMPLIANT       // ปฏิบัติตาม
  NON_COMPLIANT   // ไม่ปฏิบัติตาม
  PARTIAL         // ปฏิบัติตามบางส่วน
  PENDING         // รอการตรวจสอบ
  UNDER_REVIEW    // อยู่ระหว่างทบทวน
}

model ComplianceCheck {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  checkedBy       String
  checker         User            @relation("ComplianceChecker", fields: [checkedBy], references: [id], onDelete: Restrict)
  reviewedBy      String?
  reviewer        User?           @relation("ComplianceReviewer", fields: [reviewedBy], references: [id], onDelete: Restrict)
  
  // รายละเอียดการตรวจสอบ
  checkType       ComplianceType
  title           String
  description     String
  requirements    String          // ข้อกำหนดที่ต้องปฏิบัติ
  
  // ผลการตรวจสอบ
  status          ComplianceStatus
  findings        String?         // ข้อค้นพบ
  recommendations String?         // ข้อเสนอแนะ
  
  // การดำเนินการ
  actionRequired  Boolean         @default(false)
  actionPlan      String?         // แผนการดำเนินการ
  dueDate         DateTime?       // กำหนดการดำเนินการ
  completedDate   DateTime?       // วันที่ดำเนินการเสร็จ
  
  // การให้คะแนน
  riskLevel       String          @default("LOW") // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  complianceScore Decimal?        // คะแนนการปฏิบัติตาม (0-100)
  
  // การติดตาม
  nextCheckDate   DateTime?       // วันที่ตรวจสอบครั้งต่อไป
  frequency       String?         // ความถี่การตรวจสอบ
  
  // เอกสาร
  evidenceFiles   Json?           // ไฟล์หลักฐาน
  reportFile      String?         // ไฟล์รายงาน
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([hospitalId])
  @@index([checkedBy])
  @@index([checkType])
  @@index([status])
  @@index([riskLevel])
  @@map("compliance_checks")
}

enum SubstanceAction {
  RECEIVE         // รับเข้า
  DISPENSE        // จ่าย
  TRANSFER        // โอน
  RETURN          // ส่งคืน
  DISPOSE         // ทำลาย
  COUNT           // นับสต็อก
  ADJUST          // ปรับปรุง
  WASTE           // ของเสีย
}

model ControlledSubstanceLog {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  drugId          String
  drug            Drug            @relation(fields: [drugId], references: [id], onDelete: Cascade)
  
  // ผู้รับผิดชอบ
  handledBy       String
  handler         User            @relation("CSLHandler", fields: [handledBy], references: [id], onDelete: Restrict)
  witnessedBy     String?
  witness         User?           @relation("CSLWitness", fields: [witnessedBy], references: [id], onDelete: Restrict)
  authorizedBy    String?
  authorizer      User?           @relation("CSLAuthorizer", fields: [authorizedBy], references: [id], onDelete: Restrict)
  
  // การดำเนินการ
  action          SubstanceAction
  quantity        Int
  unit            String
  
  // ข้อมูล batch
  batchNumber     String?
  expiryDate      DateTime?
  
  // การอ้างอิง
  referenceType   String?         // "PRESCRIPTION", "REQUISITION", "TRANSFER", "DISPOSAL"
  referenceId     String?         // ID ของเอกสารอ้างอิง
  referenceNumber String?         // หมายเลขเอกสารอ้างอิง
  
  // สถานที่
  fromLocation    String?         // สถานที่ต้นทาง
  toLocation      String?         // สถานที่ปลายทาง
  
  // ผู้ป่วย (สำหรับการจ่ายยา)
  patientId       String?         // รหัสผู้ป่วย
  patientName     String?         // ชื่อผู้ป่วย (encrypted)
  
  // ข้อมูลเพิ่มเติม
  reason          String?         // เหตุผล
  notes           String?         // หมายเหตุ
  
  // การตรวจสอบ
  requiresWitness Boolean         @default(true)
  requiresAuth    Boolean         @default(false)
  
  // Audit fields
  timestamp       DateTime        @default(now())
  createdAt       DateTime        @default(now())
  
  @@index([hospitalId, drugId])
  @@index([handledBy])
  @@index([action])
  @@index([timestamp])
  @@map("controlled_substance_logs")
}

model InternalAudit {
  id              String      @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital    @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  auditedBy       String
  auditor         User        @relation(fields: [auditedBy], references: [id], onDelete: Restrict)
  
  // รายละเอียดการตรวจสอบ
  auditTitle      String
  auditScope      String      // ขอบเขตการตรวจสอบ
  auditPeriod     String      // ช่วงเวลาที่ตรวจสอบ
  
  // กำหนดการ
  plannedDate     DateTime    // วันที่วางแผน
  startDate       DateTime?   // วันที่เริ่มตรวจสอบ
  endDate         DateTime?   // วันที่สิ้นสุด
  
  // ผลการตรวจสอบ
  status          String      @default("PLANNED") // "PLANNED", "IN_PROGRESS", "COMPLETED", "CANCELLED"
  overallRating   String?     // "EXCELLENT", "GOOD", "SATISFACTORY", "NEEDS_IMPROVEMENT", "UNSATISFACTORY"
  
  // สรุปผล
  keyFindings     String?     // ข้อค้นพบสำคัญ
  recommendations String?     // ข้อเสนอแนะ
  actionItems     Json?       // รายการที่ต้องดำเนินการ
  
  // การติดตาม
  followUpDate    DateTime?   // วันที่ติดตามผล
  isFollowUp      Boolean     @default(false)
  parentAuditId   String?     // การตรวจสอบที่เกี่ยวข้อง
  
  // เอกสาร
  reportFile      String?     // ไฟล์รายงาน
  attachments     Json?       // ไฟล์แนบอื่นๆ
  
  // Audit fields
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([hospitalId])
  @@index([auditedBy])
  @@index([status])
  @@index([plannedDate])
  @@map("internal_audits")
}

enum IncidentType {
  SECURITY_BREACH         // การรั่วไหลของข้อมูล
  UNAUTHORIZED_ACCESS     // การเข้าถึงโดยไม่ได้รับอนุญาต
  DATA_CORRUPTION        // ข้อมูลเสียหาย
  SYSTEM_FAILURE         // ระบบล่ม
  POLICY_VIOLATION       // การละเมิดนโยบาย
  SUSPICIOUS_ACTIVITY    // กิจกรรมน่าสงสัย
  MEDICATION_ERROR       // ข้อผิดพลาดเรื่องยา
  INVENTORY_DISCREPANCY  // ความผิดปกติของสต็อก
  OTHER                  // อื่นๆ
}

enum IncidentSeverity {
  LOW                    // ต่ำ
  MEDIUM                 // ปานกลาง
  HIGH                   // สูง
  CRITICAL               // วิกฤต
}

enum IncidentStatus {
  REPORTED               // รายงานแล้ว
  UNDER_INVESTIGATION    // อยู่ระหว่างสอบสวน
  RESOLVED               // แก้ไขแล้ว
  CLOSED                 // ปิดเคส
  ESCALATED              // ขยายเรื่อง
}

model SecurityIncident {
  id              String          @id @default(uuid())
  
  // ความสัมพันธ์
  hospitalId      String
  hospital        Hospital        @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  reportedBy      String
  reporter        User            @relation("SecurityReporter", fields: [reportedBy], references: [id], onDelete: Restrict)
  suspectedUserId String?         // ผู้ต้องสงสัย
  suspectedUser   User?           @relation("SuspectedUser", fields: [suspectedUserId], references: [id], onDelete: Restrict)
  investigatedBy  String?
  investigator    User?           @relation("Investigator", fields: [investigatedBy], references: [id], onDelete: Restrict)
  
  // รายละเอียดเหตุการณ์
  incidentType    IncidentType
  severity        IncidentSeverity
  status          IncidentStatus  @default(REPORTED)
  
  // รายละเอียด
  title           String
  description     String
  affectedSystems String?         // ระบบที่ได้รับผลกระทบ
  affectedData    String?         // ข้อมูลที่ได้รับผลกระทบ
  
  // การติดตาม
  detectedAt      DateTime        // เวลาที่พบเหตุการณ์
  reportedAt      DateTime        @default(now())
  investigatedAt  DateTime?       // เวลาที่เริ่มสอบสวน
  resolvedAt      DateTime?       // เวลาที่แก้ไข
  
  // การวิเคราะห์
  rootCause       String?         // สาเหตุหลัก
  impact          String?         // ผลกระทบ
  riskAssessment  String?         // การประเมินความเสี่ยง
  
  // การดำเนินการ
  immediateActions String?        // การดำเนินการเฉพาะหน้า
  correctiveActions String?       // การดำเนินการแก้ไข
  preventiveActions String?       // การป้องกันในอนาคต
  
  // การติดตาม
  isExternal      Boolean         @default(false) // เกี่ยวข้องกับบุคคลภายนอก
  requiresReporting Boolean       @default(false) // ต้องรายงานต่อหน่วยงาน
  reportedToAuth  Boolean         @default(false) // รายงานแล้ว
  
  // เอกสาร
  evidenceFiles   Json?           // ไฟล์หลักฐาน
  reportFile      String?         // ไฟล์รายงาน
  
  // การประเมินผลกระทบ
  financialImpact Decimal?        // ผลกระทบทางการเงิน
  operationalImpact String?       // ผลกระทบต่อการดำเนินงาน
  reputationalImpact String?      // ผลกระทบต่อชื่อเสียง
  
  // การติดตามผล
  lessonsLearned  String?         // บทเรียนที่ได้รับ
  improvementsImplemented String? // การปรับปรุงที่ดำเนินการ
  
  // การอ้างอิง
  relatedIncidents Json?          // เหตุการณ์ที่เกี่ยวข้อง
  externalReferences Json?        // การอ้างอิงภายนอก
  
  // Audit fields
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([hospitalId])
  @@index([reportedBy])
  @@index([incidentType])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
  @@map("security_incidents")
}