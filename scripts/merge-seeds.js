// scripts/merge-seeds.js - Updated for Bulk Drugs Support
const fs = require('fs');
const path = require('path');

const SEEDS_DIR = path.join(__dirname, '../prisma/seeds');
const OUTPUT_FILE = path.join(__dirname, '../prisma/seed.ts');

const SEED_ORDER = {
  'hospitals.seed.ts': 0,
  'personnel-types.seed.ts': 1,
  'departments.seed.ts': 2,
  'users.seed.ts': 3,
  'master-data.seed.ts': 4,
  'real-drugs.seed.ts': 5, // à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡ seedRealDrugs à¹à¸¥à¸° seedBulkRealDrugs
  'bulk-real-drugs.seed.ts': 5, // Alternative file name
  'demo-data.seed.ts': 6,
};

function extractExportedFunction(content, filename) {
  // Extract the main export function from each seed file
  const functionMatch = content.match(/export async function (\w+)\([^)]*\)\s*\{([\s\S]*)\}/);
  
  if (!functionMatch) {
    console.warn(`âš ï¸  No exported function found in ${filename}`);
    return null;
  }

  const functionName = functionMatch[1];
  const functionBody = functionMatch[2];
  
  return {
    name: functionName,
    body: functionBody.trim(),
    imports: extractImports(content)
  };
}

function extractImports(content) {
  const imports = [];
  const importRegex = /import\s+.*?from\s+['"](.*?)['"];?\s*$/gm;
  let match;
  
  while ((match = importRegex.exec(content)) !== null) {
    const importPath = match[1];
    if (!importPath.startsWith('@prisma/client') && !importPath.startsWith('../lib/')) {
      imports.push(match[0].trim());
    }
  }
  
  return imports;
}

function mergeSeeds() {
  console.log('ðŸŒ± Hospital Pharmacy Seed Merger v2.1 - Enhanced for Bulk Drugs');
  console.log('====================================================================');
  
  if (!fs.existsSync(SEEDS_DIR)) {
    console.error(`âŒ Seeds directory not found: ${SEEDS_DIR}`);
    process.exit(1);
  }

  const seedFiles = fs.readdirSync(SEEDS_DIR)
    .filter(file => file.endsWith('.seed.ts'))
    .sort((a, b) => {
      const orderA = SEED_ORDER[a] ?? 999;
      const orderB = SEED_ORDER[b] ?? 999;
      return orderA - orderB;
    });

  if (seedFiles.length === 0) {
    console.error('âŒ No .seed.ts files found in seeds directory');
    process.exit(1);
  }

  console.log(`ðŸ“ Found ${seedFiles.length} seed files:`);
  seedFiles.forEach((file, index) => {
    const order = SEED_ORDER[file] ?? 999;
    console.log(`  ${order + 1}. ${file}`);
  });

  const extractedFunctions = [];
  const allImports = new Set();

  // Extract functions from each seed file
  for (const file of seedFiles) {
    const filePath = path.join(SEEDS_DIR, file);
    const content = fs.readFileSync(filePath, 'utf8');
    
    console.log(`ðŸ“– Processing ${file}...`);
    
    const extracted = extractExportedFunction(content, file);
    if (extracted) {
      extractedFunctions.push(extracted);
      extracted.imports.forEach(imp => allImports.add(imp));
      console.log(`  âœ… Extracted function: ${extracted.name}`);
    }
  }

  // Generate merged seed file
  const mergedContent = generateMergedSeed(extractedFunctions, Array.from(allImports));
  
  // Write merged file
  fs.writeFileSync(OUTPUT_FILE, mergedContent, 'utf8');
  
  console.log(`\nâœ… Successfully merged ${extractedFunctions.length} seed functions into: ${OUTPUT_FILE}`);
  console.log(`ðŸ“¦ Generated modular seed file with:`);
  console.log(`   - Main orchestrator function`);
  console.log(`   - ${extractedFunctions.length} imported seed functions`);
  console.log(`   - Proper error handling`);
  console.log(`   - Phase-based execution`);
  console.log(`   - Bulk drug processing support`);
  
  console.log(`\nðŸ“ Usage:`);
  console.log(`   pnpm db:seed              # Run all seeds`);
  console.log(`   SEED_DEMO_DATA=true pnpm db:seed  # Include demo data`);
}

function generateMergedSeed(functions, imports) {
  const importStatements = [
    `// prisma/seed.ts - Auto-generated Modular Seed File`,
    `// Generated by scripts/merge-seeds.js`,
    `// Do not edit manually - modify individual seed files instead`,
    ``,
    `import { PrismaClient } from "@prisma/client";`,
    `import { hashPassword } from "../lib/password-utils";`,
    ``
  ];

  // Add function imports
  const functionImports = functions.map(f => `import { ${f.name} } from "./seeds/${getFileNameFromFunction(f.name)}";`);
  importStatements.push(...functionImports);
  importStatements.push('');

  // Detect if we have bulk drugs function
  const hasBulkDrugs = functions.some(f => f.name === 'seedBulkRealDrugs');
  const hasRegularDrugs = functions.some(f => f.name === 'seedRealDrugs');
  
  // Choose the appropriate drug seeding function
  const drugSeedFunction = hasBulkDrugs ? 'seedBulkRealDrugs' : 'seedRealDrugs';
  const drugSeedDescription = hasBulkDrugs ? 'bulk real drug data' : 'real drug data';

  const mainFunction = `const prisma = new PrismaClient();

async function main() {
  console.log("ðŸŒ± Starting Enhanced Hospital Pharmacy Stock Management System Seed...");
  console.log("ðŸŽ¯ Using Modular Seed Architecture with Neon + Prisma");
  ${hasBulkDrugs ? 'console.log("âš¡ Enhanced with Bulk Drug Processing Support");' : ''}

  try {
    // ================================
    // PHASE 1: FOUNDATION
    // ================================
    console.log("\\nðŸ—ï¸  PHASE 1: Foundation Setup");
    
    // 1. Create hospitals first
    const hospitals = await seedHospitals(prisma, null);
    console.log(\`âœ… Created \${hospitals.length} hospitals\`);

    // 2. Create system developer with first hospital
    console.log("ðŸ‘¤ Creating system developer user...");
    const hashedDevPassword = await hashPassword("dev123");
    const devUser = await prisma.user.upsert({
      where: { email: "dev@system.local" },
      update: {},
      create: {
        email: "dev@system.local",
        username: "developer",
        name: "System Developer",
        firstName: "System",
        lastName: "Developer", 
        phoneNumber: "0800000000",
        employeeId: "DEV001",
        position: "System Developer",
        role: "DEVELOPER",
        status: "ACTIVE",
        hospitalId: hospitals[0].id, // Use first hospital
        personnelTypeId: undefined, // Will be updated after personnel type creation
        isProfileComplete: true,
        emailVerified: true,
        password: hashedDevPassword,
      },
    });
    console.log("âœ… System developer created");

    // ================================
    // PHASE 2: ORGANIZATIONAL STRUCTURE
    // ================================
    console.log("\\nðŸ¢ PHASE 2: Organizational Structure");
    
    // 3. Create personnel types for all hospitals
    const personnelTypes = await seedPersonnelTypes(prisma, hospitals, devUser);
    console.log(\`âœ… Created personnel types for all hospitals\`);

    // Update dev user with developer personnel type
    const devPersonnelType = personnelTypes[hospitals[0].id].find(pt => pt.typeCode === "DEV");
    await prisma.user.update({
      where: { id: devUser.id },
      data: { personnelTypeId: devPersonnelType?.id }
    });

    // 4. Create departments for all hospitals
    const departments = await seedDepartments(prisma, hospitals);
    console.log(\`âœ… Created departments for all hospitals\`);

    // ================================
    // PHASE 3: PERSONNEL
    // ================================
    console.log("\\nðŸ‘¥ PHASE 3: Personnel Management");
    
    // 5. Create diverse users with proper role assignments
    const users = await seedUsers(prisma, hospitals, departments, personnelTypes);
    console.log(\`âœ… Created \${users.length} users with role assignments\`);

    // ================================
    // PHASE 4: MASTER DATA
    // ================================
    console.log("\\nðŸ’Š PHASE 4: Master Data Setup");
    
    // 6. Create master data (drug forms, groups, types, etc.)
    const masterData = await seedMasterData(prisma, hospitals, devUser);
    console.log(\`âœ… Created master data for all hospitals\`);

    // ================================
    // PHASE 5: DRUG DATA
    // ================================
    console.log("\\nðŸ’Š PHASE 5: Drug Data Processing");
    ${hasBulkDrugs ? 'console.log("âš¡ Using optimized bulk processing for large datasets");' : ''}
    
    // Create drug data for Hospital 1
    const drugResult = await ${drugSeedFunction}(prisma, hospitals, masterData);
    ${hasBulkDrugs ? `
    console.log(\`âœ… Bulk drug processing completed\`);
    if (drugResult && typeof drugResult === 'object' && drugResult.totalProcessed) {
      console.log(\`ðŸ“Š Processed \${drugResult.totalProcessed} drugs\`);
      console.log(\`ðŸ’° Total value: \${drugResult.totalValue ? drugResult.totalValue.toLocaleString() : 'N/A'} à¸šà¸²à¸—\`);
    } else {
      console.log(\`ðŸ“Š Bulk processing completed successfully\`);
    }
    ` : `
    console.log(\`âœ… Created \${Array.isArray(drugResult) ? drugResult.length : 'N/A'} real drugs for à¹‚à¸£à¸‡à¸žà¸¢à¸²à¸šà¸²à¸¥à¸¥à¸³à¸›à¸²à¸‡\`);
    `}

    // ================================
    // PHASE 6: DEMO DATA (Optional)
    // ================================
    console.log("\\nðŸŽ® PHASE 6: Demo Data (Optional)");
    
    if (process.env.SEED_DEMO_DATA === "true") {
      const demoData = await seedDemoData(prisma, hospitals, users, masterData);
      console.log(\`âœ… Created demo data for testing\`);
    } else {
      console.log("â­ï¸  Skipping demo data (set SEED_DEMO_DATA=true to include)");
    }

    // ================================
    // COMPLETION SUMMARY
    // ================================
    console.log("\\nðŸŽ‰ Enhanced Hospital Pharmacy Seed Completed Successfully!");
    console.log("\\nðŸ“Š Summary:");
    console.log(\`ðŸ¥ Hospitals: \${hospitals.length}\`);
    console.log(\`ðŸ‘¥ Personnel Types: \${Object.values(personnelTypes).flat().length}\`);
    console.log(\`ðŸ¢ Departments: \${Object.values(departments).flat().length}\`);
    console.log(\`ðŸ‘¤ Users: \${users.length + 1} (including dev user)\`);
    console.log(\`ðŸ’Š Master Data Categories: \${Object.keys(masterData).length}\`);
    ${hasBulkDrugs ? `
    if (drugResult && typeof drugResult === 'object' && drugResult.totalProcessed) {
      console.log(\`ðŸ¥ Bulk Drugs Processed: \${drugResult.totalProcessed}\`);
      console.log(\`ðŸ’° Total Drug Value: \${drugResult.totalValue ? drugResult.totalValue.toLocaleString() : 'N/A'} à¸šà¸²à¸—\`);
      if (drugResult.categoriesCount) {
        console.log(\`ðŸ“‹ Drug Categories:\`);
        Object.entries(drugResult.categoriesCount).forEach(([category, count]) => {
          console.log(\`   - \${category}: \${count} drugs\`);
        });
      }
    } else {
      console.log(\`ðŸ¥ Bulk Drugs: Processing completed\`);
    }
    ` : `
    console.log(\`ðŸ¥ Real Drugs (à¹‚à¸£à¸‡à¸žà¸¢à¸²à¸šà¸²à¸¥à¸¥à¸³à¸›à¸²à¸‡): \${Array.isArray(drugResult) ? drugResult.length : 'N/A'}\`);
    `}
    
    console.log("\\nðŸ”‘ System Access:");
    console.log("ðŸ”§ DEVELOPER: dev@system.local / dev123");
    console.log("ðŸ‘¨â€ðŸ’¼ DIRECTORS: director@[hospital].go.th / director123");
    console.log("âš•ï¸  PHARMACY: pharm@[hospital].go.th / pharm123");
    console.log("ðŸ‘©â€âš•ï¸ NURSING: nurse@[hospital].go.th / nurse123");
    
    console.log("\\nðŸ“ Next Steps:");
    console.log("1. Run: pnpm dev");
    console.log("2. Login as dev@system.local / dev123");
    console.log("3. Test multi-tenant isolation");
    console.log("4. Verify role-based permissions");
    console.log("5. Check drug inventory and stock management");
    ${hasBulkDrugs ? 'console.log("6. Verify bulk drug processing performance");' : ''}

  } catch (error) {
    console.error("âŒ Seed error:", error);
    throw error;
  }
}

main()
  .then(async () => {
    await prisma.$disconnect();
    console.log("âœ… Database connection closed successfully");
  })
  .catch(async (e) => {
    console.error("âŒ Fatal seed error:", e);
    await prisma.$disconnect();
    process.exit(1);
  });

export { prisma };`;

  return [...importStatements, mainFunction].join('\n');
}

function getFileNameFromFunction(functionName) {
  const mapping = {
    'seedHospitals': 'hospitals.seed',
    'seedPersonnelTypes': 'personnel-types.seed',
    'seedDepartments': 'departments.seed',
    'seedUsers': 'users.seed',
    'seedMasterData': 'master-data.seed',
    'seedRealDrugs': 'real-drugs.seed',
    'seedBulkRealDrugs': 'real-drugs.seed', // Map to same file
    'seedDemoData': 'demo-data.seed'
  };
  
  return mapping[functionName] || `${functionName.toLowerCase()}.seed`;
}

function validateMerge() {
  console.log('ðŸ” Validating merged seed file...');
  
  if (!fs.existsSync(OUTPUT_FILE)) {
    console.error('âŒ Merged seed file not found');
    return false;
  }
  
  const content = fs.readFileSync(OUTPUT_FILE, 'utf8');
  
  // Check for required imports
  const requiredImports = ['PrismaClient', 'hashPassword'];
  const missingImports = requiredImports.filter(imp => !content.includes(imp));
  
  if (missingImports.length > 0) {
    console.error(`âŒ Missing required imports: ${missingImports.join(', ')}`);
    return false;
  }
  
  // Check for required function calls (flexible for both regular and bulk)
  const requiredBaseFunctions = ['seedHospitals', 'seedPersonnelTypes', 'seedDepartments', 'seedUsers', 'seedMasterData'];
  const drugFunctions = ['seedRealDrugs', 'seedBulkRealDrugs'];
  
  const missingBaseFunctions = requiredBaseFunctions.filter(func => !content.includes(`await ${func}(`));
  const hasDrugFunction = drugFunctions.some(func => content.includes(`await ${func}(`));
  
  if (missingBaseFunctions.length > 0) {
    console.error(`âŒ Missing required function calls: ${missingBaseFunctions.join(', ')}`);
    return false;
  }
  
  if (!hasDrugFunction) {
    console.error(`âŒ Missing drug seeding function (either seedRealDrugs or seedBulkRealDrugs)`);
    return false;
  }
  
  console.log('âœ… Merged seed file validation passed');
  
  // Log which drug function is being used
  if (content.includes('seedBulkRealDrugs')) {
    console.log('ðŸš€ Using bulk drug processing with smart defaults');
  } else {
    console.log('ðŸ“¦ Using regular drug processing function');
  }
  
  return true;
}

function showUsage() {
  console.log(`
ðŸŒ± Hospital Pharmacy Seed Merger v2.1 - Enhanced for Bulk Drugs

Usage:
  node scripts/merge-seeds.js [--check-only]

Options:
  --check-only    Only validate merged file without merging
  --help, -h      Show this help message

This script merges all .seed.ts files from prisma/seeds/ into prisma/seed.ts

ðŸŽ¯ Enhanced Features:
- âœ… Separate seed files for different concerns
- âœ… Automatic function extraction and imports  
- âœ… Phase-based execution order
- âœ… Hospital context management
- âœ… Personnel type hierarchy
- âœ… Master data initialization
- âœ… Optional demo data seeding
- ðŸš€ Bulk drug processing support (400+ drugs)
- âš¡ Smart detection of drug seeding functions
- ðŸ› ï¸ Smart defaults for missing CSV data

ðŸ“ Seed files are processed in this order:
${Object.entries(SEED_ORDER)
  .sort(([, a], [, b]) => a - b)
  .map(([file, order]) => `  ${order + 1}. ${file}`)
  .join('\n')}

ðŸ”§ Supported Drug Seeding Functions:
  - seedRealDrugs: Regular drug processing (< 100 drugs)
  - seedBulkRealDrugs: Optimized bulk processing (400+ drugs)
    âœ¨ Auto-fixes missing data (strength, unit, prices)
    âœ¨ Handles malformed CSV (commas in numbers, wrong dates)
    âœ¨ Smart defaults based on dosage forms

After merging, run:
  pnpm db:seed                    # Run basic seed
  SEED_DEMO_DATA=true pnpm db:seed # Run with demo data
  pnpm db:reset && pnpm db:seed   # Full reset and seed
`);
}

// Main execution
if (require.main === module) {
  const args = process.argv.slice(2);
  
  if (args.includes('--help') || args.includes('-h')) {
    showUsage();
    process.exit(0);
  }
  
  if (args.includes('--check-only')) {
    console.log('ðŸ” Running validation only...');
    if (validateMerge()) {
      console.log('âœ… Validation passed');
      process.exit(0);
    } else {
      console.error('âŒ Validation failed');
      process.exit(1);
    }
  }
  
  try {
    mergeSeeds();
    
    if (validateMerge()) {
      console.log(`
ðŸŽ‰ Hospital Pharmacy Seed merge completed successfully!

ðŸŽ¯ Enhanced Modular Seed Structure:
  - hospitals.seed.ts (Hospital creation)
  - personnel-types.seed.ts (Role hierarchy)
  - departments.seed.ts (Organizational structure)  
  - users.seed.ts (User accounts)
  - master-data.seed.ts (Drug forms, groups, etc.)
  - real-drugs.seed.ts (Drug data - regular or bulk processing)
  - demo-data.seed.ts (Sample data for testing)

ðŸš€ Enhanced Features:
  âœ… Automatic detection of bulk vs regular drug processing
  âœ… Optimized for 400+ drug datasets with smart CSV handling
  âœ… Batch processing with transaction safety
  âœ… Progress tracking and error handling
  âœ… Comprehensive statistics reporting
  âœ… Smart data fixing for malformed CSV files
  âœ… Auto-generation of missing required fields

ðŸ“‹ Next Steps:
  1. Run: pnpm db:seed
  2. Test with: dev@system.local / dev123
  3. Check drug inventory (10+ or 400+ drugs)
  4. Verify multi-tenant isolation
  5. Check role-based permissions
  6. Test bulk processing performance
`);
    } else {
      console.error('âŒ Merge completed but validation failed');
      process.exit(1);
    }
  } catch (error) {
    console.error('âŒ Merge failed:', error.message);
    process.exit(1);
  }
}

module.exports = { mergeSeeds, validateMerge };